<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <title>Commodity Research: Steps 1-2 | Hauselmann's History Lab</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f0;
            color: #333;
            line-height: 1.6;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
        }

        header p {
            margin: 0;
            font-size: 1.1em;
            opacity: 0.9;
        }

        nav {
            background-color: #34495e;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }

        nav a:hover {
            text-decoration: underline;
        }

        .breadcrumb {
            background-color: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .progress-bar {
            background-color: #ecf0f1;
            height: 10px;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #27ae60;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 5px;
        }

        .section {
            background-color: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .info-box {
            background-color: #e8f4f8;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
            border-radius: 3px;
        }

        .info-box strong {
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .form-group select,
        .form-group textarea,
        .form-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 1em;
            font-family: 'Open Sans', sans-serif;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group textarea:focus,
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group textarea.short-answer {
            min-height: 80px;
        }

        .help-text {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .sub-question {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-family: 'Open Sans', sans-serif;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-secondary {
            background-color: #34495e;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2c3e50;
        }

        .alert {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #27ae60;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #e74c3c;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: #7f8c8d;
            padding: 20px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                padding: 20px;
            }

            .section {
                padding: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                text-align: center;
            }

        }
    </style>
</head>
<body>
    <header>
        <h1>üì¶ Commodity Research Worksheet</h1>
        <p>Steps 1-2: Understanding the Big Question & Defining the Commodity</p>
    </header>

    <nav>
        <a href="index.html">Home</a>
        <a href="activities.html">Interactive Activities</a>
        <a href="research.html">Research Tools</a>
        <a href="archives.html">Student Archives</a>
        <a href="blog.html">Blog</a>
    </nav>

    <div class="breadcrumb">
        <a href="research-hist107.html">‚Üê Back to HIST 107 Research Guide</a>
        <a href="research.html">‚Üê Back to Research Tools</a>
    </div>

    <div class="section" style="background-color: #f0f9ff; border-left: 4px solid #3498db;">
        <h2 style="border-bottom-color: #3498db;">Student Information</h2>
        <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="First and last name">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="section-number">Section Number:</label>
                <input type="text" id="section-number" placeholder="e.g., 107-01">
            </div>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="section">
        <h2>Instructions</h2>
        <p>For each step below, read the prompts carefully and answer the questions in complete sentences. When you are finished, save your work and download a PDF to submit.</p>
        <div class="info-box">
            <strong>IMPORTANT NOTE:</strong> The "Save Final Work" button saves your answers in your browser. It does not turn anything in automatically. After clicking it, you must download the PDF and print the file to bring to class.
        </div>
        <p><em>Tip: Aim for specific, detailed answers that demonstrate your understanding of the commodity's historical significance.</em></p>
    </div>

    <div id="status-message"></div>

    <div class="section">
        <h2>STEP 1: Understanding the Big Question</h2>

        <div class="info-box">
            <strong>Central Historical Question:</strong> How did this raw material become a global commodity, and what does that process reveal about capitalism, empire, and globalization?
        </div>

        <div class="form-group">
            <label for="question-interpretation">In your own words, what is this question asking you to investigate?</label>
            <textarea id="question-interpretation" placeholder="Break down the question. What are the key terms? What historical processes are you being asked to trace?"></textarea>
        </div>

        <div class="form-group">
            <label for="key-terms">What do you understand by "capitalism," "empire," and "globalization" in the context of this project?</label>
            <textarea id="key-terms" placeholder="Capitalism: ...&#10;&#10;Empire: ...&#10;&#10;Globalization: ..."></textarea>
            <div class="help-text">Define each term briefly as it relates to commodities and trade.</div>
        </div>
    </div>

    <div class="section">
        <h2>STEP 2: Defining the Commodity & Its Early History</h2>

        <div class="form-group">
            <label for="commodity-name">Your Commodity:</label>
            <select id="commodity-name">
                <option value="">-- Select your commodity --</option>
                <option value="Sugar">Sugar</option>
                <option value="Coffee">Coffee</option>
                <option value="Rubber">Rubber</option>
                <option value="Chili Peppers">Chili Peppers</option>
                <option value="Chocolate">Chocolate</option>
                <option value="Oil">Oil</option>
                <option value="Bananas">Bananas</option>
                <option value="Tomatoes">Tomatoes</option>
                <option value="Cocoa">Cocoa</option>
                <option value="Silver">Silver</option>
                <option value="Indigo">Indigo</option>
                <option value="Tea">Tea</option>
                <option value="Palm Oil">Palm Oil</option>
                <option value="Cannabis">Cannabis</option>
                <option value="Tobacco">Tobacco</option>
                <option value="Opium">Opium</option>
                <option value="Other">Other (specify below)</option>
            </select>
        </div>

        <div class="form-group" id="other-commodity-group" style="display: none;">
            <label for="commodity-other">Specify your commodity:</label>
            <input type="text" id="commodity-other" placeholder="Enter your approved commodity">
        </div>

        <div class="form-group">
            <label for="commodity-overview">Commodity Overview</label>
            <textarea id="commodity-overview" placeholder="What is this commodity? Where does it come from? Why did it become valuable?"></textarea>
            <div class="help-text">Describe what it is, how it's produced, and why it mattered historically.</div>
        </div>

        <div class="info-box">
            <strong>Pre-Imperial Context:</strong> Before large-scale imperial involvement, how was this commodity produced and traded?
        </div>

        <div class="sub-question">
            <div class="form-group">
                <label for="pre-imperial-production">Where was this commodity originally produced?</label>
                <textarea id="pre-imperial-production" class="short-answer" placeholder="Identify the region(s) and describe the environment or conditions needed for production..."></textarea>
            </div>
        </div>

        <div class="sub-question">
            <div class="form-group">
                <label for="pre-imperial-control">Who controlled production and exchange before imperial expansion?</label>
                <textarea id="pre-imperial-control" class="short-answer" placeholder="Local communities, merchants, kingdoms, guilds..."></textarea>
            </div>
        </div>

        <div class="sub-question">
            <div class="form-group">
                <label for="pre-imperial-trade">Was trade local, regional, or global? Describe the trade networks.</label>
                <textarea id="pre-imperial-trade" class="short-answer" placeholder="Describe the scale and reach of early trade..."></textarea>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="button-group">
            <button class="btn btn-success" onclick="saveWork()">üíæ Save Final Work</button>
            <button class="btn btn-secondary" onclick="exportWork()">üìÑ Export as PDF</button>
            <button class="btn btn-secondary" onclick="exportText()">üìÑ Export as Text File</button>
            <button class="btn btn-primary" onclick="submitToSupabase()" id="submitBtn">üì§ Submit to Professor</button>
        </div>
        <div id="submitMessage"></div>
    </div>

    <footer>
        <p>Prof. Hauselmann | profhauselmann.org</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://bqrluqymscucvbiaaeai.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcmx1cXltc2N1Y3ZiaWFhZWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY4MTM2NzYsImV4cCI6MjA1MjM4OTY3Nn0.KFQV8a5XKy1aq0pFHCF_XYLBGwDmBJNp8OpFJIrMu1w'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

        // Submission cutoff date - set to null for no deadline, or use format: 'YYYY-MM-DDTHH:MM:SS'
        // Example: '2026-03-15T23:59:59' for March 15, 2026 at 11:59 PM
        const SUBMISSION_CUTOFF = null

        let currentUser = null

        async function checkAuth() {
            const userStr = localStorage.getItem('student_user')
            if (userStr) {
                currentUser = JSON.parse(userStr)
            }

            document.getElementById('commodity-name').addEventListener('change', function() {
                const otherGroup = document.getElementById('other-commodity-group')
                if (this.value === 'Other') {
                    otherGroup.style.display = 'block'
                } else {
                    otherGroup.style.display = 'none'
                }
                updateProgress()
            })

            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('input', updateProgress)
                element.addEventListener('change', updateProgress)
            })

            await loadWork()
            updateProgress()
        }

        function updateProgress() {
            const total = 7
            let completed = 0

            if (document.getElementById('question-interpretation').value.length > 10) completed++
            if (document.getElementById('key-terms').value.length > 10) completed++

            const selectedCommodity = document.getElementById('commodity-name').value
            const otherCommodity = document.getElementById('commodity-other').value
            if (selectedCommodity && (selectedCommodity !== 'Other' || otherCommodity.trim().length > 0)) completed++

            if (document.getElementById('commodity-overview').value.length > 10) completed++
            if (document.getElementById('pre-imperial-production').value.length > 10) completed++
            if (document.getElementById('pre-imperial-control').value.length > 10) completed++
            if (document.getElementById('pre-imperial-trade').value.length > 10) completed++

            const percentage = (completed / total) * 100
            document.getElementById('progressFill').style.width = percentage + '%'
        }

        async function saveWork(silent = false) {
            const commodityName = document.getElementById('commodity-name').value === 'Other'
                ? document.getElementById('commodity-other').value
                : document.getElementById('commodity-name').value

            const data = {
                student_name: document.getElementById('student-name').value,
                section_number: document.getElementById('section-number').value,
                question_interpretation: document.getElementById('question-interpretation').value,
                key_terms: document.getElementById('key-terms').value,
                commodity_name: commodityName,
                commodity_name_selection: document.getElementById('commodity-name').value,
                commodity_other: document.getElementById('commodity-other').value,
                commodity_overview: document.getElementById('commodity-overview').value,
                pre_imperial_production: document.getElementById('pre-imperial-production').value,
                pre_imperial_control: document.getElementById('pre-imperial-control').value,
                pre_imperial_trade: document.getElementById('pre-imperial-trade').value
            }

            if (!currentUser) {
                localStorage.setItem('hist107_commodity_research', JSON.stringify(data))
                if (!silent) {
                    showMessage('‚úÖ Progress saved locally in this browser.', 'success')
                }
                return
            }

            const { error } = await supabaseClient
                .from('hist107_commodity_research')
                .upsert({ ...data, user_id: currentUser.id }, { onConflict: 'user_id' })

            if (!silent) {
                if (error) {
                    showMessage('Error saving: ' + error.message, 'error')
                } else {
                    showMessage('‚úÖ Progress saved successfully!', 'success')
                }
            }
        }

        async function loadWork() {
            if (!currentUser) {
                const saved = localStorage.getItem('hist107_commodity_research')
                if (!saved) return
                const data = JSON.parse(saved)

                document.getElementById('student-name').value = data.student_name || ''
                document.getElementById('section-number').value = data.section_number || ''
                document.getElementById('question-interpretation').value = data.question_interpretation || ''
                document.getElementById('key-terms').value = data.key_terms || ''
                document.getElementById('commodity-name').value = data.commodity_name_selection || ''
                document.getElementById('commodity-other').value = data.commodity_other || ''
                document.getElementById('commodity-overview').value = data.commodity_overview || ''
                document.getElementById('pre-imperial-production').value = data.pre_imperial_production || ''
                document.getElementById('pre-imperial-control').value = data.pre_imperial_control || ''
                document.getElementById('pre-imperial-trade').value = data.pre_imperial_trade || ''

                if (data.commodity_name_selection === 'Other') {
                    document.getElementById('other-commodity-group').style.display = 'block'
                }
                return
            }

            const { data, error } = await supabaseClient
                .from('hist107_commodity_research')
                .select('*')
                .eq('user_id', currentUser.id)
                .single()

            if (error || !data) return

            document.getElementById('student-name').value = data.student_name || ''
            document.getElementById('section-number').value = data.section_number || ''
            document.getElementById('question-interpretation').value = data.question_interpretation || ''
            document.getElementById('key-terms').value = data.key_terms || ''
            document.getElementById('commodity-name').value = data.commodity_name_selection || ''
            document.getElementById('commodity-other').value = data.commodity_other || ''
            document.getElementById('commodity-overview').value = data.commodity_overview || ''
            document.getElementById('pre-imperial-production').value = data.pre_imperial_production || ''
            document.getElementById('pre-imperial-control').value = data.pre_imperial_control || ''
            document.getElementById('pre-imperial-trade').value = data.pre_imperial_trade || ''

            if (data.commodity_name_selection === 'Other') {
                document.getElementById('other-commodity-group').style.display = 'block'
            }
        }

        function exportWork() {
            const commodityName = document.getElementById('commodity-name').value === 'Other'
                ? document.getElementById('commodity-other').value
                : document.getElementById('commodity-name').value
            const { jsPDF } = window.jspdf
            const doc = new jsPDF()

            const lineHeight = 7
            const pageWidth = 190
            const pageHeight = 280  // Safe area before bottom margin
            let y = 20

            // Helper function to check page overflow and add new page if needed
            function checkPageOverflow(neededSpace) {
                if (y + neededSpace > pageHeight) {
                    doc.addPage()
                    y = 20
                }
            }

            function addWrappedText(text, x, maxWidth) {
                const lines = doc.splitTextToSize(text, maxWidth)
                lines.forEach((line) => {
                    if (y + lineHeight > pageHeight) {
                        doc.addPage()
                        y = 20
                    }
                    doc.text(line, x, y)
                    y += lineHeight
                })
            }

            doc.setFontSize(16)
            doc.setFont(undefined, 'bold')
            doc.text('HIST 107 Commodity Research Worksheet', 105, y, { align: 'center' })
            y += 10

            doc.setFontSize(12)
            doc.setFont(undefined, 'normal')
            doc.text('Steps 1-2: Understanding the Question & Defining the Commodity', 105, y, { align: 'center' })
            y += 15

            doc.setFontSize(10)
            const studentName = document.getElementById('student-name').value
            const sectionNumber = document.getElementById('section-number').value
            if (studentName) {
                doc.text(`Student: ${studentName}`, 20, y)
                y += 8
            }
            if (sectionNumber) {
                doc.text(`Section: ${sectionNumber}`, 20, y)
                y += 8
            }
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y)
            y += 12

            checkPageOverflow(20)
            doc.setFontSize(14)
            doc.setFont(undefined, 'bold')
            doc.text('STEP 1: Understanding the Big Question', 20, y)
            y += 10

            doc.setFontSize(10)
            doc.setFont(undefined, 'normal')
            doc.text('Central Question:', 20, y)
            y += 7
            addWrappedText(
                'How did this raw material become a global commodity, and what does that process reveal about capitalism, empire, and globalization?',
                25,
                pageWidth - 25
            )
            y += 8

            checkPageOverflow(15)
            doc.text('My Interpretation:', 20, y)
            y += 7
            addWrappedText(
                document.getElementById('question-interpretation').value || '[Not answered]',
                25,
                pageWidth - 25
            )
            y += 8

            checkPageOverflow(15)
            doc.text('Key Terms (Capitalism, Empire, Globalization):', 20, y)
            y += 7
            addWrappedText(
                document.getElementById('key-terms').value || '[Not answered]',
                25,
                pageWidth - 25
            )
            y += 12

            checkPageOverflow(20)
            doc.setFontSize(14)
            doc.setFont(undefined, 'bold')
            doc.text('STEP 2: Defining the Commodity & Its Early History', 20, y)
            y += 10

            doc.setFontSize(10)
            doc.setFont(undefined, 'normal')
            doc.text(`Commodity: ${commodityName || '[Not selected]'}`, 20, y)
            y += 10

            checkPageOverflow(15)
            doc.text('Overview:', 20, y)
            y += 7
            addWrappedText(
                document.getElementById('commodity-overview').value || '[Not answered]',
                25,
                pageWidth - 25
            )
            y += 8

            checkPageOverflow(15)
            doc.text('Pre-Imperial Context:', 20, y)
            y += 7

            checkPageOverflow(15)
            doc.text('Production Location:', 25, y)
            y += 7
            addWrappedText(
                document.getElementById('pre-imperial-production').value || '[Not answered]',
                30,
                pageWidth - 30
            )
            y += 6

            checkPageOverflow(15)
            doc.text('Control of Production/Exchange:', 25, y)
            y += 7
            addWrappedText(
                document.getElementById('pre-imperial-control').value || '[Not answered]',
                30,
                pageWidth - 30
            )
            y += 6

            checkPageOverflow(15)
            doc.text('Scale of Trade:', 25, y)
            y += 7
            addWrappedText(
                document.getElementById('pre-imperial-trade').value || '[Not answered]',
                30,
                pageWidth - 30
            )

            doc.save(`Commodity_Research_Steps1-2_${commodityName || 'draft'}_${new Date().toISOString().split('T')[0]}.pdf`)

            showMessage('Exported successfully!', 'success')
        }

        function exportText() {
            const commodityName = document.getElementById('commodity-name').value === 'Other'
                ? document.getElementById('commodity-other').value
                : document.getElementById('commodity-name').value

            let text = 'HIST 107 Commodity Research Worksheet\n'
            text += 'Steps 1-2: Understanding the Question & Defining the Commodity\n'
            text += '='.repeat(60) + '\n\n'
            text += `Student Name: ${document.getElementById('student-name').value}\n`
            text += `Section Number: ${document.getElementById('section-number').value}\n`
            text += `Date: ${new Date().toLocaleDateString()}\n\n`

            text += 'STEP 1: Understanding the Big Question\n'
            text += '-'.repeat(40) + '\n\n'
            text += 'Central Question:\n'
            text += 'How did this raw material become a global commodity, and what does that process reveal about capitalism, empire, and globalization?\n\n'
            text += 'My Interpretation:\n'
            text += (document.getElementById('question-interpretation').value || '[Not answered]') + '\n\n'
            text += 'Key Terms (Capitalism, Empire, Globalization):\n'
            text += (document.getElementById('key-terms').value || '[Not answered]') + '\n\n'

            text += 'STEP 2: Defining the Commodity & Its Early History\n'
            text += '-'.repeat(40) + '\n\n'
            text += `Commodity: ${commodityName || '[Not selected]'}\n\n`
            text += 'Overview:\n'
            text += (document.getElementById('commodity-overview').value || '[Not answered]') + '\n\n'
            text += 'Pre-Imperial Context:\n\n'
            text += 'Production Location:\n'
            text += (document.getElementById('pre-imperial-production').value || '[Not answered]') + '\n\n'
            text += 'Control of Production/Exchange:\n'
            text += (document.getElementById('pre-imperial-control').value || '[Not answered]') + '\n\n'
            text += 'Scale of Trade:\n'
            text += (document.getElementById('pre-imperial-trade').value || '[Not answered]') + '\n'

            const blob = new Blob([text], { type: 'text/plain' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `Commodity_Research_Steps1-2_${commodityName || 'draft'}_${new Date().toISOString().split('T')[0]}.txt`
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
            URL.revokeObjectURL(url)

            showMessage('Text file exported successfully!', 'success')
        }

        function showMessage(message, type) {
            const msgDiv = document.getElementById('status-message')
            msgDiv.innerHTML = type === 'success'
                ? `<div class="alert alert-success">${message}</div>`
                : `<div class="alert alert-error">${message}</div>`
        }

        async function submitToSupabase() {
            // Check if submission deadline has passed
            if (SUBMISSION_CUTOFF) {
                const cutoffDate = new Date(SUBMISSION_CUTOFF)
                const now = new Date()
                if (now > cutoffDate) {
                    alert('The submission deadline has passed. Please contact your professor if you need an extension.')
                    return
                }
            }

            const studentName = document.getElementById('student-name').value.trim();
            const sectionNumber = document.getElementById('section-number').value.trim();

            if (!studentName) {
                alert('Please enter your name before submitting.');
                document.getElementById('student-name').focus();
                return;
            }

            if (!sectionNumber) {
                alert('Please enter your section number before submitting.');
                document.getElementById('section-number').focus();
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const messageDiv = document.getElementById('submitMessage');

            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting...';
            messageDiv.innerHTML = '<div class="alert" style="background-color: #fff3cd; color: #856404; border-left: 4px solid #ffc107;">Generating and uploading your PDF...</div>';

            try {
                const pdfBlob = await generatePDFBlob();

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const sanitizedName = studentName.replace(/[^a-zA-Z0-9]/g, '_');
                const commodityName = document.getElementById('commodity-name').value === 'Other'
                    ? document.getElementById('commodity-other').value
                    : document.getElementById('commodity-name').value;
                const sanitizedCommodity = commodityName.replace(/[^a-zA-Z0-9]/g, '_') || 'commodity';
                const fileName = `hist107-commodity-steps1-2/${sectionNumber}/${sanitizedName}_${sanitizedCommodity}_${timestamp}.pdf`;

                const { data: uploadData, error: uploadError } = await supabaseClient
                    .storage
                    .from('student-submissions')
                    .upload(fileName, pdfBlob, {
                        contentType: 'application/pdf',
                        upsert: false
                    });

                if (uploadError) {
                    throw new Error(`Upload failed: ${uploadError.message}`);
                }

                const { data: urlData } = supabaseClient
                    .storage
                    .from('student-submissions')
                    .getPublicUrl(fileName);

                const formData = {
                    question_interpretation: document.getElementById('question-interpretation').value,
                    key_terms: document.getElementById('key-terms').value,
                    commodity_name: commodityName,
                    commodity_overview: document.getElementById('commodity-overview').value,
                    pre_imperial_production: document.getElementById('pre-imperial-production').value,
                    pre_imperial_control: document.getElementById('pre-imperial-control').value,
                    pre_imperial_trade: document.getElementById('pre-imperial-trade').value
                };

                const { error: dbError } = await supabaseClient
                    .from('worksheet_submissions')
                    .insert({
                        student_name: studentName,
                        section_number: sectionNumber,
                        worksheet_type: 'hist107-commodity-steps1-2',
                        file_path: fileName,
                        file_url: urlData.publicUrl,
                        form_data: formData,
                        submitted_at: new Date().toISOString()
                    });

                if (dbError) {
                    console.warn('Metadata save warning:', dbError.message);
                }

                messageDiv.innerHTML = '<div class="alert alert-success">‚úÖ Successfully submitted! Your worksheet has been sent to Prof. Hauselmann.</div>';
                submitBtn.textContent = '‚úì Submitted';

            } catch (error) {
                console.error('Submission error:', error);
                messageDiv.innerHTML = `<div class="alert alert-error">‚ùå Submission failed: ${error.message}. Please try again or export the PDF and email it to your professor.</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = 'üì§ Submit to Professor';
            }
        }

        function generatePDFBlob() {
            return new Promise((resolve) => {
                const commodityName = document.getElementById('commodity-name').value === 'Other'
                    ? document.getElementById('commodity-other').value
                    : document.getElementById('commodity-name').value;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const lineHeight = 7;
                const pageWidth = 190;
                const pageHeight = 280;  // Safe area before bottom margin
                let y = 20;

                // Helper function to check page overflow and add new page if needed
                function checkPageOverflow(neededSpace) {
                    if (y + neededSpace > pageHeight) {
                        doc.addPage();
                        y = 20;
                    }
                }

                function addWrappedText(text, x, maxWidth) {
                    const lines = doc.splitTextToSize(text, maxWidth);
                    lines.forEach((line) => {
                        if (y + lineHeight > pageHeight) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(line, x, y);
                        y += lineHeight;
                    });
                }

                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('HIST 107 Commodity Research Worksheet', 105, y, { align: 'center' });
                y += 10;

                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Steps 1-2: Understanding the Question & Defining the Commodity', 105, y, { align: 'center' });
                y += 15;

                doc.setFontSize(10);
                const studentName = document.getElementById('student-name').value;
                const sectionNumber = document.getElementById('section-number').value;
                if (studentName) {
                    doc.text(`Student: ${studentName}`, 20, y);
                    y += 8;
                }
                if (sectionNumber) {
                    doc.text(`Section: ${sectionNumber}`, 20, y);
                    y += 8;
                }
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y);
                y += 12;

                checkPageOverflow(20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('STEP 1: Understanding the Big Question', 20, y);
                y += 10;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Central Question:', 20, y);
                y += 7;
                addWrappedText(
                    'How did this raw material become a global commodity, and what does that process reveal about capitalism, empire, and globalization?',
                    25,
                    pageWidth - 25
                );
                y += 8;

                checkPageOverflow(15);
                doc.text('My Interpretation:', 20, y);
                y += 7;
                addWrappedText(
                    document.getElementById('question-interpretation').value || '[Not answered]',
                    25,
                    pageWidth - 25
                );
                y += 8;

                checkPageOverflow(15);
                doc.text('Key Terms (Capitalism, Empire, Globalization):', 20, y);
                y += 7;
                addWrappedText(
                    document.getElementById('key-terms').value || '[Not answered]',
                    25,
                    pageWidth - 25
                );
                y += 12;

                checkPageOverflow(20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('STEP 2: Defining the Commodity & Its Early History', 20, y);
                y += 10;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Commodity: ${commodityName || '[Not selected]'}`, 20, y);
                y += 10;

                checkPageOverflow(15);
                doc.text('Overview:', 20, y);
                y += 7;
                addWrappedText(
                    document.getElementById('commodity-overview').value || '[Not answered]',
                    25,
                    pageWidth - 25
                );
                y += 8;

                checkPageOverflow(15);
                doc.text('Pre-Imperial Context:', 20, y);
                y += 7;

                checkPageOverflow(15);
                doc.text('Production Location:', 25, y);
                y += 7;
                addWrappedText(
                    document.getElementById('pre-imperial-production').value || '[Not answered]',
                    30,
                    pageWidth - 30
                );
                y += 6;

                checkPageOverflow(15);
                doc.text('Control of Production/Exchange:', 25, y);
                y += 7;
                addWrappedText(
                    document.getElementById('pre-imperial-control').value || '[Not answered]',
                    30,
                    pageWidth - 30
                );
                y += 6;

                checkPageOverflow(15);
                doc.text('Scale of Trade:', 25, y);
                y += 7;
                addWrappedText(
                    document.getElementById('pre-imperial-trade').value || '[Not answered]',
                    30,
                    pageWidth - 30
                );

                resolve(doc.output('blob'));
            });
        }

        checkAuth()
    </script>
</body>
</html>
