<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London 1854: Cesspits, Cholera and Conflict</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    body {
        font-family: 'Georgia', serif;
        background: linear-gradient(135deg, #2c1810 0%, #4a3428 100%);
        color: #1a1410;
        line-height: 1.7;
        min-height: 100vh;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    header {
        background: linear-gradient(135deg, #1a0f0a 0%, #3d2817 100%);
        color: #f4e4c1;
        padding: 50px 30px;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        border: 4px solid #8b6f47;
        position: relative;
    }

    header::before {
        content: '‚öïÔ∏è';
        position: absolute;
        top: 20px;
        left: 30px;
        font-size: 2.5em;
    }

    header::after {
        content: 'üèõÔ∏è';
        position: absolute;
        top: 20px;
        right: 30px;
        font-size: 2.5em;
    }

    h1 {
        font-size: 2.8em;
        margin-bottom: 10px;
        font-weight: normal;
        letter-spacing: 2px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .subtitle {
        font-size: 1.3em;
        font-style: italic;
        color: #d4af37;
        margin-top: 10px;
    }

    .date-location {
        font-size: 1.1em;
        margin-top: 15px;
        color: #f4e4c1;
        opacity: 0.9;
    }

    .breadcrumb {
        background: #f4e4c1;
        padding: 15px 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        border: 2px solid #8b6f47;
    }

    .breadcrumb a {
        color: #3d2817;
        text-decoration: none;
        font-weight: 600;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
        color: #1a0f0a;
    }

    .nav-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .tab-button {
        padding: 15px 25px;
        background: #f4e4c1;
        border: 3px solid #3d2817;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        font-weight: bold;
        transition: all 0.3s;
        color: #1a0f0a;
        font-family: 'Georgia', serif;
    }

    .tab-button:hover:not(:disabled) {
        background: #8b6f47;
        color: #f4e4c1;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .tab-button.active {
        background: #3d2817;
        color: #f4e4c1;
        border-color: #d4af37;
    }

    .tab-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .content-section {
        display: none;
        background: #faf8f3;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        margin-bottom: 20px;
        border: 3px solid #8b6f47;
    }

    .content-section.active {
        display: block;
        animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .victorian-box {
        background: #fff9e6;
        padding: 30px;
        border: 3px solid #8b6f47;
        margin: 20px 0;
        border-radius: 5px;
        box-shadow: inset 0 0 30px rgba(139, 111, 71, 0.1);
        position: relative;
    }

    .victorian-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(to right, transparent, #8b6f47, transparent);
    }

    h2 {
        color: #1a0f0a;
        font-size: 2.2em;
        margin-bottom: 20px;
        border-bottom: 3px solid #8b6f47;
        padding-bottom: 12px;
        font-weight: normal;
        letter-spacing: 1px;
    }

    h3 {
        color: #3d2817;
        font-size: 1.6em;
        margin-top: 25px;
        margin-bottom: 15px;
        font-weight: normal;
    }

    .role-card {
        background: #fff;
        padding: 25px;
        margin: 20px 0;
        border-radius: 5px;
        box-shadow: 0 3px 12px rgba(0,0,0,0.15);
        border-left: 6px solid #8b6f47;
        cursor: pointer;
        transition: all 0.3s;
    }

    .role-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        border-left-color: #d4af37;
    }

    .role-card.selected {
        border-left-color: #3d2817;
        background: #fff9e6;
        border: 3px solid #3d2817;
    }

    .role-header {
        font-weight: bold;
        color: #1a0f0a;
        margin-bottom: 10px;
        font-size: 1.4em;
    }

    .role-position {
        color: #8b6f47;
        font-style: italic;
        margin-bottom: 15px;
        font-size: 1.1em;
    }

    .role-faction {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 3px;
        font-size: 0.9em;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .faction-anti {
        background: #8b4513;
        color: #fff;
    }

    .faction-conta {
        background: #2d5016;
        color: #fff;
    }

    .question-box {
        background: #f0ebe0;
        padding: 25px;
        margin: 20px 0;
        border-radius: 5px;
        border-left: 5px solid #3d2817;
    }

    .question-label {
        font-weight: bold;
        color: #1a0f0a;
        margin-bottom: 12px;
        font-size: 1.2em;
    }

    textarea {
        width: 100%;
        min-height: 150px;
        padding: 15px;
        border: 2px solid #8b6f47;
        border-radius: 5px;
        font-family: 'Georgia', serif;
        font-size: 1em;
        resize: vertical;
        background: #fff;
    }

    input[type="text"], select {
        width: 100%;
        padding: 12px;
        border: 2px solid #8b6f47;
        border-radius: 5px;
        font-family: 'Georgia', serif;
        font-size: 1em;
        margin: 10px 0;
        background: #fff;
    }

    .btn {
        padding: 15px 30px;
        font-size: 1.1em;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 10px 5px;
        font-family: 'Georgia', serif;
    }

    .btn-primary {
        background: #3d2817;
        color: #f4e4c1;
        border: 2px solid #8b6f47;
    }

    .btn-primary:hover {
        background: #1a0f0a;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .btn-success {
        background: #2d5016;
        color: #f4e4c1;
    }

    .btn-danger {
        background: #8b0000;
        color: #f4e4c1;
    }

    .word-count {
        text-align: right;
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
    }

    .word-count.sufficient {
        color: #2d5016;
        font-weight: bold;
    }

    .warning-banner {
        background: #8b4513;
        color: #f4e4c1;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 6px solid #d4af37;
        font-weight: bold;
    }

    .success-banner {
        background: #2d5016;
        color: #f4e4c1;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 6px solid #8b6f47;
    }

    .progress-tracker {
        background: #3d2817;
        color: #f4e4c1;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
        justify-content: space-around;
        flex-wrap: wrap;
    }

    .progress-item {
        padding: 8px 15px;
        margin: 5px;
        border-radius: 3px;
        background: rgba(244, 228, 193, 0.2);
        font-size: 0.95em;
    }

    .progress-item.completed {
        background: #2d5016;
    }

    ul {
        margin-left: 30px;
        margin-top: 15px;
    }

    li {
        margin-bottom: 12px;
    }

    .historical-note {
        background: #e8dcc4;
        border: 3px solid #8b6f47;
        padding: 20px;
        margin: 20px 0;
        font-style: italic;
        border-radius: 5px;
    }

    .historical-note::before {
        content: 'üìú ';
        font-size: 1.3em;
    }

    blockquote {
        border-left: 4px solid #8b6f47;
        padding-left: 20px;
        margin: 20px 0;
        font-style: italic;
        color: #3d2817;
    }

    .role-details {
        margin-top: 15px;
        line-height: 1.8;
    }

    @media (max-width: 768px) {
        h1 {
            font-size: 2em;
        }
        
        header::before, header::after {
            display: none;
        }
        
        .content-section {
            padding: 25px;
        }
        
        .tab-button {
            padding: 12px 18px;
            font-size: 0.9em;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>London 1854</h1>
            <p class="subtitle">Cesspits, Cholera and Conflict over the Broad Street Pump</p>
            <p class="date-location">Vestry Hall, Soho ¬∑ September 7, 1854</p>
        </header>

    <div class="breadcrumb">
        <a href="index.html">‚Üê Home</a> | <a href="activities.html">Interactive Activities</a>
    </div>

    <div class="progress-tracker" id="progress-tracker" style="display: flex;">
        <div class="progress-item completed" id="progress-intro">Introduction</div>
        <div class="progress-item" id="progress-role">Role Selection</div>
        <div class="progress-item" id="progress-character">Character Study</div>
        <div class="progress-item" id="progress-argument">Your Argument</div>
        <div class="progress-item" id="progress-motion">Your Motion</div>
        <div class="progress-item" id="progress-submit">Submit</div>
    </div>

    <div class="nav-tabs">
        <button class="tab-button active" onclick="showTab('intro')">Introduction</button>
        <button class="tab-button" onclick="showTab('role-select')" id="tab-role">Select Role</button>
        <button class="tab-button" onclick="showTab('character')" id="tab-character" disabled>Your Character</button>
        <button class="tab-button" onclick="showTab('argument')" id="tab-argument" disabled>Build Argument</button>
        <button class="tab-button" onclick="showTab('motion')" id="tab-motion" disabled>Draft Motion</button>
        <button class="tab-button" onclick="showTab('submit')" id="tab-submit" disabled>Submit Work</button>
    </div>

    <!-- INTRODUCTION -->
    <div id="intro" class="content-section active">
        <h2>Prologue: An Evening in Soho</h2>
        
        <div class="victorian-box">
            <blockquote style="font-size: 1.1em;">
                Evening is setting in as you turn down Marshall Street and make your way toward the Vestry of St. James Piccadilly. There is no haste in your step. Your route is less than a half a mile long, and it is an easy ten-minute walk even under the worst of conditions. In fact, these may just be the worst of conditions...
            </blockquote>
        </div>

        <div class="victorian-box">
            <h3>The Crisis</h3>
            <p>According to unofficial reports, the dreaded <strong>Asiatic cholera</strong> has claimed the lives of nearly <strong>400 of your fellow parishioners</strong> over the past four and a half weeks. You shudder at the thought that this number may give a very inadequate idea of the entire loss inflicted by the epidemic thus far, particularly among the poor.</p>
            
            <p style="margin-top: 15px;">These unfortunate souls were your co-workers, your clients, your neighbors, and the schoolmates of your children. Death and disease have cast a dark shroud over this corner of London.</p>
            
            <p style="margin-top: 15px;">The bells of St. James's Church begin to chime 6:00 p.m., a reminder that you should start focusing on the evening's business. You are headed to a special meeting of the <strong>Sanitary Committee</strong> of the parish's Board of Governors and Directors of the Poor.</p>
        </div>

        <div class="victorian-box">
            <h3>Your Mission</h3>
            <p>As a member of this emergency response committee, you and your colleagues will debate three central questions:</p>
            <ul>
                <li><strong>What is the source of this disease outbreak?</strong></li>
                <li><strong>How is cholera communicated from person to person?</strong></li>
                <li><strong>What steps should be taken to contain the outbreak?</strong></li>
            </ul>
            
            <p style="margin-top: 20px;">Over the course of this simulation, you will:</p>
            <ol>
                <li>Select and study a historical character with specific views on cholera</li>
                <li>Develop a data-driven argument about the cholera outbreak</li>
                <li>Draft a motion proposing specific actions the committee should take</li>
                <li>Prepare to debate with fellow committee members</li>
            </ol>
        </div>

        <div class="historical-note">
            <strong>Historical Context:</strong> This simulation is based on the actual 1854 cholera outbreak in London's Soho district. You will engage with the real scientific debate between <strong>miasma theory</strong> (disease spreads through "bad air") and <strong>contagionism</strong> (disease spreads through water or human contact). This debate would eventually lead to the founding of modern epidemiology and microbiology.
        </div>

        <div class="victorian-box">
            <h3>Student Information</h3>
            <label for="student-name"><strong>Your Name:</strong></label>
            <input type="text" id="student-name" placeholder="Enter your full name">
            
            <label for="section-number"><strong>Section Number:</strong></label>
            <input type="text" id="section-number" placeholder="Enter your section number (e.g., 101, 102)">
        </div>

        <div class="victorian-box">
            <h3>Ready to Begin?</h3>
            <p>Click "Enter the Committee Room" below to start the simulation!</p>
        </div>
        
        <button class="btn btn-primary" onclick="startActivity()">Enter the Committee Room ‚Üí</button>
    </div>

    <!-- ROLE SELECTION -->
    <div id="role-select" class="content-section">
        <h2>Select Your Role</h2>
        
        <div class="warning-banner">
            ‚ö†Ô∏è Choose carefully! Your role will determine your position in the debate and your objectives throughout the simulation.
        </div>

        <div class="victorian-box">
            <h3>Understanding the Factions</h3>
            
            <h4 style="margin-top: 20px; color: #8b4513;">üúè Anticontagionists (Miasma Theory)</h4>
            <p>Believe cholera spreads through <strong>miasma</strong> or "bad air" caused by filth, overcrowding, poor ventilation, and the moral degradation of the working class. They oppose quarantines and favor improving living conditions, sanitation, and social reform.</p>
            
            <h4 style="margin-top: 20px; color: #2d5016;">üíß Contagionists (Waterborne Theory)</h4>
            <p>Believe cholera spreads through <strong>contaminated water</strong> or direct contact with infected individuals. They favor removing the Broad Street Pump handle, investigating water sources, and implementing quarantine measures.</p>
        </div>

        <h3 style="margin-top: 30px;">Available Roles</h3>

        <div id="roles-container">
            <!-- Anticontagionist Roles -->
            <div class="role-card" onclick="selectRole('frederick-crane')">
                <div class="role-faction faction-anti">ANTICONTAGIONIST</div>
                <div class="role-header">Frederick Crane</div>
                <div class="role-position">Committee Chairman ¬∑ Senior Churchwarden</div>
                <div class="role-details">
                    <p>Born 1805, son of a cobbler who rose to own a small shop. A staunch believer in miasma theory, you attribute cholera to the "epidemic constitution of the atmosphere" and the moral condition of the poor. As chairman, you wield significant authority in framing the debate.</p>
                    <p style="margin-top: 10px;"><strong>Key Focus:</strong> Working class conditions, labor reform, social improvement</p>
                </div>
            </div>

            <div class="role-card" onclick="selectRole('george-buzzard')">
                <div class="role-faction faction-anti">ANTICONTAGIONIST</div>
                <div class="role-header">George Buzzard</div>
                <div class="role-position">Committee Vice-Chairman ¬∑ Physician</div>
                <div class="role-details">
                    <p>Born 1800, trained at Guy's Hospital. You believe cholera arises from atmospheric conditions combined with local filth. A respected physician who favors environmental improvements over quarantine measures.</p>
                    <p style="margin-top: 10px;"><strong>Key Focus:</strong> Medical evidence, atmospheric conditions, sanitation reform</p>
                </div>
            </div>

            <div class="role-card" onclick="selectRole('john-pugh')">
                <div class="role-faction faction-anti">ANTICONTAGIONIST</div>
                <div class="role-header">John Pugh</div>
                <div class="role-position">Churchwarden ¬∑ Social Reformer</div>
                <div class="role-details">
                    <p>Born 1808, deeply concerned with the plight of the working poor. You see cholera as a symptom of broader social inequality and advocate for education, better housing, and moral uplift of the lower classes.</p>
                    <p style="margin-top: 10px;"><strong>Key Focus:</strong> Education, housing reform, moral improvement</p>
                </div>
            </div>

            <!-- Contagionist Roles -->
            <div class="role-card" onclick="selectRole('john-snow')">
                <div class="role-faction faction-conta">CONTAGIONIST</div>
                <div class="role-header">Dr. John Snow</div>
                <div class="role-position">Physician ¬∑ Epidemiological Investigator</div>
                <div class="role-details">
                    <p>Born 1813, a pioneering physician who has been mapping cholera cases. You have radical evidence suggesting the Broad Street Pump is the source of the outbreak. Your data-driven approach challenges the miasma orthodoxy.</p>
                    <p style="margin-top: 10px;"><strong>Key Focus:</strong> Statistical evidence, water contamination, pump removal</p>
                </div>
            </div>

            <div class="role-card" onclick="selectRole('henry-whitehead')">
                <div class="role-faction faction-conta">CONTAGIONIST</div>
                <div class="role-header">Reverend Henry Whitehead</div>
                <div class="role-position">Curate of St. Luke's Parish</div>
                <div class="role-details">
                    <p>Born 1825, initially skeptical of Snow's theory but your pastoral visits revealed patterns in the outbreak. You know the neighborhood intimately and have conducted careful interviews with victims' families.</p>
                    <p style="margin-top: 10px;"><strong>Key Focus:</strong> Neighborhood testimony, case investigation, community knowledge</p>
                </div>
            </div>

            <div class="role-card" onclick="selectRole('william-farr')">
                <div class="role-faction faction-conta">CONTAGIONIST</div>
                <div class="role-header">William Farr</div>
                <div class="role-position">Superintendent of Statistics ¬∑ Medical Statistician</div>
                <div class="role-details">
                    <p>Born 1807, you compile mortality statistics for the General Register Office. While initially a miasmatist, the data is leading you toward waterborne transmission. Your statistical authority carries great weight.</p>
                    <p style="margin-top: 10px;"><strong>Key Focus:</strong> Statistical analysis, mortality data, elevation theory</p>
                </div>
            </div>
        </div>

        <div id="role-confirmation" style="display: none; margin-top: 30px;">
            <div class="success-banner">
                ‚úì Role Selected: <span id="selected-role-name"></span>
            </div>
            <button class="btn btn-primary" onclick="confirmRole()">Continue to Character Study ‚Üí</button>
        </div>
    </div>

    <!-- CHARACTER STUDY -->
    <div id="character" class="content-section">
        <h2>Study Your Character</h2>
        
        <div id="character-details">
            <!-- Will be populated by JavaScript -->
        </div>

        <div class="question-box" style="margin-top: 30px;">
            <div class="question-label">Character Understanding Questions</div>
            
            <label style="font-weight: bold; margin-top: 15px; display: block;">1. What is your character's main belief about how cholera spreads?</label>
            <textarea id="char-q1" oninput="checkCharacterCompletion()"></textarea>
            
            <label style="font-weight: bold; margin-top: 20px; display: block;">2. What is your character's primary objective in this committee meeting?</label>
            <textarea id="char-q2" oninput="checkCharacterCompletion()"></textarea>
            
            <label style="font-weight: bold; margin-top: 20px; display: block;">3. What personal experiences or background inform your character's perspective?</label>
            <textarea id="char-q3" oninput="checkCharacterCompletion()"></textarea>
        </div>

        <button class="btn btn-primary" onclick="completeCharacter()" id="complete-char-btn" style="display: none; margin-top: 20px;">Continue to Build Your Argument ‚Üí</button>
    </div>

    <!-- BUILD ARGUMENT -->
    <div id="argument" class="content-section">
        <h2>Build Your Scientific Argument</h2>
        
        <div class="victorian-box">
            <h3>Your Task</h3>
            <p>You will present a data-driven argument to the committee about your views on the cholera outbreak. Your argument should include:</p>
            <ul>
                <li>Your theory about how cholera spreads</li>
                <li>Specific evidence supporting your theory</li>
                <li>Analysis of data or observations</li>
                <li>Refutation of opposing theories</li>
            </ul>
        </div>

        <div class="question-box">
            <div class="question-label">Opening Statement: How does cholera spread?</div>
            <p style="font-size: 0.95em; color: #666; margin-bottom: 10px;">State your theory clearly from your character's perspective. Are you a miasmatist or contagionist?</p>
            <textarea id="arg-theory" oninput="updateWordCount('arg-theory', 'theory-count')"></textarea>
            <div class="word-count" id="theory-count">Word count: 0 / 150 minimum</div>
        </div>

        <div class="question-box">
            <div class="question-label">Evidence and Data</div>
            <p style="font-size: 0.95em; color: #666; margin-bottom: 10px;">What specific evidence supports your theory? Include observations, statistics, patterns, or case studies.</p>
            <textarea id="arg-evidence" oninput="updateWordCount('arg-evidence', 'evidence-count')" style="min-height: 200px;"></textarea>
            <div class="word-count" id="evidence-count">Word count: 0 / 200 minimum</div>
        </div>

        <div class="question-box">
            <div class="question-label">Analysis and Interpretation</div>
            <p style="font-size: 0.95em; color: #666; margin-bottom: 10px;">Explain what your evidence means. How does it prove your theory?</p>
            <textarea id="arg-analysis" oninput="updateWordCount('arg-analysis', 'analysis-count')" style="min-height: 200px;"></textarea>
            <div class="word-count" id="analysis-count">Word count: 0 / 200 minimum</div>
        </div>

        <div class="question-box">
            <div class="question-label">Addressing Opposition</div>
            <p style="font-size: 0.95em; color: #666; margin-bottom: 10px;">What arguments will your opponents make? How will you refute them?</p>
            <textarea id="arg-opposition" oninput="updateWordCount('arg-opposition', 'opposition-count')"></textarea>
            <div class="word-count" id="opposition-count">Word count: 0 / 150 minimum</div>
        </div>

        <button class="btn btn-primary" onclick="completeArgument()" id="complete-arg-btn" style="margin-top: 20px;">Continue to Draft Motion ‚Üí</button>
    </div>

    <!-- DRAFT MOTION -->
    <div id="motion" class="content-section">
        <h2>Draft Your Motion</h2>
        
        <div class="victorian-box">
            <h3>What is a Motion?</h3>
            <p>A motion is a formal proposal for specific action that the committee should take. Your motion should be based on your theory of how cholera spreads and should propose concrete steps to address the outbreak.</p>
            
            <h4 style="margin-top: 20px;">Examples of Motions:</h4>
            <ul>
                <li><strong>Anticontagionist motions</strong> might propose: improving street cleaning, increasing ventilation in workhouses, educating the poor about hygiene, providing better housing</li>
                <li><strong>Contagionist motions</strong> might propose: removing the Broad Street Pump handle, investigating water sources, implementing quarantine measures, boiling water before consumption</li>
            </ul>
        </div>

        <div class="question-box">
            <div class="question-label">Motion Title</div>
            <p style="font-size: 0.95em; color: #666; margin-bottom: 10px;">Give your motion a clear, descriptive title (e.g., "Motion to Remove the Broad Street Pump Handle")</p>
            <input type="text" id="motion-title" placeholder="Enter motion title">
        </div>

        <div class="question-box">
            <div class="question-label">Motion Text</div>
            <p style="font-size: 0.95em; color: #666; margin-bottom: 10px;">Write the formal text of your motion. Be specific about what action should be taken.</p>
            <textarea id="motion-text" placeholder="I move that this committee..." oninput="updateWordCount('motion-text', 'motion-count')"></textarea>
            <div class="word-count" id="motion-count">Word count: 0 / 100 minimum</div>
        </div>

        <div class="question-box">
            <div class="question-label">Justification</div>
            <p style="font-size: 0.95em; color: #666; margin-bottom: 10px;">Explain why this motion is necessary and how it will help contain the cholera outbreak.</p>
            <textarea id="motion-justification" oninput="updateWordCount('motion-justification', 'justification-count')" style="min-height: 200px;"></textarea>
            <div class="word-count" id="justification-count">Word count: 0 / 200 minimum</div>
        </div>

        <div class="question-box">
            <div class="question-label">Expected Outcomes</div>
            <p style="font-size: 0.95em; color: #666; margin-bottom: 10px;">What results do you expect if your motion is adopted?</p>
            <textarea id="motion-outcomes" oninput="updateWordCount('motion-outcomes', 'outcomes-count')"></textarea>
            <div class="word-count" id="outcomes-count">Word count: 0 / 100 minimum</div>
        </div>

        <button class="btn btn-primary" onclick="completeMotion()" id="complete-motion-btn" style="margin-top: 20px;">Review and Submit ‚Üí</button>
    </div>

    <!-- SUBMIT -->
    <div id="submit" class="content-section">
        <h2>Review and Submit Your Work</h2>
        
        <div class="victorian-box">
            <h3>Summary of Your Preparation</h3>
            <div id="work-summary">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <div class="victorian-box">
            <h3>Download Your Work</h3>
            <p>Download your completed preparation materials as a PDF for your records.</p>
            <button class="btn btn-success" onclick="downloadPDF()">üìÑ Download as PDF</button>
        </div>

        <div class="victorian-box">
            <h3>Submit to Professor</h3>
            <p>Submit your completed work to Prof. Hauselmann.</p>
            <button class="btn btn-primary" onclick="submitToSupabase()" id="submitBtn">üì§ Submit to Professor</button>
            <div id="submitMessage" style="margin-top: 15px;"></div>
        </div>
    </div>

</div>

<script>
    console.log('Script starting to load...');
    
    // Define critical functions FIRST before anything else
    function showTab(tabName) {
        console.log('showTab called with:', tabName);
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');
        if (typeof event !== 'undefined' && event.target) {
            event.target.classList.add('active');
        }
        window.scrollTo(0, 0);
        console.log('showTab completed');
    }
    
    console.log('showTab function defined');
    
    function selectRole(roleKey) {
        console.log('selectRole called with:', roleKey);
        document.querySelectorAll('.role-card').forEach(card => {
            card.classList.remove('selected');
        });
        if (typeof event !== 'undefined' && event.currentTarget) {
            event.currentTarget.classList.add('selected');
        }
        activityState.selectedRole = roleKey;
        activityState.roleFaction = roleData[roleKey].faction;
        document.getElementById('role-confirmation').style.display = 'block';
        document.getElementById('selected-role-name').textContent = roleData[roleKey].name + ' (' + roleData[roleKey].faction + ')';
        document.getElementById('role-confirmation').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Supabase configuration
    const SUPABASE_URL = 'https://bqrluqymscucvbiaaeai.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcmx1cXltc2N1Y3ZiaWFhZWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njg4MTMsImV4cCI6MjA4NDI0NDgxM30.AVOjnQe_TDoWydE2wDP1_YftU1lBkYxcPuyQeZb8Nfs';
    let supabaseClient = null;
    
    // Supabase will be initialized after the library loads at the end of the page
    function initSupabase() {
        if (typeof supabase !== 'undefined' && !supabaseClient) {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase initialized successfully');
        }
    }

    // Activity state
    let activityState = {
        studentName: '',
        sectionNumber: '',
        selectedRole: '',
        roleFaction: '',
        characterStudy: {
            q1: '',
            q2: '',
            q3: ''
        },
        argument: {
            theory: '',
            evidence: '',
            analysis: '',
            opposition: ''
        },
        motion: {
            title: '',
            text: '',
            justification: '',
            outcomes: ''
        },
        timestamp: null
    };

    // Role data
    const roleData = {
        'frederick-crane': {
            name: 'Frederick Crane',
            position: 'Committee Chairman ¬∑ Senior Churchwarden',
            faction: 'Anticontagionist',
            bio: `You were born in 1805 and have since served as the Senior Churchwarden of the Vestry of St. James, Westminster. This role, which you approach with a blend of devotion and diligence, has earned you deep respect in the community.
As a staunch Anticontagionist, you hold firmly to the belief that cholera spreads through miasma, or bad air, rather than by waterborne means. This conviction shapes your approach to combating the outbreak.

Your interest in social reform is personal. As the son of a once-struggling cobbler, you witnessed first-hand the plight of the impoverished. Your father's eventual rise to own a small shop instilled in you a belief that improvement of the working class is both possible and necessary.`,
            objectives: `You and the other Anticontagionist members believe cholera can be explained by:

- The epidemic constitution of the atmosphere
- Local atmospheric conditions (temperature, humidity, air pressure)
- Physical and chemical factors in the environment
- Moral and social conditions of the working poor
- Overcrowding and poor ventilation
- Lack of cleanliness and sanitation`,
            responsibilities: `As Committee Chairman, you will:
- Preside over committee meetings with the vice-chair and secretary
- Advance the Anticontagionist argument with data and analysis
- Present arguments based on the work of James Kay-Shuttleworth and Friedrich Engels
- Propose motions to improve working class conditions: shorter hours, better education, improved sanitation, increased ventilation`,
            powers: `As chairman, you wield significant structural authority in framing the debate. While you must ensure everyone speaks, including opponents, you can strategically control speaking order and discussion topics.`
        },
        'george-buzzard': {
            name: 'George Buzzard',
            position: 'Committee Vice-Chairman ¬∑ Physician',
            faction: 'Anticontagionist',
            bio: `Born in 1800, you received your medical training at Guy's Hospital in London, one of the premier medical institutions of the age. Your practice has brought you into contact with all levels of society, from the wealthy merchants to the poorest laborers.

You firmly believe cholera arises from a combination of atmospheric conditions and local environmental factors. The filth, overcrowding, and poor ventilation in the working-class districts create the perfect conditions for disease to flourish.

Your medical expertise gives weight to your arguments, and you are skilled at presenting complex medical concepts in ways the layperson can understand.`,
            objectives: `As an Anticontagionist physician, you believe:

- Cholera is not contagious person-to-person
- Disease arises from "epidemic constitution of the atmosphere"
- Local filth and overcrowding worsen outbreaks
- Quarantines are ineffective and economically harmful
- Environmental improvements are the key to prevention`,
            responsibilities: `You will:
- Support Chairman Crane in presiding over meetings
- Present medical evidence supporting miasma theory
- Challenge contagionist medical claims
- Propose motions for sanitary improvements and better ventilation
- Use your medical authority to frame the scientific debate`,
            powers: `Your medical credentials give you authority in scientific debates. Use your expertise to validate anticontagionist arguments and question the methodology of contagionist investigators.`
        },
        'john-pugh': {
            name: 'John Pugh',
            position: 'Churchwarden ¬∑ Social Reformer',
            faction: 'Anticontagionist',
            bio: `Born in 1808, you have dedicated your life to the moral and material improvement of the working poor. You serve as a churchwarden and are deeply involved in parish charitable work.

You see the cholera outbreak not merely as a medical crisis but as a symptom of broader social inequality. The disease strikes hardest in neighborhoods where people live in degrading conditions, work excessive hours, and lack access to education.

You believe that true prevention requires addressing the root causes: poverty, ignorance, and moral degradation. Simply removing a pump or implementing quarantines treats symptoms, not causes.`,
            objectives: `Your focus is on social reform:

- Improve housing conditions for the working class
- Expand educational opportunities
- Reduce working hours to allow for rest and moral improvement
- Promote temperance and moral education
- Address the degrading conditions that breed disease`,
            responsibilities: `You will:
- Advocate for comprehensive social reform
- Present evidence linking poverty and disease
- Propose motions for education and housing improvements
- Emphasize the moral dimension of the crisis
- Coordinate with other Anticontagionists on reform measures`,
            powers: `Your moral authority and deep knowledge of the parish gives you credibility when discussing the lived experiences of the poor. Use this to humanize the statistics and frame the debate in moral terms.`
        },
        'john-snow': {
            name: 'Dr. John Snow',
            position: 'Physician ¬∑ Epidemiological Investigator',
            faction: 'Contagionist',
            bio: `Born in 1813 in York, you are a physician who has spent years investigating cholera outbreaks. You pioneered the use of chloroform as an anesthetic and have a reputation for careful, methodical research.

You have been mapping every cholera case in Soho and have discovered a striking pattern: nearly all victims either used the Broad Street Pump or had contact with someone who did. Your data suggests the pump water is contaminated.

This is a radical claim that challenges the prevailing miasma theory. Many in the medical establishment dismiss your ideas, but you have confidence in your evidence. The truth is in the data.`,
            objectives: `As the leading contagionist investigator:

- Prove cholera spreads through contaminated water
- Present your dot map showing cases clustering around the Broad Street Pump
- Demonstrate that the Broad Street Pump is the source
- Convince the committee to remove the pump handle
- Challenge miasma theory with statistical evidence`,
            responsibilities: `You will:
- Present your detailed case investigation and mapping data
- Explain specific cases that prove waterborne transmission
- Propose removing the Broad Street Pump handle immediately
- Refute miasmatist atmospheric arguments with hard evidence
- Advocate for investigating all water sources in affected areas`,
            powers: `Your systematic data collection and mapping methodology is unprecedented. Use your statistical evidence to make an irrefutable case. Your dot map is your most powerful weapon.`
        },
        'henry-whitehead': {
            name: 'Reverend Henry Whitehead',
            position: 'Curate of St. Luke\'s Parish',
            faction: 'Contagionist',
            bio: `Born in 1825, you are the young curate of St. Luke's Parish in Soho. Initially, you were skeptical of Dr. Snow's waterborne theory and believed in miasma. However, your pastoral duties during the outbreak changed your mind.

As you visited the sick and dying, you conducted careful interviews with families. You discovered patterns that Snow's maps didn't show: specific cases that proved the pump connection, including the famous case of the Widow from Hampstead who preferred Broad Street water.

Your intimate knowledge of the neighborhood and its residents gives you insights that statistics alone cannot provide. You know these people by name, know their habits, know their stories.`,
            objectives: `Your goals as a pastoral investigator:

- Support Dr. Snow's waterborne theory with community testimony
- Present specific case studies that prove the pump connection
- Use your trusted position to validate Snow's findings
- Show how local knowledge confirms statistical patterns
- Advocate for immediate pump removal to save lives`,
            responsibilities: `You will:
- Present detailed case studies from your pastoral visits
- Describe the patterns you observed in the neighborhood
- Explain why certain families were spared and others struck
- Support Snow's motion to remove the pump handle
- Use your moral authority to make an urgent appeal for action`,
            powers: `Your pastoral role gives you access and trust that scientists lack. People tell clergy things they won't tell doctors. Use your case studies to put human faces on Snow's statistics.`
        },
        'william-farr': {
            name: 'William Farr',
            position: 'Superintendent of Statistics ¬∑ Medical Statistician',
            faction: 'Contagionist',
            bio: `Born in 1807, you are the Superintendent of Statistics at the General Register Office. You compile mortality data for all of England and Wales. Your statistical work has made you one of the most respected medical authorities in Britain.

You were initially a believer in miasma theory and developed the "elevation theory"‚Äîthat cholera mortality correlated with altitude above the Thames. However, the Soho outbreak has shaken your confidence. The data doesn't fit the elevation pattern here.

Your statistical authority carries enormous weight. If you support Snow's waterborne theory, others will listen. But you must be convinced by the evidence, not swayed by emotion.`,
            objectives: `As the nation's chief medical statistician:

- Analyze mortality data to determine the true pattern of spread
- Evaluate both miasmatist and contagionist evidence objectively
- Determine whether elevation theory or waterborne theory better explains this outbreak
- Lend your statistical authority to the correct theory
- Propose evidence-based public health measures`,
            responsibilities: `You will:
- Present comprehensive mortality statistics for the outbreak
- Analyze spatial patterns in the death data
- Compare this outbreak to previous cholera waves
- Evaluate competing theories against the statistical evidence
- Propose motions based on rigorous data analysis`,
            powers: `Your official position and statistical expertise make you perhaps the most authoritative voice on the committee. Your endorsement or rejection of a theory could determine the debate's outcome.`
        }
    };

    window.startActivity = function() {
        const name = document.getElementById('student-name').value.trim();
        const section = document.getElementById('section-number').value.trim();
  
        if (!name || !section) {
            alert('Please enter your name and section number before beginning.');
            return;
        }
  
        activityState.studentName = name;
        activityState.sectionNumber = section;
        activityState.timestamp = new Date().toISOString();
  
        document.getElementById('progress-tracker').style.display = 'flex';
        document.getElementById('progress-intro').classList.add('completed');
        document.getElementById('tab-role').disabled = false;
        
        showTab('role-select');
    }
  
  
    window.startActivity = function() {
        const name = document.getElementById('student-name').value.trim();
        const section = document.getElementById('section-number').value.trim();

        if (!name) {
            alert('Please enter your name before beginning.');
            return;
        }

        if (!section) {
            alert('Please enter your section number before beginning.');
            return;
        }

        activityState.studentName = name;
        activityState.sectionNumber = section;
        activityState.timestamp = new Date().toISOString();

        document.getElementById('progress-tracker').style.display = 'flex';
        document.getElementById('progress-intro').classList.add('completed');
        document.getElementById('tab-role').disabled = false;

        showTab('role-select');
    }

    window.confirmRole = function() {
        document.getElementById('progress-role').classList.add('completed');
        document.getElementById('tab-character').disabled = false;
        
        // Populate character details
        populateCharacterDetails();
        
        showTab('character');
    }
  
    function populateCharacterDetails() {
        const role = roleData[activityState.selectedRole];
        const detailsDiv = document.getElementById('character-details');
        
        const factionClass = role.faction === 'Anticontagionist' ? 'faction-anti' : 'faction-conta';
        
        detailsDiv.innerHTML = `
            <div class="victorian-box">
                <div class="role-faction ${factionClass}" style="margin-bottom: 15px;">${role.faction.toUpperCase()}</div>
                <h3>${role.name}</h3>
                <p style="font-style: italic; color: #8b6f47; font-size: 1.1em;">${role.position}</p>
            </div>
  
            <div class="victorian-box">
                <h3>Biography</h3>
                <p style="white-space: pre-line;">${role.bio}</p>
            </div>
  
            <div class="victorian-box">
                <h3>Your Objectives</h3>
                <p style="white-space: pre-line;">${role.objectives}</p>
            </div>
  
            <div class="victorian-box">
                <h3>Your Responsibilities</h3>
                <p style="white-space: pre-line;">${role.responsibilities}</p>
            </div>
  
            <div class="victorian-box">
                <h3>Your Powers and Influence</h3>
                <p>${role.powers}</p>
            </div>
        `;
    }
  
    window.checkCharacterCompletion = function() {
        const q1 = document.getElementById('char-q1').value.trim();
        const q2 = document.getElementById('char-q2').value.trim();
        const q3 = document.getElementById('char-q3').value.trim();
        
        if (q1 && q2 && q3) {
            document.getElementById('complete-char-btn').style.display = 'block';
        }
    }
  
    window.completeCharacter = function() {
        activityState.characterStudy.q1 = document.getElementById('char-q1').value.trim();
        activityState.characterStudy.q2 = document.getElementById('char-q2').value.trim();
        activityState.characterStudy.q3 = document.getElementById('char-q3').value.trim();
        
        document.getElementById('progress-character').classList.add('completed');
        document.getElementById('tab-argument').disabled = false;
        
        showTab('argument');
    }
  
    window.updateWordCount = function(textareaId, countId) {
        const textarea = document.getElementById(textareaId);
        const countDiv = document.getElementById(countId);
        const words = textarea.value.trim().split(/\s+/).filter(w => w.length > 0).length;
        
        const match = countDiv.textContent.match(/(\d+) minimum/);
        const minimum = match ? parseInt(match[1]) : 0;
        
        countDiv.textContent = `Word count: ${words} / ${minimum} minimum`;
        
        if (words >= minimum) {
            countDiv.classList.add('sufficient');
        } else {
            countDiv.classList.remove('sufficient');
        }
        
        checkArgumentCompletion();
        checkMotionCompletion();
    }
  
    function checkArgumentCompletion() {
        const theory = document.getElementById('arg-theory').value.trim().split(/\s+/).filter(w => w.length > 0).length;
        const evidence = document.getElementById('arg-evidence').value.trim().split(/\s+/).filter(w => w.length > 0).length;
        const analysis = document.getElementById('arg-analysis').value.trim().split(/\s+/).filter(w => w.length > 0).length;
        const opposition = document.getElementById('arg-opposition').value.trim().split(/\s+/).filter(w => w.length > 0).length;
        
        if (theory >= 150 && evidence >= 200 && analysis >= 200 && opposition >= 150) {
            document.getElementById('complete-arg-btn').style.display = 'block';
        } else {
            document.getElementById('complete-arg-btn').style.display = 'none';
        }
    }
  
    window.completeArgument = function() {
        activityState.argument.theory = document.getElementById('arg-theory').value.trim();
        activityState.argument.evidence = document.getElementById('arg-evidence').value.trim();
        activityState.argument.analysis = document.getElementById('arg-analysis').value.trim();
        activityState.argument.opposition = document.getElementById('arg-opposition').value.trim();
        
        document.getElementById('progress-argument').classList.add('completed');
        document.getElementById('tab-motion').disabled = false;
        
        showTab('motion');
    }
  
    function checkMotionCompletion() {
        const title = document.getElementById('motion-title').value.trim();
        const text = document.getElementById('motion-text').value.trim().split(/\s+/).filter(w => w.length > 0).length;
        const justification = document.getElementById('motion-justification').value.trim().split(/\s+/).filter(w => w.length > 0).length;
        const outcomes = document.getElementById('motion-outcomes').value.trim().split(/\s+/).filter(w => w.length > 0).length;
        
        if (title && text >= 100 && justification >= 200 && outcomes >= 100) {
            document.getElementById('complete-motion-btn').style.display = 'block';
        } else {
            document.getElementById('complete-motion-btn').style.display = 'none';
        }
    }
  
    window.completeMotion = function() {
        activityState.motion.title = document.getElementById('motion-title').value.trim();
        activityState.motion.text = document.getElementById('motion-text').value.trim();
        activityState.motion.justification = document.getElementById('motion-justification').value.trim();
        activityState.motion.outcomes = document.getElementById('motion-outcomes').value.trim();
        
        document.getElementById('progress-motion').classList.add('completed');
        document.getElementById('tab-submit').disabled = false;
        
        generateWorkSummary();
        showTab('submit');
    }
  
    function generateWorkSummary() {
        const summaryDiv = document.getElementById('work-summary');
        const role = roleData[activityState.selectedRole];
        
        let html = `
            <p><strong>Student:</strong> ${activityState.studentName}</p>
            <p><strong>Section:</strong> ${activityState.sectionNumber}</p>
            <p><strong>Completed:</strong> ${new Date(activityState.timestamp).toLocaleString()}</p>
            <p><strong>Role:</strong> ${role.name} (${role.faction})</p>
            
            <h4 style="margin-top: 25px;">Character Understanding</h4>
            <p><strong>How cholera spreads:</strong> ${activityState.characterStudy.q1.substring(0, 150)}...</p>
            <p><strong>Primary objective:</strong> ${activityState.characterStudy.q2.substring(0, 150)}...</p>
            
            <h4 style="margin-top: 25px;">Your Argument</h4>
            <p><strong>Theory:</strong> ${activityState.argument.theory.substring(0, 200)}...</p>
            <p><strong>Evidence (${activityState.argument.evidence.split(/\s+/).length} words):</strong> ${activityState.argument.evidence.substring(0, 200)}...</p>
            
            <h4 style="margin-top: 25px;">Your Motion</h4>
            <p><strong>Title:</strong> ${activityState.motion.title}</p>
            <p><strong>Motion text:</strong> ${activityState.motion.text.substring(0, 200)}...</p>
        `;
        
        summaryDiv.innerHTML = html;
    }
  
    window.downloadPDF = function() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const role = roleData[activityState.selectedRole];
  
            let y = 20;
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
  
            function addText(text, size = 12, isBold = false) {
                doc.setFontSize(size);
                doc.setFont(undefined, isBold ? 'bold' : 'normal');
                const lines = doc.splitTextToSize(text, 170);
                for (let i = 0; i < lines.length; i++) {
                    if (y > pageHeight - margin) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(lines[i], 20, y);
                    y += lineHeight;
                }
                y += 3;
            }
  
            // Title
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('London 1854: Cholera Committee Preparation', 20, y);
            y += 15;
  
            addText(`Student: ${activityState.studentName}`, 12, true);
            addText(`Section: ${activityState.sectionNumber}`, 12, true);
            addText(`Completed: ${new Date(activityState.timestamp).toLocaleString()}`, 10);
            y += 5;
  
            addText(`ROLE: ${role.name} (${role.faction})`, 14, true);
            y += 5;
  
            addText('CHARACTER UNDERSTANDING', 14, true);
            addText('Q1: How does cholera spread according to your character?', 11, true);
            addText(activityState.characterStudy.q1, 10);
            y += 3;
            
            addText('Q2: What is your character\'s primary objective?', 11, true);
            addText(activityState.characterStudy.q2, 10);
            y += 3;
            
            addText('Q3: What personal experiences inform your perspective?', 11, true);
            addText(activityState.characterStudy.q3, 10);
            y += 5;
  
            addText('YOUR SCIENTIFIC ARGUMENT', 14, true);
            addText('Opening Statement: How cholera spreads', 11, true);
            addText(activityState.argument.theory, 10);
            y += 3;
            
            addText('Evidence and Data', 11, true);
            addText(activityState.argument.evidence, 10);
            y += 3;
            
            addText('Analysis and Interpretation', 11, true);
            addText(activityState.argument.analysis, 10);
            y += 3;
            
            addText('Addressing Opposition', 11, true);
            addText(activityState.argument.opposition, 10);
            y += 5;
  
            addText('YOUR MOTION', 14, true);
            addText(`Title: ${activityState.motion.title}`, 12, true);
            y += 2;
            
            addText('Motion Text:', 11, true);
            addText(activityState.motion.text, 10);
            y += 3;
            
            addText('Justification:', 11, true);
            addText(activityState.motion.justification, 10);
            y += 3;
            
            addText('Expected Outcomes:', 11, true);
            addText(activityState.motion.outcomes, 10);
  
            const fileName = `London1854_${activityState.studentName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
  
            alert('PDF downloaded successfully!');
        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('There was an error generating the PDF. Please make sure all fields are completed.');
        }
    }
  
    window.submitToSupabase = async function() {
        const submitBtn = document.getElementById('submitBtn');
        const messageDiv = document.getElementById('submitMessage');
  
        // Initialize Supabase if it hasn't been initialized yet
        if (!supabaseClient) {
            initSupabase();
        }
        
        // Check if Supabase is available
        if (!supabaseClient) {
            messageDiv.innerHTML = '<div class="warning-banner" style="background-color: #8b0000;">‚ùå Unable to connect to submission system. Please download the PDF and email it to your professor instead.</div>';
            return;
        }
  
        if (!activityState.motion.title) {
            alert('Please complete all sections before submitting.');
            return;
        }
  
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Submitting...';
        messageDiv.innerHTML = '<div class="warning-banner">Generating and uploading your PDF...</div>';
  
        try {
            const pdfBlob = await generatePDFBlob();
  
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const sanitizedName = activityState.studentName.replace(/[^a-zA-Z0-9]/g, '_');
            const fileName = `hist105-london-cholera/${activityState.sectionNumber}/${sanitizedName}_${timestamp}.pdf`;
  
            const { error: uploadError } = await supabaseClient
                .storage
                .from('student-submissions')
                .upload(fileName, pdfBlob, {
                    contentType: 'application/pdf',
                    upsert: false
                });
  
            if (uploadError) {
                throw new Error(`Upload failed: ${uploadError.message}`);
            }
  
            const { data: urlData } = supabaseClient
                .storage
                .from('student-submissions')
                .getPublicUrl(fileName);
  
            await supabaseClient
                .from('worksheet_submissions')
                .insert({
                    student_name: activityState.studentName,
                    section_number: activityState.sectionNumber,
                    worksheet_type: 'hist105-london-cholera',
                    file_path: fileName,
                    file_url: urlData.publicUrl,
                    form_data: activityState,
                    submitted_at: new Date().toISOString()
                });
  
            messageDiv.innerHTML = '<div class="success-banner">‚úÖ Successfully submitted! Your work has been sent to Prof. Hauselmann.</div>';
            submitBtn.textContent = '‚úì Submitted';
            document.getElementById('progress-submit').classList.add('completed');
  
        } catch (error) {
            console.error('Submission error:', error);
            messageDiv.innerHTML = `<div class="warning-banner" style="background-color: #8b0000;">‚ùå Submission failed: ${error.message}. Please try again or download the PDF and email it to your professor.</div>`;
            submitBtn.disabled = false;
            submitBtn.textContent = 'üì§ Submit to Professor';
        }
    }
  
    function generatePDFBlob() {
        return new Promise((resolve) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const role = roleData[activityState.selectedRole];
  
            let y = 20;
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
  
            function addText(text, size = 12, isBold = false) {
                doc.setFontSize(size);
                doc.setFont(undefined, isBold ? 'bold' : 'normal');
                const lines = doc.splitTextToSize(text, 170);
                for (let i = 0; i < lines.length; i++) {
                    if (y > pageHeight - margin) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(lines[i], 20, y);
                    y += lineHeight;
                }
                y += 3;
            }
  
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('London 1854: Cholera Committee Preparation', 20, y);
            y += 15;
  
            addText(`Student: ${activityState.studentName}`, 12, true);
            addText(`Section: ${activityState.sectionNumber}`, 12, true);
            addText(`Completed: ${new Date(activityState.timestamp).toLocaleString()}`, 10);
            y += 5;
  
            addText(`ROLE: ${role.name} (${role.faction})`, 14, true);
            y += 5;
  
            addText('CHARACTER UNDERSTANDING', 14, true);
            addText('Q1: How does cholera spread according to your character?', 11, true);
            addText(activityState.characterStudy.q1, 10);
            y += 3;
            addText('Q2: What is your character\'s primary objective?', 11, true);
            addText(activityState.characterStudy.q2, 10);
            y += 3;
            addText('Q3: What personal experiences inform your perspective?', 11, true);
            addText(activityState.characterStudy.q3, 10);
            y += 5;
  
            addText('YOUR SCIENTIFIC ARGUMENT', 14, true);
            addText('Opening Statement: How cholera spreads', 11, true);
            addText(activityState.argument.theory, 10);
            y += 3;
            addText('Evidence and Data', 11, true);
            addText(activityState.argument.evidence, 10);
            y += 3;
            addText('Analysis and Interpretation', 11, true);
            addText(activityState.argument.analysis, 10);
            y += 3;
            addText('Addressing Opposition', 11, true);
            addText(activityState.argument.opposition, 10);
            y += 5;
  
            addText('YOUR MOTION', 14, true);
            addText(`Title: ${activityState.motion.title}`, 12, true);
            y += 2;
            addText('Motion Text:', 11, true);
            addText(activityState.motion.text, 10);
            y += 3;
            addText('Justification:', 11, true);
            addText(activityState.motion.justification, 10);
            y += 3;
            addText('Expected Outcomes:', 11, true);
            addText(activityState.motion.outcomes, 10);
  
            resolve(doc.output('blob'));
        });
    }
  
    // Save state periodically
    setInterval(() => {
        localStorage.setItem('londonCholeraState', JSON.stringify(activityState));
    }, 30000);
  



</script>

<!-- Load external libraries at the end so they don't block the main functionality -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Initialize Supabase now that the library has loaded
    initSupabase();
</script>

</body>
</html>
