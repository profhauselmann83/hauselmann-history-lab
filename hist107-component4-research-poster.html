<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <title>Component 4: Research Poster | HIST 107 Group Project</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f0;
            color: #333;
            line-height: 1.6;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
        }

        header p {
            margin: 0;
            font-size: 1.1em;
            opacity: 0.9;
        }

        nav {
            background-color: #34495e;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }

        nav a:hover {
            text-decoration: underline;
        }

        .breadcrumb {
            background-color: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .progress-bar {
            background-color: #ecf0f1;
            height: 10px;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #27ae60;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 5px;
        }

        .section {
            background-color: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }

        h3 {
            color: #2c3e50;
            margin-top: 20px;
        }

        .info-box {
            background-color: #e8f4f8;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
            border-radius: 3px;
        }

        .info-box strong {
            color: #2c3e50;
        }

        .warning-box {
            background-color: #fff3cd;
            padding: 20px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
            border-radius: 3px;
        }

        .success-box {
            background-color: #d4edda;
            padding: 20px;
            border-left: 4px solid #27ae60;
            margin: 20px 0;
            border-radius: 3px;
        }

        .example-box {
            background-color: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #6c757d;
            margin: 20px 0;
            border-radius: 3px;
        }

        .poster-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border: 2px solid #dee2e6;
        }

        .poster-section h4 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .poster-icon {
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .form-group select,
        .form-group textarea,
        .form-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 1em;
            font-family: 'Open Sans', sans-serif;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group textarea:focus,
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group textarea.short {
            min-height: 80px;
        }

        .form-group textarea.long {
            min-height: 180px;
        }

        .help-text {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-family: 'Open Sans', sans-serif;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-secondary {
            background-color: #34495e;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2c3e50;
        }

        .alert {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #27ae60;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #e74c3c;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: #7f8c8d;
            padding: 20px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                padding: 20px;
            }

            .section {
                padding: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üìä Component 4: Research Poster</h1>
        <p>HIST 107 Group Project | Conference-Style Poster Planning</p>
    </header>

    <nav>
        <a href="index.html">Home</a>
        <a href="activities.html">Interactive Activities</a>
        <a href="research.html">Research Tools</a>
        <a href="archives.html">Student Archives</a>
        <a href="blog.html">Blog</a>
        <a href="https://profhauselmann.org/bss-ai-types.html">AI & Learning</a>
    </nav>

    <div class="breadcrumb">
        <a href="research-hist107.html">‚Üê Back to HIST 107 Research Guide</a>
    </div>

    <div class="section" style="background-color: #f0f9ff; border-left: 4px solid #3498db;">
        <h2 style="border-bottom-color: #3498db;">Student Information</h2>
        <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="First and last name">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="section-number">Section Number:</label>
                <input type="text" id="section-number" placeholder="e.g., 107-01">
            </div>
        </div>
        <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
                <label for="commodity-name">Your Commodity:</label>
                <input type="text" id="commodity-name" placeholder="e.g., Sugar, Coffee, Rubber">
            </div>
        </div>
        <div class="form-group">
            <label for="group-members">Group Members (list all names, including yourself):</label>
            <textarea id="group-members" style="min-height: 80px;" placeholder="List all group members' names, one per line"></textarea>
            <div class="help-text">Include all 3-4 members of your research group</div>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="section">
        <h2>Instructions</h2>
        <p>For Component 4, your group will present <strong>one conference-style research poster</strong> that synthesizes all of your research and integrates all four analytical lenses.</p>
        
        <div class="info-box">
            <strong>Your poster must include:</strong>
            <ul style="margin: 10px 0;">
                <li>Commodity overview</li>
                <li>Pre-imperial context</li>
                <li>Empire and coercion</li>
                <li>Global capitalism</li>
                <li>Comparison to cotton (Beckert)</li>
                <li>Consequences today</li>
                <li>Central claim (2-3 sentences)</li>
                <li>Selected sources from your archive</li>
            </ul>
        </div>

        <div class="warning-box">
            <strong>‚ö†Ô∏è This is a Planning Worksheet:</strong> Use this page to draft the content for each section of your poster. Your actual poster can be created using PowerPoint, Canva, Google Slides, or a physical poster board. This worksheet helps you organize your ideas before designing the visual layout.
        </div>

        <div class="example-box">
            <strong>üí° Poster Design Tips:</strong>
            <ul style="margin: 10px 0;">
                <li>Use clear headings and subheadings for each section</li>
                <li>Include visuals: maps, photos, charts, or diagrams</li>
                <li>Keep text concise and readable from a distance</li>
                <li>Use bullet points rather than long paragraphs</li>
                <li>Color-code information from different analytical lenses</li>
                <li>Make your central claim prominent and bold</li>
            </ul>
        </div>

        <div class="success-box">
            <strong>Gallery Walk:</strong> This poster will be displayed for a class gallery walk. All group members should be prepared to explain any section of the poster and answer questions!
        </div>
    </div>

    <div id="status-message"></div>

    <!-- POSTER CONTENT SECTIONS -->
    <div class="section">
        <h2>Poster Content Planning</h2>

        <div class="poster-section">
            <h4><span class="poster-icon">üì¶</span> Commodity Overview</h4>
            <div class="form-group">
                <label for="commodity-overview">What is this commodity? Where does it come from? Why is it important?</label>
                <textarea id="commodity-overview" class="long" placeholder="Provide a clear, compelling introduction to your commodity. What makes it historically significant?"></textarea>
                <div class="help-text">This sets up your poster. Keep it engaging and informative - 3-4 sentences.</div>
            </div>
        </div>

        <div class="poster-section">
            <h4><span class="poster-icon">üåæ</span> Pre-Imperial Context</h4>
            <div class="form-group">
                <label for="pre-imperial-context">How was this commodity produced and traded before large-scale imperial involvement?</label>
                <textarea id="pre-imperial-context" placeholder="Describe indigenous production, local trade networks, and how people used this commodity before European expansion..."></textarea>
                <div class="help-text">Show what existed BEFORE the transformation into a global commodity</div>
            </div>
        </div>

        <div class="poster-section">
            <h4><span class="poster-icon">‚öîÔ∏è</span> Empire & Coercion</h4>
            <div class="form-group">
                <label for="empire-coercion">How did empires, states, or corporations take control? What forms of coercion or violence were used?</label>
                <textarea id="empire-coercion" class="long" placeholder="Discuss conquest, colonization, land seizure, labor exploitation, violence, etc. Be specific about who did what to whom..."></textarea>
                <div class="help-text">This is where all four lenses come together: production, labor, imperial power, and circulation</div>
            </div>
        </div>

        <div class="poster-section">
            <h4><span class="poster-icon">üí∞</span> Global Capitalism</h4>
            <div class="form-group">
                <label for="global-capitalism">How did this commodity become part of global capitalist systems?</label>
                <textarea id="global-capitalism" class="long" placeholder="Discuss market integration, financialization, corporate control, global demand, commodity chains, profit extraction..."></textarea>
                <div class="help-text">Connect to themes of capitalism: markets, profit, exploitation, accumulation, commodification</div>
            </div>
        </div>

        <div class="poster-section">
            <h4><span class="poster-icon">üìö</span> Comparison to Cotton (Beckert)</h4>
            <div class="form-group">
                <label for="cotton-comparison">How does your commodity compare to Beckert's analysis of cotton?</label>
                <textarea id="cotton-comparison" placeholder="Draw specific parallels or contrasts to Beckert's arguments about war capitalism, state power, slavery, and global markets..."></textarea>
                <div class="help-text">Reference Beckert's concepts: war capitalism, state involvement, coerced labor, global integration</div>
            </div>
        </div>

        <div class="poster-section">
            <h4><span class="poster-icon">üåç</span> Consequences Today</h4>
            <div class="form-group">
                <label for="consequences-today">What are the lasting consequences of this commodity's history? How does it affect the world today?</label>
                <textarea id="consequences-today" placeholder="Discuss current inequalities, ongoing exploitation, environmental damage, economic structures, cultural impacts..."></textarea>
                <div class="help-text">Connect the past to the present. What legacies remain?</div>
            </div>
        </div>

        <div class="poster-section" style="border: 3px solid #3498db;">
            <h4><span class="poster-icon">üéØ</span> Central Claim (2-3 Sentences)</h4>
            <div class="form-group">
                <label for="central-claim">What is your main argument? What should viewers understand about this commodity?</label>
                <textarea id="central-claim" class="short" placeholder="Write a clear, concise thesis statement that captures your main argument about how this commodity reveals capitalism, empire, and globalization..."></textarea>
                <div class="help-text">This is the MOST IMPORTANT part. Make it bold and prominent on your poster!</div>
            </div>
        </div>

        <div class="poster-section">
            <h4><span class="poster-icon">üìë</span> Selected Sources</h4>
            <div class="form-group">
                <label for="selected-sources">Which sources from your archive will you highlight on the poster? (3-5 key sources)</label>
                <textarea id="selected-sources" placeholder="List 3-5 of your most important sources with brief citations. Choose sources that represent all four lenses..."></textarea>
                <div class="help-text">These should be your strongest, most illustrative sources. Include citations!</div>
            </div>
        </div>

        <div class="poster-section">
            <h4><span class="poster-icon">üé®</span> Visual Design Notes</h4>
            <div class="form-group">
                <label for="visual-notes">What visuals, images, maps, or graphics will you include?</label>
                <textarea id="visual-notes" placeholder="Describe photos, maps, charts, diagrams, or other visual elements. How will you organize the poster layout?"></textarea>
                <div class="help-text">Think about: historical photos, trade route maps, production data charts, timeline graphics, etc.</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="button-group">
            <button class="btn btn-success" onclick="saveWork()">üíæ Save Planning Work</button>
            <button class="btn btn-secondary" onclick="exportWork()">üìÑ Export as PDF</button>
            <button class="btn btn-secondary" onclick="exportText()">üìÑ Export as Text File</button>
            <button class="btn btn-primary" onclick="submitToSupabase()" id="submitBtn">üì§ Submit to Professor</button>
        </div>
        <div id="submitMessage"></div>
    </div>

    <footer>
        <p>Prof. Hauselmann | profhauselmann.org</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://bqrluqymscucvbiaaeai.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcmx1cXltc2N1Y3ZiaWFhZWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njg4MTMsImV4cCI6MjA4NDI0NDgxM30.AVOjnQe_TDoWydE2wDP1_YftU1lBkYxcPuyQeZb8Nfs'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        const SUBMISSION_CUTOFF = null

        let currentUser = null

        async function checkAuth() {
            const userStr = localStorage.getItem('student_user')
            if (userStr) {
                currentUser = JSON.parse(userStr)
            }

            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('input', updateProgress)
                element.addEventListener('change', updateProgress)
            })

            await loadWork()
            updateProgress()
        }

        function updateProgress() {
            const total = 12
            let completed = 0

            if (document.getElementById('student-name').value.trim().length > 0) completed++
            if (document.getElementById('section-number').value.trim().length > 0) completed++
            if (document.getElementById('commodity-name').value.trim().length > 0) completed++
            if (document.getElementById('group-members').value.trim().length > 0) completed++

            if (document.getElementById('commodity-overview').value.length > 20) completed++
            if (document.getElementById('pre-imperial-context').value.length > 20) completed++
            if (document.getElementById('empire-coercion').value.length > 20) completed++
            if (document.getElementById('global-capitalism').value.length > 20) completed++
            if (document.getElementById('cotton-comparison').value.length > 20) completed++
            if (document.getElementById('consequences-today').value.length > 20) completed++
            if (document.getElementById('central-claim').value.length > 20) completed++
            if (document.getElementById('selected-sources').value.length > 20) completed++

            const percentage = (completed / total) * 100
            document.getElementById('progressFill').style.width = percentage + '%'
        }

        async function saveWork(silent = false) {
            const data = {
                student_name: document.getElementById('student-name').value,
                section_number: document.getElementById('section-number').value,
                commodity_name: document.getElementById('commodity-name').value,
                group_members: document.getElementById('group-members').value,
                commodity_overview: document.getElementById('commodity-overview').value,
                pre_imperial_context: document.getElementById('pre-imperial-context').value,
                empire_coercion: document.getElementById('empire-coercion').value,
                global_capitalism: document.getElementById('global-capitalism').value,
                cotton_comparison: document.getElementById('cotton-comparison').value,
                consequences_today: document.getElementById('consequences-today').value,
                central_claim: document.getElementById('central-claim').value,
                selected_sources: document.getElementById('selected-sources').value,
                visual_notes: document.getElementById('visual-notes').value
            }

            if (!currentUser) {
                localStorage.setItem('hist107_research_poster', JSON.stringify(data))
                if (!silent) {
                    showMessage('‚úÖ Progress saved locally in this browser.', 'success')
                }
                return
            }

            const { error } = await supabaseClient
                .from('hist107_research_poster')
                .upsert({ ...data, user_id: currentUser.id }, { onConflict: 'user_id' })

            if (!silent) {
                if (error) {
                    showMessage('Error saving: ' + error.message, 'error')
                } else {
                    showMessage('‚úÖ Progress saved successfully!', 'success')
                }
            }
        }

        async function loadWork() {
            if (!currentUser) {
                const saved = localStorage.getItem('hist107_research_poster')
                if (!saved) return
                const data = JSON.parse(saved)

                document.getElementById('student-name').value = data.student_name || ''
                document.getElementById('section-number').value = data.section_number || ''
                document.getElementById('commodity-name').value = data.commodity_name || ''
                document.getElementById('group-members').value = data.group_members || ''
                document.getElementById('commodity-overview').value = data.commodity_overview || ''
                document.getElementById('pre-imperial-context').value = data.pre_imperial_context || ''
                document.getElementById('empire-coercion').value = data.empire_coercion || ''
                document.getElementById('global-capitalism').value = data.global_capitalism || ''
                document.getElementById('cotton-comparison').value = data.cotton_comparison || ''
                document.getElementById('consequences-today').value = data.consequences_today || ''
                document.getElementById('central-claim').value = data.central_claim || ''
                document.getElementById('selected-sources').value = data.selected_sources || ''
                document.getElementById('visual-notes').value = data.visual_notes || ''
                return
            }

            const { data, error } = await supabaseClient
                .from('hist107_research_poster')
                .select('*')
                .eq('user_id', currentUser.id)
                .single()

            if (error || !data) return

            document.getElementById('student-name').value = data.student_name || ''
            document.getElementById('section-number').value = data.section_number || ''
            document.getElementById('commodity-name').value = data.commodity_name || ''
            document.getElementById('group-members').value = data.group_members || ''
            document.getElementById('commodity-overview').value = data.commodity_overview || ''
            document.getElementById('pre-imperial-context').value = data.pre_imperial_context || ''
            document.getElementById('empire-coercion').value = data.empire_coercion || ''
            document.getElementById('global-capitalism').value = data.global_capitalism || ''
            document.getElementById('cotton-comparison').value = data.cotton_comparison || ''
            document.getElementById('consequences-today').value = data.consequences_today || ''
            document.getElementById('central-claim').value = data.central_claim || ''
            document.getElementById('selected-sources').value = data.selected_sources || ''
            document.getElementById('visual-notes').value = data.visual_notes || ''
        }

        function exportWork() {
            const { jsPDF } = window.jspdf
            const doc = new jsPDF()

            const lineHeight = 7
            const pageWidth = 190
            const pageHeight = 280
            let y = 20

            function checkPageOverflow(neededSpace) {
                if (y + neededSpace > pageHeight) {
                    doc.addPage()
                    y = 20
                }
            }

            function addWrappedText(text, x, maxWidth) {
                const lines = doc.splitTextToSize(text, maxWidth)
                lines.forEach((line) => {
                    if (y + lineHeight > pageHeight) {
                        doc.addPage()
                        y = 20
                    }
                    doc.text(line, x, y)
                    y += lineHeight
                })
            }

            doc.setFontSize(16)
            doc.setFont(undefined, 'bold')
            doc.text('HIST 107 Component 4: Research Poster Planning', 105, y, { align: 'center' })
            y += 10

            doc.setFontSize(12)
            doc.setFont(undefined, 'normal')
            doc.text('Conference-Style Poster Content', 105, y, { align: 'center' })
            y += 15

            doc.setFontSize(10)
            const studentName = document.getElementById('student-name').value
            const sectionNumber = document.getElementById('section-number').value
            const commodity = document.getElementById('commodity-name').value

            if (studentName) {
                doc.text(`Student: ${studentName}`, 20, y)
                y += 8
            }
            if (sectionNumber) {
                doc.text(`Section: ${sectionNumber}`, 20, y)
                y += 8
            }
            if (commodity) {
                doc.text(`Commodity: ${commodity}`, 20, y)
                y += 8
            }

            const groupMembers = document.getElementById('group-members').value
            if (groupMembers) {
                doc.text('Group Members:', 20, y)
                y += 7
                addWrappedText(groupMembers, 25, pageWidth - 25)
                y += 5
            }

            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y)
            y += 15

            const sections = [
                { icon: 'üì¶', title: 'Commodity Overview', field: 'commodity-overview' },
                { icon: 'üåæ', title: 'Pre-Imperial Context', field: 'pre-imperial-context' },
                { icon: '‚öîÔ∏è', title: 'Empire & Coercion', field: 'empire-coercion' },
                { icon: 'üí∞', title: 'Global Capitalism', field: 'global-capitalism' },
                { icon: 'üìö', title: 'Comparison to Cotton (Beckert)', field: 'cotton-comparison' },
                { icon: 'üåç', title: 'Consequences Today', field: 'consequences-today' },
                { icon: 'üéØ', title: 'CENTRAL CLAIM', field: 'central-claim' },
                { icon: 'üìë', title: 'Selected Sources', field: 'selected-sources' },
                { icon: 'üé®', title: 'Visual Design Notes', field: 'visual-notes' }
            ]

            sections.forEach(section => {
                checkPageOverflow(15)
                doc.setFontSize(12)
                doc.setFont(undefined, 'bold')
                doc.text(`${section.icon} ${section.title}`, 20, y)
                y += 10

                doc.setFontSize(10)
                doc.setFont(undefined, 'normal')
                const content = document.getElementById(section.field).value
                addWrappedText(content || '[Not completed]', 25, pageWidth - 25)
                y += 10
            })

            doc.save(`HIST107_Research_Poster_Planning_${studentName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`)

            showMessage('PDF exported successfully!', 'success')
        }

        function exportText() {
            let text = 'HIST 107 Component 4: Research Poster Planning\n'
            text += 'Conference-Style Poster Content\n'
            text += '='.repeat(60) + '\n\n'
            text += `Student Name: ${document.getElementById('student-name').value}\n`
            text += `Section Number: ${document.getElementById('section-number').value}\n`
            text += `Commodity: ${document.getElementById('commodity-name').value}\n`
            text += `Group Members:\n${document.getElementById('group-members').value}\n`
            text += `Date: ${new Date().toLocaleDateString()}\n\n`

            text += 'POSTER CONTENT\n'
            text += '='.repeat(60) + '\n\n'
            
            text += 'üì¶ COMMODITY OVERVIEW\n'
            text += document.getElementById('commodity-overview').value + '\n\n'
            
            text += 'üåæ PRE-IMPERIAL CONTEXT\n'
            text += document.getElementById('pre-imperial-context').value + '\n\n'
            
            text += '‚öîÔ∏è EMPIRE & COERCION\n'
            text += document.getElementById('empire-coercion').value + '\n\n'
            
            text += 'üí∞ GLOBAL CAPITALISM\n'
            text += document.getElementById('global-capitalism').value + '\n\n'
            
            text += 'üìö COMPARISON TO COTTON (BECKERT)\n'
            text += document.getElementById('cotton-comparison').value + '\n\n'
            
            text += 'üåç CONSEQUENCES TODAY\n'
            text += document.getElementById('consequences-today').value + '\n\n'
            
            text += 'üéØ CENTRAL CLAIM\n'
            text += document.getElementById('central-claim').value + '\n\n'
            
            text += 'üìë SELECTED SOURCES\n'
            text += document.getElementById('selected-sources').value + '\n\n'
            
            text += 'üé® VISUAL DESIGN NOTES\n'
            text += document.getElementById('visual-notes').value + '\n'

            const blob = new Blob([text], { type: 'text/plain' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `HIST107_Research_Poster_Planning_${document.getElementById('student-name').value.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
            URL.revokeObjectURL(url)

            showMessage('Text file exported successfully!', 'success')
        }

        function showMessage(message, type) {
            const msgDiv = document.getElementById('status-message')
            msgDiv.innerHTML = type === 'success'
                ? `<div class="alert alert-success">${message}</div>`
                : `<div class="alert alert-error">${message}</div>`
        }

        async function submitToSupabase() {
            if (SUBMISSION_CUTOFF) {
                const cutoffDate = new Date(SUBMISSION_CUTOFF)
                const now = new Date()
                if (now > cutoffDate) {
                    alert('The submission deadline has passed. Please contact your professor if you need an extension.')
                    return
                }
            }

            const studentName = document.getElementById('student-name').value.trim()
            const sectionNumber = document.getElementById('section-number').value.trim()

            if (!studentName) {
                alert('Please enter your name before submitting.')
                document.getElementById('student-name').focus()
                return
            }

            if (!sectionNumber) {
                alert('Please enter your section number before submitting.')
                document.getElementById('section-number').focus()
                return
            }

            const submitBtn = document.getElementById('submitBtn')
            const messageDiv = document.getElementById('submitMessage')

            submitBtn.disabled = true
            submitBtn.textContent = '‚è≥ Submitting...'
            messageDiv.innerHTML = '<div class="alert" style="background-color: #fff3cd; color: #856404; border-left: 4px solid #ffc107;">Generating and uploading your work...</div>'

            try {
                const pdfBlob = await generatePDFBlob()

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-')
                const sanitizedName = studentName.replace(/[^a-zA-Z0-9]/g, '_')
                const commodity = document.getElementById('commodity-name').value.replace(/[^a-zA-Z0-9]/g, '_') || 'commodity'
                const fileName = `hist107-research-poster/${sectionNumber}/${sanitizedName}_${commodity}_${timestamp}.pdf`

                const { data: uploadData, error: uploadError } = await supabaseClient
                    .storage
                    .from('student-submissions')
                    .upload(fileName, pdfBlob, {
                        contentType: 'application/pdf',
                        upsert: false
                    })

                if (uploadError) {
                    throw new Error(`Upload failed: ${uploadError.message}`)
                }

                const { data: urlData } = supabaseClient
                    .storage
                    .from('student-submissions')
                    .getPublicUrl(fileName)

                const formData = {
                    commodity_name: document.getElementById('commodity-name').value,
                    group_members: document.getElementById('group-members').value,
                    central_claim: document.getElementById('central-claim').value,
                    commodity_overview: document.getElementById('commodity-overview').value
                }

                const { error: dbError } = await supabaseClient
                    .from('worksheet_submissions')
                    .insert({
                        student_name: studentName,
                        section_number: sectionNumber,
                        worksheet_type: 'hist107-research-poster',
                        file_path: fileName,
                        file_url: urlData.publicUrl,
                        form_data: formData,
                        submitted_at: new Date().toISOString()
                    })

                if (dbError) {
                    console.warn('Metadata save warning:', dbError.message)
                }

                messageDiv.innerHTML = '<div class="alert alert-success">‚úÖ Successfully submitted! Your research poster planning has been sent to Prof. Hauselmann.</div>'
                submitBtn.textContent = '‚úì Submitted'

            } catch (error) {
                console.error('Submission error:', error)
                messageDiv.innerHTML = `<div class="alert alert-error">‚ùå Submission failed: ${error.message}. Please try again or export the PDF and email it to your professor.</div>`
                submitBtn.disabled = false
                submitBtn.textContent = 'üì§ Submit to Professor'
            }
        }

        function generatePDFBlob() {
            return new Promise((resolve) => {
                const { jsPDF } = window.jspdf
                const doc = new jsPDF()

                const lineHeight = 7
                const pageWidth = 190
                const pageHeight = 280
                let y = 20

                function checkPageOverflow(neededSpace) {
                    if (y + neededSpace > pageHeight) {
                        doc.addPage()
                        y = 20
                    }
                }

                function addWrappedText(text, x, maxWidth) {
                    const lines = doc.splitTextToSize(text, maxWidth)
                    lines.forEach((line) => {
                        if (y + lineHeight > pageHeight) {
                            doc.addPage()
                            y = 20
                        }
                        doc.text(line, x, y)
                        y += lineHeight
                    })
                }

                doc.setFontSize(16)
                doc.setFont(undefined, 'bold')
                doc.text('HIST 107 Component 4: Research Poster Planning', 105, y, { align: 'center' })
                y += 10

                doc.setFontSize(12)
                doc.setFont(undefined, 'normal')
                doc.text('Conference-Style Poster Content', 105, y, { align: 'center' })
                y += 15

                doc.setFontSize(10)
                const studentName = document.getElementById('student-name').value
                const sectionNumber = document.getElementById('section-number').value
                const commodity = document.getElementById('commodity-name').value

                if (studentName) {
                    doc.text(`Student: ${studentName}`, 20, y)
                    y += 8
                }
                if (sectionNumber) {
                    doc.text(`Section: ${sectionNumber}`, 20, y)
                    y += 8
                }
                if (commodity) {
                    doc.text(`Commodity: ${commodity}`, 20, y)
                    y += 8
                }

                const groupMembers = document.getElementById('group-members').value
                if (groupMembers) {
                    doc.text('Group Members:', 20, y)
                    y += 7
                    addWrappedText(groupMembers, 25, pageWidth - 25)
                    y += 5
                }

                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y)
                y += 15

                const sections = [
                    { icon: 'üì¶', title: 'Commodity Overview', field: 'commodity-overview' },
                    { icon: 'üåæ', title: 'Pre-Imperial Context', field: 'pre-imperial-context' },
                    { icon: '‚öîÔ∏è', title: 'Empire & Coercion', field: 'empire-coercion' },
                    { icon: 'üí∞', title: 'Global Capitalism', field: 'global-capitalism' },
                    { icon: 'üìö', title: 'Comparison to Cotton (Beckert)', field: 'cotton-comparison' },
                    { icon: 'üåç', title: 'Consequences Today', field: 'consequences-today' },
                    { icon: 'üéØ', title: 'CENTRAL CLAIM', field: 'central-claim' },
                    { icon: 'üìë', title: 'Selected Sources', field: 'selected-sources' },
                    { icon: 'üé®', title: 'Visual Design Notes', field: 'visual-notes' }
                ]

                sections.forEach(section => {
                    checkPageOverflow(15)
                    doc.setFontSize(12)
                    doc.setFont(undefined, 'bold')
                    doc.text(`${section.icon} ${section.title}`, 20, y)
                    y += 10

                    doc.setFontSize(10)
                    doc.setFont(undefined, 'normal')
                    const content = document.getElementById(section.field).value
                    addWrappedText(content || '[Not completed]', 25, pageWidth - 25)
                    y += 10
                })

                resolve(doc.output('blob'))
            })
        }

        checkAuth()
    </script>
</body>
</html>
