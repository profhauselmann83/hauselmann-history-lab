<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <title>Component 1: Curated Mini-Archive | HIST 107 Group Project</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f0;
            color: #333;
            line-height: 1.6;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
        }

        header p {
            margin: 0;
            font-size: 1.1em;
            opacity: 0.9;
        }

        nav {
            background-color: #34495e;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }

        nav a:hover {
            text-decoration: underline;
        }

        .breadcrumb {
            background-color: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .progress-bar {
            background-color: #ecf0f1;
            height: 10px;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #27ae60;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 5px;
        }

        .section {
            background-color: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }

        h3 {
            color: #2c3e50;
            margin-top: 20px;
        }

        .info-box {
            background-color: #e8f4f8;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
            border-radius: 3px;
        }

        .info-box strong {
            color: #2c3e50;
        }

        .warning-box {
            background-color: #fff3cd;
            padding: 20px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
            border-radius: 3px;
        }

        .success-box {
            background-color: #d4edda;
            padding: 20px;
            border-left: 4px solid #27ae60;
            margin: 20px 0;
            border-radius: 3px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .form-group select,
        .form-group textarea,
        .form-group input[type="text"],
        .form-group input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 1em;
            font-family: 'Open Sans', sans-serif;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group textarea:focus,
        .form-group input[type="text"]:focus,
        .form-group input[type="url"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group textarea.short {
            min-height: 80px;
        }

        .help-text {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .source-card {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .source-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .source-number {
            background-color: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .delete-source {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
        }

        .delete-source:hover {
            background-color: #c0392b;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-family: 'Open Sans', sans-serif;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-secondary {
            background-color: #34495e;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2c3e50;
        }

        .btn-add {
            background-color: #16a085;
            color: white;
        }

        .btn-add:hover {
            background-color: #138d75;
        }

        .btn-view {
            background-color: #9b59b6;
            color: white;
        }

        .btn-view:hover {
            background-color: #8e44ad;
        }

        .alert {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #27ae60;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #e74c3c;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 5px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        .class-source {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            border-radius: 3px;
        }

        .class-source h5 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .class-source p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .class-source .meta {
            font-size: 0.85em;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 10px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: #7f8c8d;
            padding: 20px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                padding: 20px;
            }

            .section {
                padding: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                text-align: center;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üìö Component 1: Curated Mini-Archive</h1>
        <p>HIST 107 Group Project | Individual Source Contributions</p>
    </header>

    <nav>
        <a href="index.html">Home</a>
        <a href="activities.html">Interactive Activities</a>
        <a href="research.html">Research Tools</a>
        <a href="archives.html">Student Archives</a>
        <a href="blog.html">Blog</a>
    </nav>

    <div class="breadcrumb">
        <a href="research-hist107.html">‚Üê Back to HIST 107 Research Guide</a>
    </div>

    <div class="section" style="background-color: #f0f9ff; border-left: 4px solid #3498db;">
        <h2 style="border-bottom-color: #3498db;">Student Information</h2>
        <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="First and last name">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="section-number">Section Number:</label>
                <input type="text" id="section-number" placeholder="e.g., 107-01">
            </div>
        </div>
        <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
                <label for="commodity-name">Your Commodity:</label>
                <input type="text" id="commodity-name" placeholder="e.g., Sugar, Coffee, Rubber">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="analytical-lens">Your Analytical Lens:</label>
                <select id="analytical-lens">
                    <option value="">-- Select your lens --</option>
                    <option value="Production & Environment">Production & Environment</option>
                    <option value="Labor & Coercion">Labor & Coercion</option>
                    <option value="Empire, State & Corporations">Empire, State & Corporations</option>
                    <option value="Circulation & Consumption">Circulation & Consumption</option>
                </select>
            </div>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="section">
        <h2>Instructions</h2>
        <p>For Component 1, you must contribute <strong>3-4 sources</strong> connected to your assigned analytical lens. These sources will be part of your group's combined archive of 12-16 total sources.</p>
        
        <div class="info-box">
            <strong>Your Responsibilities:</strong>
            <ul style="margin: 10px 0;">
                <li>Find 3-4 high-quality primary or secondary sources related to your lens</li>
                <li>Provide full annotations for each source</li>
                <li>Include proper Turabian-style citations</li>
                <li>Explain what each source reveals and what it cannot tell us</li>
            </ul>
        </div>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Quality Over Quantity:</strong> You are graded on the quality of selection and explanation, not just finding sources. Choose sources that genuinely help answer historical questions related to your lens.
        </div>
    </div>

    <div id="status-message"></div>

    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; border: none;">Your Sources</h2>
            <div>
                <button class="btn btn-add" onclick="addSource()" id="addSourceBtn">+ Add Source</button>
                <button class="btn btn-view" onclick="viewClassArchive()">üëÅÔ∏è View Class Archive</button>
            </div>
        </div>

        <div id="sources-container">
            <!-- Sources will be added here dynamically -->
        </div>

        <div id="no-sources-message" style="text-align: center; color: #7f8c8d; padding: 40px;">
            <p style="font-size: 1.2em;">No sources added yet.</p>
            <p>Click "Add Source" to begin building your mini-archive.</p>
        </div>
    </div>

    <div class="section">
        <div class="button-group">
            <button class="btn btn-success" onclick="saveWork()">üíæ Save All Work</button>
            <button class="btn btn-secondary" onclick="exportWork()">üìÑ Export as PDF</button>
            <button class="btn btn-secondary" onclick="exportText()">üìÑ Export as Text File</button>
            <button class="btn btn-primary" onclick="submitToSupabase()" id="submitBtn">üì§ Submit to Professor</button>
        </div>
        <div id="submitMessage"></div>
    </div>

    <!-- Modal for viewing class archive -->
    <div id="classArchiveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Class Archive: All Submissions</h2>
            <div id="class-archive-content">
                <p style="text-align: center; color: #7f8c8d;">Loading...</p>
            </div>
        </div>
    </div>

    <footer>
        <p>Prof. Hauselmann | profhauselmann.org</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://bqrluqymscucvbiaaeai.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcmx1cXltc2N1Y3ZiaWFhZWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njg4MTMsImV4cCI6MjA4NDI0NDgxM30.AVOjnQe_TDoWydE2wDP1_YftU1lBkYxcPuyQeZb8Nfs'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        const SUBMISSION_CUTOFF = null

        let currentUser = null
        let sources = []
        let sourceIdCounter = 1

        async function checkAuth() {
            const userStr = localStorage.getItem('student_user')
            if (userStr) {
                currentUser = JSON.parse(userStr)
            }

            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('input', updateProgress)
                element.addEventListener('change', updateProgress)
            })

            await loadWork()
            updateProgress()
            renderSources()
        }

        function addSource() {
            const source = {
                id: sourceIdCounter++,
                citation: '',
                source_type: '',
                producer: '',
                date_produced: '',
                historical_question: '',
                limitations: '',
                question_raised: '',
                url: ''
            }
            sources.push(source)
            renderSources()
            updateProgress()

            // Check if we've reached the maximum
            if (sources.length >= 4) {
                document.getElementById('addSourceBtn').disabled = true
                document.getElementById('addSourceBtn').style.opacity = '0.5'
                document.getElementById('addSourceBtn').style.cursor = 'not-allowed'
            }
        }

        function deleteSource(id) {
            if (confirm('Are you sure you want to delete this source? This cannot be undone.')) {
                sources = sources.filter(s => s.id !== id)
                renderSources()
                updateProgress()

                // Re-enable add button if we're under 4
                if (sources.length < 4) {
                    document.getElementById('addSourceBtn').disabled = false
                    document.getElementById('addSourceBtn').style.opacity = '1'
                    document.getElementById('addSourceBtn').style.cursor = 'pointer'
                }
            }
        }

        function renderSources() {
            const container = document.getElementById('sources-container')
            const noSourcesMsg = document.getElementById('no-sources-message')

            if (sources.length === 0) {
                container.innerHTML = ''
                noSourcesMsg.style.display = 'block'
                return
            }

            noSourcesMsg.style.display = 'none'

            container.innerHTML = sources.map((source, index) => `
                <div class="source-card">
                    <h4>
                        <span><span class="source-number">Source ${index + 1}</span></span>
                        <button class="delete-source" onclick="deleteSource(${source.id})">üóëÔ∏è Delete</button>
                    </h4>

                    <div class="form-group">
                        <label>Full Citation (Turabian Style):</label>
                        <textarea class="short" data-source-id="${source.id}" data-field="citation" placeholder="Author Last Name, First Name. Title of Work. Place of Publication: Publisher, Year.">${source.citation}</textarea>
                        <div class="help-text">Include all bibliographic information in proper Turabian format</div>
                    </div>

                    <div class="form-group">
                        <label>Source Type:</label>
                        <select data-source-id="${source.id}" data-field="source_type">
                            <option value="">-- Select type --</option>
                            <option value="Primary: Government Document" ${source.source_type === 'Primary: Government Document' ? 'selected' : ''}>Primary: Government Document</option>
                            <option value="Primary: Plantation/Corporate Records" ${source.source_type === 'Primary: Plantation/Corporate Records' ? 'selected' : ''}>Primary: Plantation/Corporate Records</option>
                            <option value="Primary: Personal Account/Letter" ${source.source_type === 'Primary: Personal Account/Letter' ? 'selected' : ''}>Primary: Personal Account/Letter</option>
                            <option value="Primary: Trade Ledger/Invoice" ${source.source_type === 'Primary: Trade Ledger/Invoice' ? 'selected' : ''}>Primary: Trade Ledger/Invoice</option>
                            <option value="Primary: Map" ${source.source_type === 'Primary: Map' ? 'selected' : ''}>Primary: Map</option>
                            <option value="Primary: Photograph" ${source.source_type === 'Primary: Photograph' ? 'selected' : ''}>Primary: Photograph</option>
                            <option value="Primary: Newspaper Article" ${source.source_type === 'Primary: Newspaper Article' ? 'selected' : ''}>Primary: Newspaper Article</option>
                            <option value="Primary: Advertisement" ${source.source_type === 'Primary: Advertisement' ? 'selected' : ''}>Primary: Advertisement</option>
                            <option value="Secondary: Scholarly Book" ${source.source_type === 'Secondary: Scholarly Book' ? 'selected' : ''}>Secondary: Scholarly Book</option>
                            <option value="Secondary: Journal Article" ${source.source_type === 'Secondary: Journal Article' ? 'selected' : ''}>Secondary: Journal Article</option>
                            <option value="Secondary: Documentary/Film" ${source.source_type === 'Secondary: Documentary/Film' ? 'selected' : ''}>Secondary: Documentary/Film</option>
                            <option value="Other" ${source.source_type === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Who produced this source and when?</label>
                        <textarea class="short" data-source-id="${source.id}" data-field="producer" placeholder="Identify the creator/author, their position/affiliation, and the date of creation...">${source.producer}</textarea>
                    </div>

                    <div class="form-group">
                        <label>What historical question does this source help answer?</label>
                        <textarea data-source-id="${source.id}" data-field="historical_question" placeholder="Be specific about what this source reveals related to your analytical lens...">${source.historical_question}</textarea>
                        <div class="help-text">Connect this to your lens: Production & Environment, Labor & Coercion, Empire/State/Corporations, or Circulation & Consumption</div>
                    </div>

                    <div class="form-group">
                        <label>What can this source NOT tell us? What are its limitations?</label>
                        <textarea data-source-id="${source.id}" data-field="limitations" placeholder="Consider perspective, bias, missing voices, what's left out...">${source.limitations}</textarea>
                    </div>

                    <div class="form-group">
                        <label>What question does this source raise for further research?</label>
                        <textarea class="short" data-source-id="${source.id}" data-field="question_raised" placeholder="What new questions emerge from this source?">${source.question_raised}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Source URL (if applicable):</label>
                        <input type="url" data-source-id="${source.id}" data-field="url" placeholder="https://" value="${source.url}">
                        <div class="help-text">Include a link if this source is available online</div>
                    </div>
                </div>
            `).join('')

            // Add event listeners to all inputs
            container.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('input', function() {
                    const sourceId = parseInt(this.dataset.sourceId)
                    const field = this.dataset.field
                    const source = sources.find(s => s.id === sourceId)
                    if (source) {
                        source[field] = this.value
                        updateProgress()
                    }
                })
                element.addEventListener('change', function() {
                    const sourceId = parseInt(this.dataset.sourceId)
                    const field = this.dataset.field
                    const source = sources.find(s => s.id === sourceId)
                    if (source) {
                        source[field] = this.value
                        updateProgress()
                    }
                })
            })
        }

        function updateProgress() {
            const baseFields = 4 // student name, section, commodity, lens
            let baseCompleted = 0

            if (document.getElementById('student-name').value.trim().length > 0) baseCompleted++
            if (document.getElementById('section-number').value.trim().length > 0) baseCompleted++
            if (document.getElementById('commodity-name').value.trim().length > 0) baseCompleted++
            if (document.getElementById('analytical-lens').value.length > 0) baseCompleted++

            // Count completed sources (at least 3 sources with all required fields)
            const requiredSources = 3
            const completedSources = sources.filter(s => {
                return s.citation.length > 10 &&
                       s.source_type.length > 0 &&
                       s.producer.length > 10 &&
                       s.historical_question.length > 20 &&
                       s.limitations.length > 20 &&
                       s.question_raised.length > 10
            }).length

            const totalRequired = baseFields + (requiredSources * 6) // 6 required fields per source
            const totalCompleted = baseCompleted + (completedSources * 6)

            const percentage = Math.min((totalCompleted / totalRequired) * 100, 100)
            document.getElementById('progressFill').style.width = percentage + '%'
        }

        async function saveWork(silent = false) {
            const data = {
                student_name: document.getElementById('student-name').value,
                section_number: document.getElementById('section-number').value,
                commodity_name: document.getElementById('commodity-name').value,
                analytical_lens: document.getElementById('analytical-lens').value,
                sources: sources
            }

            if (!currentUser) {
                localStorage.setItem('hist107_mini_archive', JSON.stringify(data))
                if (!silent) {
                    showMessage('‚úÖ Progress saved locally in this browser.', 'success')
                }
                return
            }

            const { error } = await supabaseClient
                .from('hist107_mini_archive')
                .upsert({ ...data, user_id: currentUser.id }, { onConflict: 'user_id' })

            if (!silent) {
                if (error) {
                    showMessage('Error saving: ' + error.message, 'error')
                } else {
                    showMessage('‚úÖ Progress saved successfully!', 'success')
                }
            }
        }

        async function loadWork() {
            if (!currentUser) {
                const saved = localStorage.getItem('hist107_mini_archive')
                if (!saved) return
                const data = JSON.parse(saved)

                document.getElementById('student-name').value = data.student_name || ''
                document.getElementById('section-number').value = data.section_number || ''
                document.getElementById('commodity-name').value = data.commodity_name || ''
                document.getElementById('analytical-lens').value = data.analytical_lens || ''
                
                if (data.sources && data.sources.length > 0) {
                    sources = data.sources
                    sourceIdCounter = Math.max(...sources.map(s => s.id)) + 1
                }
                return
            }

            const { data, error } = await supabaseClient
                .from('hist107_mini_archive')
                .select('*')
                .eq('user_id', currentUser.id)
                .single()

            if (error || !data) return

            document.getElementById('student-name').value = data.student_name || ''
            document.getElementById('section-number').value = data.section_number || ''
            document.getElementById('commodity-name').value = data.commodity_name || ''
            document.getElementById('analytical-lens').value = data.analytical_lens || ''
            
            if (data.sources && data.sources.length > 0) {
                sources = data.sources
                sourceIdCounter = Math.max(...sources.map(s => s.id)) + 1
            }
        }

        function exportWork() {
            const { jsPDF } = window.jspdf
            const doc = new jsPDF()

            const lineHeight = 7
            const pageWidth = 190
            const pageHeight = 280
            let y = 20

            function checkPageOverflow(neededSpace) {
                if (y + neededSpace > pageHeight) {
                    doc.addPage()
                    y = 20
                }
            }

            function addWrappedText(text, x, maxWidth) {
                const lines = doc.splitTextToSize(text, maxWidth)
                lines.forEach((line) => {
                    if (y + lineHeight > pageHeight) {
                        doc.addPage()
                        y = 20
                    }
                    doc.text(line, x, y)
                    y += lineHeight
                })
            }

            doc.setFontSize(16)
            doc.setFont(undefined, 'bold')
            doc.text('HIST 107 Component 1: Curated Mini-Archive', 105, y, { align: 'center' })
            y += 10

            doc.setFontSize(12)
            doc.setFont(undefined, 'normal')
            doc.text('Individual Source Contributions', 105, y, { align: 'center' })
            y += 15

            doc.setFontSize(10)
            const studentName = document.getElementById('student-name').value
            const sectionNumber = document.getElementById('section-number').value
            const commodity = document.getElementById('commodity-name').value
            const lens = document.getElementById('analytical-lens').value

            if (studentName) {
                doc.text(`Student: ${studentName}`, 20, y)
                y += 8
            }
            if (sectionNumber) {
                doc.text(`Section: ${sectionNumber}`, 20, y)
                y += 8
            }
            if (commodity) {
                doc.text(`Commodity: ${commodity}`, 20, y)
                y += 8
            }
            if (lens) {
                doc.text(`Analytical Lens: ${lens}`, 20, y)
                y += 8
            }
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y)
            y += 15

            sources.forEach((source, index) => {
                checkPageOverflow(30)
                doc.setFontSize(12)
                doc.setFont(undefined, 'bold')
                doc.text(`Source ${index + 1}`, 20, y)
                y += 10

                doc.setFontSize(10)
                doc.setFont(undefined, 'normal')

                doc.text('Citation:', 20, y)
                y += 7
                addWrappedText(source.citation || '[Not provided]', 25, pageWidth - 25)
                y += 5

                doc.text(`Type: ${source.source_type || '[Not specified]'}`, 20, y)
                y += 10

                doc.text('Producer & Date:', 20, y)
                y += 7
                addWrappedText(source.producer || '[Not provided]', 25, pageWidth - 25)
                y += 5

                doc.text('Historical Question Addressed:', 20, y)
                y += 7
                addWrappedText(source.historical_question || '[Not provided]', 25, pageWidth - 25)
                y += 5

                doc.text('Limitations:', 20, y)
                y += 7
                addWrappedText(source.limitations || '[Not provided]', 25, pageWidth - 25)
                y += 5

                doc.text('Question Raised:', 20, y)
                y += 7
                addWrappedText(source.question_raised || '[Not provided]', 25, pageWidth - 25)
                y += 5

                if (source.url) {
                    doc.text('URL:', 20, y)
                    y += 7
                    addWrappedText(source.url, 25, pageWidth - 25)
                }

                y += 10
            })

            doc.save(`HIST107_Mini_Archive_${studentName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`)

            showMessage('PDF exported successfully!', 'success')
        }

        function exportText() {
            let text = 'HIST 107 Component 1: Curated Mini-Archive\n'
            text += 'Individual Source Contributions\n'
            text += '='.repeat(60) + '\n\n'
            text += `Student Name: ${document.getElementById('student-name').value}\n`
            text += `Section Number: ${document.getElementById('section-number').value}\n`
            text += `Commodity: ${document.getElementById('commodity-name').value}\n`
            text += `Analytical Lens: ${document.getElementById('analytical-lens').value}\n`
            text += `Date: ${new Date().toLocaleDateString()}\n\n`

            sources.forEach((source, index) => {
                text += `SOURCE ${index + 1}\n`
                text += '-'.repeat(40) + '\n'
                text += `Citation: ${source.citation || '[Not provided]'}\n\n`
                text += `Type: ${source.source_type || '[Not specified]'}\n\n`
                text += `Producer & Date: ${source.producer || '[Not provided]'}\n\n`
                text += `Historical Question Addressed: ${source.historical_question || '[Not provided]'}\n\n`
                text += `Limitations: ${source.limitations || '[Not provided]'}\n\n`
                text += `Question Raised: ${source.question_raised || '[Not provided]'}\n\n`
                if (source.url) {
                    text += `URL: ${source.url}\n\n`
                }
                text += '\n'
            })

            const blob = new Blob([text], { type: 'text/plain' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `HIST107_Mini_Archive_${document.getElementById('student-name').value.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
            URL.revokeObjectURL(url)

            showMessage('Text file exported successfully!', 'success')
        }

        function showMessage(message, type) {
            const msgDiv = document.getElementById('status-message')
            msgDiv.innerHTML = type === 'success'
                ? `<div class="alert alert-success">${message}</div>`
                : `<div class="alert alert-error">${message}</div>`
        }

        async function submitToSupabase() {
            if (SUBMISSION_CUTOFF) {
                const cutoffDate = new Date(SUBMISSION_CUTOFF)
                const now = new Date()
                if (now > cutoffDate) {
                    alert('The submission deadline has passed. Please contact your professor if you need an extension.')
                    return
                }
            }

            const studentName = document.getElementById('student-name').value.trim()
            const sectionNumber = document.getElementById('section-number').value.trim()

            if (!studentName) {
                alert('Please enter your name before submitting.')
                document.getElementById('student-name').focus()
                return
            }

            if (!sectionNumber) {
                alert('Please enter your section number before submitting.')
                document.getElementById('section-number').focus()
                return
            }

            if (sources.length < 3) {
                alert('You must add at least 3 sources before submitting.')
                return
            }

            const submitBtn = document.getElementById('submitBtn')
            const messageDiv = document.getElementById('submitMessage')

            submitBtn.disabled = true
            submitBtn.textContent = '‚è≥ Submitting...'
            messageDiv.innerHTML = '<div class="alert" style="background-color: #fff3cd; color: #856404; border-left: 4px solid #ffc107;">Generating and uploading your work...</div>'

            try {
                const pdfBlob = await generatePDFBlob()

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-')
                const sanitizedName = studentName.replace(/[^a-zA-Z0-9]/g, '_')
                const commodity = document.getElementById('commodity-name').value.replace(/[^a-zA-Z0-9]/g, '_') || 'commodity'
                const fileName = `hist107-mini-archive/${sectionNumber}/${sanitizedName}_${commodity}_${timestamp}.pdf`

                const { data: uploadData, error: uploadError } = await supabaseClient
                    .storage
                    .from('student-submissions')
                    .upload(fileName, pdfBlob, {
                        contentType: 'application/pdf',
                        upsert: false
                    })

                if (uploadError) {
                    throw new Error(`Upload failed: ${uploadError.message}`)
                }

                const { data: urlData } = supabaseClient
                    .storage
                    .from('student-submissions')
                    .getPublicUrl(fileName)

                const formData = {
                    commodity_name: document.getElementById('commodity-name').value,
                    analytical_lens: document.getElementById('analytical-lens').value,
                    sources: sources
                }

                // Submit to worksheet_submissions table
                const { error: dbError } = await supabaseClient
                    .from('worksheet_submissions')
                    .insert({
                        student_name: studentName,
                        section_number: sectionNumber,
                        worksheet_type: 'hist107-mini-archive',
                        file_path: fileName,
                        file_url: urlData.publicUrl,
                        form_data: formData,
                        submitted_at: new Date().toISOString()
                    })

                if (dbError) {
                    console.warn('Metadata save warning:', dbError.message)
                }

                // Also save to the class archive table for viewing
                for (const source of sources) {
                    await supabaseClient
                        .from('hist107_class_archive')
                        .insert({
                            student_name: studentName,
                            section_number: sectionNumber,
                            commodity: document.getElementById('commodity-name').value,
                            analytical_lens: document.getElementById('analytical-lens').value,
                            citation: source.citation,
                            source_type: source.source_type,
                            producer: source.producer,
                            historical_question: source.historical_question,
                            limitations: source.limitations,
                            question_raised: source.question_raised,
                            url: source.url,
                            submitted_at: new Date().toISOString()
                        })
                }

                messageDiv.innerHTML = '<div class="alert alert-success">‚úÖ Successfully submitted! Your mini-archive has been sent to Prof. Hauselmann and added to the class archive.</div>'
                submitBtn.textContent = '‚úì Submitted'

            } catch (error) {
                console.error('Submission error:', error)
                messageDiv.innerHTML = `<div class="alert alert-error">‚ùå Submission failed: ${error.message}. Please try again or export the PDF and email it to your professor.</div>`
                submitBtn.disabled = false
                submitBtn.textContent = 'üì§ Submit to Professor'
            }
        }

        function generatePDFBlob() {
            return new Promise((resolve) => {
                const { jsPDF } = window.jspdf
                const doc = new jsPDF()

                const lineHeight = 7
                const pageWidth = 190
                const pageHeight = 280
                let y = 20

                function checkPageOverflow(neededSpace) {
                    if (y + neededSpace > pageHeight) {
                        doc.addPage()
                        y = 20
                    }
                }

                function addWrappedText(text, x, maxWidth) {
                    const lines = doc.splitTextToSize(text, maxWidth)
                    lines.forEach((line) => {
                        if (y + lineHeight > pageHeight) {
                            doc.addPage()
                            y = 20
                        }
                        doc.text(line, x, y)
                        y += lineHeight
                    })
                }

                doc.setFontSize(16)
                doc.setFont(undefined, 'bold')
                doc.text('HIST 107 Component 1: Curated Mini-Archive', 105, y, { align: 'center' })
                y += 10

                doc.setFontSize(12)
                doc.setFont(undefined, 'normal')
                doc.text('Individual Source Contributions', 105, y, { align: 'center' })
                y += 15

                doc.setFontSize(10)
                const studentName = document.getElementById('student-name').value
                const sectionNumber = document.getElementById('section-number').value
                const commodity = document.getElementById('commodity-name').value
                const lens = document.getElementById('analytical-lens').value

                if (studentName) {
                    doc.text(`Student: ${studentName}`, 20, y)
                    y += 8
                }
                if (sectionNumber) {
                    doc.text(`Section: ${sectionNumber}`, 20, y)
                    y += 8
                }
                if (commodity) {
                    doc.text(`Commodity: ${commodity}`, 20, y)
                    y += 8
                }
                if (lens) {
                    doc.text(`Analytical Lens: ${lens}`, 20, y)
                    y += 8
                }
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y)
                y += 15

                sources.forEach((source, index) => {
                    checkPageOverflow(30)
                    doc.setFontSize(12)
                    doc.setFont(undefined, 'bold')
                    doc.text(`Source ${index + 1}`, 20, y)
                    y += 10

                    doc.setFontSize(10)
                    doc.setFont(undefined, 'normal')

                    doc.text('Citation:', 20, y)
                    y += 7
                    addWrappedText(source.citation || '[Not provided]', 25, pageWidth - 25)
                    y += 5

                    doc.text(`Type: ${source.source_type || '[Not specified]'}`, 20, y)
                    y += 10

                    doc.text('Producer & Date:', 20, y)
                    y += 7
                    addWrappedText(source.producer || '[Not provided]', 25, pageWidth - 25)
                    y += 5

                    doc.text('Historical Question Addressed:', 20, y)
                    y += 7
                    addWrappedText(source.historical_question || '[Not provided]', 25, pageWidth - 25)
                    y += 5

                    doc.text('Limitations:', 20, y)
                    y += 7
                    addWrappedText(source.limitations || '[Not provided]', 25, pageWidth - 25)
                    y += 5

                    doc.text('Question Raised:', 20, y)
                    y += 7
                    addWrappedText(source.question_raised || '[Not provided]', 25, pageWidth - 25)
                    y += 5

                    if (source.url) {
                        doc.text('URL:', 20, y)
                        y += 7
                        addWrappedText(source.url, 25, pageWidth - 25)
                    }

                    y += 10
                })

                resolve(doc.output('blob'))
            })
        }

        async function viewClassArchive() {
            const modal = document.getElementById('classArchiveModal')
            const content = document.getElementById('class-archive-content')
            
            modal.style.display = 'block'
            content.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Loading class archive...</p>'

            try {
                const { data, error } = await supabaseClient
                    .from('hist107_class_archive')
                    .select('*')
                    .order('submitted_at', { ascending: false })

                if (error) throw error

                if (!data || data.length === 0) {
                    content.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No sources have been submitted yet. Be the first to contribute!</p>'
                    return
                }

                // Group by commodity
                const byCommo = {}
                data.forEach(source => {
                    const commodity = source.commodity || 'Unspecified'
                    if (!byCommody[commodity]) {
                        byCommody[commodity] = []
                    }
                    byCommody[commodity].push(source)
                })

                let html = '<div style="margin-bottom: 20px;"><strong>Total sources in class archive:</strong> ' + data.length + '</div>'

                for (const [commodity, sources] of Object.entries(byCommody)) {
                    html += `<h3 style="color: #2c3e50; margin-top: 30px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">${commodity} (${sources.length} sources)</h3>`

                    sources.forEach((source, idx) => {
                        html += `
                            <div class="class-source">
                                <h5>${source.analytical_lens || 'No lens specified'} | Source ${idx + 1}</h5>
                                <p><strong>Citation:</strong> ${source.citation || 'Not provided'}</p>
                                <p><strong>Type:</strong> ${source.source_type || 'Not specified'}</p>
                                <p><strong>What it reveals:</strong> ${source.historical_question || 'Not provided'}</p>
                                <p><strong>Limitations:</strong> ${source.limitations || 'Not provided'}</p>
                                ${source.url ? `<p><strong>URL:</strong> <a href="${source.url}" target="_blank">${source.url}</a></p>` : ''}
                                <p class="meta">Submitted by ${source.student_name} (${source.section_number}) on ${new Date(source.submitted_at).toLocaleDateString()}</p>
                            </div>
                        `
                    })
                }

                content.innerHTML = html

            } catch (error) {
                console.error('Error loading class archive:', error)
                content.innerHTML = '<p style="text-align: center; color: #e74c3c;">Error loading archive. Please try again later.</p>'
            }
        }

        function closeModal() {
            document.getElementById('classArchiveModal').style.display = 'none'
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('classArchiveModal')
            if (event.target == modal) {
                modal.style.display = 'none'
            }
        }

        checkAuth()
    </script>
</body>
</html>
