<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIST 101 Final Exam ‚Äî Prof. Hauselmann</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #1a1208;
            --parchment: #f5edda;
            --aged: #e8d9b8;
            --worn: #d4c49a;
            --red: #8b1a1a;
            --dark-red: #5c1010;
            --blue: #1a2c4a;
            --gold: #c8a84b;
            --stamp-green: #2a4a2a;
            --faded: #7a6a52;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Libre Baskerville', Georgia, serif;
            background-color: #2a1f0e;
            background-image: radial-gradient(ellipse at 20% 50%, rgba(139,26,26,0.08) 0%, transparent 60%),
                              radial-gradient(ellipse at 80% 20%, rgba(26,44,74,0.08) 0%, transparent 60%),
                              repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(0,0,0,0.03) 50px, rgba(0,0,0,0.03) 51px);
            color: var(--ink);
            min-height: 100vh;
            padding: 20px;
        }
        .page-wrap { max-width: 900px; margin: 0 auto; }

        /* Header */
        .exam-header { background: var(--parchment); border: 3px solid var(--ink); border-top: 8px solid var(--red); padding: 0; margin-bottom: 0; position: relative; box-shadow: 8px 8px 0 rgba(0,0,0,0.4), inset 0 0 60px rgba(200,168,75,0.15); }
        .exam-stamp { position: absolute; top: 12px; right: 20px; border: 3px solid var(--red); color: var(--red); font-family: 'Special Elite', monospace; font-size: 0.7em; padding: 6px 10px; text-align: center; transform: rotate(3deg); letter-spacing: 2px; opacity: 0.85; line-height: 1.3; }
        .exam-meta { background: var(--blue); color: #a8bdd0; font-family: 'Special Elite', monospace; font-size: 0.75em; padding: 8px 20px; letter-spacing: 3px; text-transform: uppercase; }
        .exam-title-area { padding: 30px 30px 25px; border-bottom: 2px solid var(--worn); }
        .exam-number { font-family: 'Special Elite', monospace; font-size: 0.85em; color: var(--faded); letter-spacing: 2px; margin-bottom: 8px; }
        h1 { font-family: 'Special Elite', monospace; font-size: 2.4em; color: var(--ink); line-height: 1.1; margin-bottom: 6px; }
        h1 span { color: var(--red); }
        .exam-subtitle { font-size: 1.05em; color: var(--faded); font-style: italic; }

        /* Timer bar */
        .timer-bar { background: var(--ink); padding: 10px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 0; }
        .timer-display { font-family: 'Special Elite', monospace; font-size: 1.4em; color: var(--gold); letter-spacing: 3px; }
        .timer-label { font-family: 'Special Elite', monospace; font-size: 0.75em; color: #8a9ab0; letter-spacing: 2px; text-transform: uppercase; }
        .timer-warning { color: #ff6b6b; }
        .session-info { font-family: 'Special Elite', monospace; font-size: 0.72em; color: #8a9ab0; letter-spacing: 1px; line-height: 1.6; }

        /* Progress */
        .progress-bar { display: flex; background: var(--aged); border: 2px solid var(--ink); border-top: none; margin-bottom: 30px; overflow: hidden; flex-wrap: wrap; }
        .prog-step { flex: 1; text-align: center; padding: 8px 4px; font-family: 'Special Elite', monospace; font-size: 0.65em; letter-spacing: 0.5px; color: var(--faded); border-right: 1px solid var(--worn); cursor: default; transition: all 0.3s; line-height: 1.3; min-width: 60px; }
        .prog-step:last-child { border-right: none; }
        .prog-step.active { background: var(--red); color: #f5edda; }
        .prog-step.done { background: var(--stamp-green); color: #c8e4c8; }
        .prog-step .step-icon { display: block; font-size: 1.1em; margin-bottom: 2px; }

        /* Panels */
        .panel { display: none; animation: slideIn 0.4s ease; }
        .panel.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { background: var(--parchment); border: 2px solid var(--ink); padding: 28px 30px; margin-bottom: 24px; position: relative; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); background-image: linear-gradient(to bottom right, var(--parchment), var(--aged)); }
        .card-label { font-family: 'Special Elite', monospace; font-size: 0.72em; letter-spacing: 3px; color: var(--red); text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .card-label::after { content: ''; flex: 1; height: 1px; background: var(--worn); }
        h2 { font-family: 'Special Elite', monospace; font-size: 1.6em; color: var(--blue); margin-bottom: 16px; border-bottom: 2px solid var(--worn); padding-bottom: 10px; }
        h3 { font-family: 'Special Elite', monospace; font-size: 1.2em; color: var(--ink); margin-bottom: 12px; margin-top: 20px; }
        p { line-height: 1.75; margin-bottom: 14px; color: var(--ink); }

        /* Form fields */
        .student-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 4px; }
        .student-info-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 4px; }
        .field-group { display: flex; flex-direction: column; gap: 6px; }
        .field-group label { font-family: 'Special Elite', monospace; font-size: 0.8em; letter-spacing: 2px; color: var(--faded); text-transform: uppercase; }
        input[type="text"], textarea, select {
            width: 100%; padding: 10px 14px; background: #fffdf6;
            border: 2px solid var(--worn); border-radius: 0;
            color: var(--ink); font-family: 'Libre Baskerville', serif;
            font-size: 0.95em; transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus, select:focus { outline: none; border-color: var(--blue); background: #fff; }
        textarea { resize: vertical; line-height: 1.6; }

        /* Question groups */
        .question-group { background: #f0e8d4; border: 1px solid var(--worn); border-left: 4px solid var(--gold); padding: 22px 24px; margin: 20px 0; }
        .question-group h4 { font-family: 'Special Elite', monospace; font-size: 0.9em; letter-spacing: 2px; color: var(--faded); text-transform: uppercase; margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }
        .q-item { margin-bottom: 20px; }
        .q-item:last-child { margin-bottom: 0; }
        .q-item label { display: block; font-weight: 700; color: var(--ink); margin-bottom: 8px; font-size: 0.95em; line-height: 1.5; }
        .q-num { display: inline-block; background: var(--red); color: #fff; font-family: 'Special Elite', monospace; font-size: 0.8em; padding: 1px 7px; margin-right: 6px; }

        /* ID section fields */
        .id-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
        .id-field-group { display: flex; flex-direction: column; gap: 5px; }
        .id-field-group label { font-family: 'Special Elite', monospace; font-size: 0.75em; letter-spacing: 2px; color: var(--faded); text-transform: uppercase; }
        .id-full-row { margin-top: 12px; }
        .id-full-row label { font-family: 'Special Elite', monospace; font-size: 0.75em; letter-spacing: 2px; color: var(--faded); text-transform: uppercase; display: block; margin-bottom: 5px; }

        /* Word count */
        .word-count-bar { display: flex; align-items: center; justify-content: space-between; margin-top: 6px; padding: 6px 10px; background: var(--aged); border: 1px solid var(--worn); font-family: 'Special Elite', monospace; font-size: 0.8em; }
        .wc-label { color: var(--faded); letter-spacing: 1px; }
        .wc-number { color: var(--blue); font-size: 1.1em; }
        .wc-number.wc-ok { color: var(--stamp-green); }
        .wc-number.wc-warn { color: #c8820a; }
        .wc-number.wc-over { color: var(--red); }
        .wc-range { color: var(--faded); font-size: 0.85em; }

        /* Document block */
        .document-block { background: #fffdf5; border: 2px solid var(--worn); border-left: 6px solid var(--blue); padding: 24px 26px; margin: 16px 0; font-size: 0.97em; line-height: 1.85; position: relative; }
        .document-block::before { content: '"'; position: absolute; top: -10px; left: 16px; font-size: 3em; color: var(--blue); opacity: 0.2; font-family: Georgia; line-height: 1; }
        .doc-source { margin-top: 14px; padding-top: 10px; border-top: 1px solid var(--worn); font-size: 0.82em; color: var(--faded); font-style: italic; }

        /* Notice */
        .notice { padding: 14px 18px; border-left: 4px solid var(--blue); background: rgba(26,44,74,0.07); margin: 16px 0; font-size: 0.9em; font-style: italic; color: var(--faded); }

        /* Phase banner */
        .phase-banner { font-family: 'Special Elite', monospace; font-size: 0.75em; letter-spacing: 3px; text-transform: uppercase; padding: 8px 16px; margin-bottom: 20px; display: inline-block; }
        .phase-banner.part1 { background: var(--red); color: var(--parchment); }
        .phase-banner.part2 { background: var(--blue); color: #a8c8e0; }
        .phase-banner.complete { background: var(--gold); color: var(--ink); }

        /* Buttons */
        .btn-row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 28px; }
        .btn { font-family: 'Special Elite', monospace; font-size: 0.95em; letter-spacing: 2px; padding: 13px 28px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
        .btn-primary { background: var(--red); color: var(--parchment); border-color: var(--dark-red); }
        .btn-primary:hover:not(:disabled) { background: var(--dark-red); transform: translateY(-2px); box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn-secondary { background: transparent; color: var(--ink); border-color: var(--worn); }
        .btn-secondary:hover { border-color: var(--ink); background: rgba(0,0,0,0.05); }
        .btn-gold { background: var(--gold); color: var(--ink); border-color: #a08030; }
        .btn-gold:hover:not(:disabled) { background: #a08030; color: var(--parchment); transform: translateY(-2px); box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn-success { background: var(--stamp-green); color: #d4ecd4; border-color: #1a3a1a; }
        .btn-success:hover:not(:disabled) { background: #1a3a1a; transform: translateY(-2px); box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Messages */
        #submitMessage { margin-top: 16px; font-size: 0.95em; }
        .success-msg { background: var(--stamp-green); color: #d4ecd4; padding: 16px 20px; border-left: 4px solid var(--gold); font-family: 'Special Elite', monospace; letter-spacing: 1px; }
        .error-msg { background: rgba(139,26,26,0.15); color: var(--red); padding: 16px 20px; border-left: 4px solid var(--red); }

        /* Citation field */
        .citation-field { margin-top: 10px; }
        .citation-field label { font-family: 'Special Elite', monospace; font-size: 0.75em; letter-spacing: 2px; color: var(--faded); text-transform: uppercase; display: block; margin-bottom: 5px; }

        /* ID term label */
        .id-term { background: var(--blue); color: var(--gold); font-family: 'Special Elite', monospace; font-size: 1em; padding: 10px 16px; margin-bottom: 16px; letter-spacing: 2px; display: flex; align-items: center; gap: 10px; }
        .id-term .pts { margin-left: auto; background: var(--gold); color: var(--ink); font-size: 0.8em; padding: 2px 8px; }

        /* Locked overlay */
        .locked-notice { background: rgba(92,16,16,0.12); border: 2px solid var(--red); padding: 18px 20px; text-align: center; font-family: 'Special Elite', monospace; color: var(--red); letter-spacing: 1px; margin: 20px 0; }

        /* Tab navigation inside essay section */
        .tab-group { display: flex; margin-bottom: -2px; }
        .tab-btn { flex: 1; padding: 10px 8px; font-family: 'Special Elite', monospace; font-size: 0.72em; letter-spacing: 2px; text-transform: uppercase; background: var(--aged); border: 2px solid var(--worn); border-bottom: none; cursor: pointer; color: var(--faded); transition: all 0.2s; }
        .tab-btn.active { background: var(--parchment); border-color: var(--ink); color: var(--ink); }
        .tab-content { border: 2px solid var(--ink); padding: 20px; background: var(--parchment); margin-bottom: 20px; display: none; }
        .tab-content.active { display: block; }

        /* Timeline for context */
        .timeline { margin: 16px 0; }
        .tl-item { display: flex; gap: 16px; margin-bottom: 10px; padding: 12px 16px; background: #fffdf5; border: 1px solid var(--worn); border-left: 4px solid var(--worn); }
        .tl-item.highlight { border-left-color: var(--red); background: rgba(139,26,26,0.05); }
        .tl-date { font-family: 'Special Elite', monospace; color: var(--red); font-size: 0.85em; min-width: 60px; padding-top: 2px; }

        /* Completion stamp */
        .verdict-stamp { font-family: 'Special Elite', monospace; font-size: 1.6em; color: var(--stamp-green); border: 4px solid var(--stamp-green); display: inline-block; padding: 8px 20px; transform: rotate(-3deg); letter-spacing: 4px; opacity: 0.9; margin: 20px auto; }
        .stamp-center { text-align: center; padding: 10px 0; }

        /* Notes area */
        .notes-box { background: #fffdf0; border: 2px dashed var(--worn); padding: 16px; margin: 16px 0; }
        .notes-box label { font-family: 'Special Elite', monospace; font-size: 0.75em; letter-spacing: 2px; color: var(--faded); text-transform: uppercase; display: block; margin-bottom: 8px; }

        /* breadcrumb */
        .breadcrumb { font-family: 'Special Elite', monospace; font-size: 0.8em; letter-spacing: 2px; color: #8a7a60; margin-bottom: 16px; }
        .breadcrumb a { color: var(--gold); text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep { margin: 0 8px; opacity: 0.4; }

        /* ‚îÄ‚îÄ ATTEMPT LOCK SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #lockScreen {
            display: none;
            position: fixed; inset: 0;
            background: #1a0e06;
            z-index: 9999;
            overflow-y: auto;
            padding: 40px 20px;
        }
        #lockScreen.visible { display: block; }
        .lock-box {
            max-width: 680px; margin: 0 auto;
            background: var(--parchment);
            border: 3px solid var(--ink);
            border-top: 8px solid var(--red);
            box-shadow: 10px 10px 0 rgba(0,0,0,0.5);
        }
        .lock-meta {
            background: var(--red); color: #f5edda;
            font-family: 'Special Elite', monospace;
            font-size: 0.75em; letter-spacing: 3px;
            text-transform: uppercase; padding: 10px 20px;
        }
        .lock-body { padding: 36px 36px 40px; }
        .lock-body h2 { font-family: 'Special Elite', monospace; font-size: 1.7em; color: var(--red); border-bottom: 2px solid var(--worn); padding-bottom: 12px; margin-bottom: 18px; }
        .lock-body p { line-height: 1.8; margin-bottom: 14px; }
        .lock-stamp { font-family: 'Special Elite', monospace; font-size: 2em; color: var(--red); border: 4px solid var(--red); display: inline-block; padding: 8px 22px; transform: rotate(-2deg); letter-spacing: 4px; opacity: 0.9; margin: 10px 0 24px; }
        .lock-details { background: var(--aged); border: 2px solid var(--worn); padding: 16px 20px; font-family: 'Special Elite', monospace; font-size: 0.85em; line-height: 2; letter-spacing: 1px; margin: 18px 0; }
        .lock-contact { padding: 16px 18px; border-left: 4px solid var(--blue); background: rgba(26,44,74,0.07); font-size: 0.9em; }

        /* ‚îÄ‚îÄ TIME EXPIRED OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #timeExpiredOverlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(10, 4, 4, 0.93);
            z-index: 9997;
            overflow-y: auto;
            padding: 40px 20px;
        }
        #timeExpiredOverlay.visible { display: block; }
        .time-expired-box {
            max-width: 680px; margin: 0 auto;
            background: var(--parchment);
            border: 3px solid var(--ink);
            border-top: 8px solid var(--red);
            box-shadow: 10px 10px 0 rgba(0,0,0,0.6);
        }
        .time-expired-meta {
            background: var(--red); color: #f5edda;
            font-family: 'Special Elite', monospace;
            font-size: 0.75em; letter-spacing: 3px;
            text-transform: uppercase; padding: 10px 20px;
        }
        .time-expired-body { padding: 36px 36px 40px; }
        .time-expired-body h2 { font-family: 'Special Elite', monospace; font-size: 1.5em; color: var(--red); border-bottom: 2px solid var(--worn); padding-bottom: 12px; margin-bottom: 18px; }
        .time-expired-body p { line-height: 1.8; margin-bottom: 14px; }
        .time-expired-stamp {
            font-family: 'Special Elite', monospace; font-size: 2em;
            color: var(--red); border: 4px solid var(--red);
            display: inline-block; padding: 8px 22px;
            transform: rotate(-2deg); letter-spacing: 4px;
            opacity: 0.9; margin: 10px 0 24px;
        }

        /* ‚îÄ‚îÄ COUNTDOWN TIMER (replaces elapsed display) ‚îÄ‚îÄ‚îÄ‚îÄ */
        .timer-display.countdown-warn  { color: #e8a020; }
        .timer-display.countdown-crit  { color: #ff4444; animation: pulse 1s ease-in-out infinite; }
        .timer-display.countdown-done  { color: #ff2222; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        .timer-remaining-label { font-family: 'Special Elite', monospace; font-size: 0.65em; color: #e08080; letter-spacing: 2px; text-transform: uppercase; margin-top: 2px; }

        /* ‚îÄ‚îÄ PREFLIGHT LOADING OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #preflightOverlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(10, 8, 4, 0.90);
            z-index: 9998;
            align-items: center;
            justify-content: center;
        }
        #preflightOverlay.visible { display: flex; }
        .preflight-box {
            background: var(--parchment);
            border: 3px solid var(--ink);
            border-top: 6px solid var(--gold);
            padding: 40px 48px;
            text-align: center;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
            max-width: 420px;
        }
        .preflight-box p { font-family: 'Special Elite', monospace; font-size: 1em; letter-spacing: 2px; color: var(--ink); margin-bottom: 16px; }
        .spinner {
            width: 40px; height: 40px; margin: 0 auto 20px;
            border: 4px solid var(--worn);
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ TUTORIAL MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(10, 8, 4, 0.82);
            z-index: 1000;
            overflow-y: auto;
            padding: 30px 16px;
        }
        .modal-overlay.open { display: block; }
        .modal-box {
            background: var(--parchment);
            border: 3px solid var(--ink);
            border-top: 8px solid var(--gold);
            max-width: 820px;
            margin: 0 auto;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.5);
            position: relative;
            animation: slideIn 0.35s ease;
        }
        .modal-meta {
            background: var(--gold);
            color: var(--ink);
            font-family: 'Special Elite', monospace;
            font-size: 0.75em;
            padding: 8px 20px;
            letter-spacing: 3px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-close {
            background: var(--ink); color: var(--gold);
            border: none; cursor: pointer;
            font-family: 'Special Elite', monospace;
            font-size: 0.9em; letter-spacing: 2px;
            padding: 4px 12px;
        }
        .modal-close:hover { background: var(--dark-red); color: #fff; }
        .modal-body { padding: 30px 32px 36px; }
        .modal-body h2 { font-family: 'Special Elite', monospace; font-size: 1.5em; color: var(--blue); border-bottom: 2px solid var(--worn); padding-bottom: 10px; margin-bottom: 18px; }
        .modal-body h3 { font-family: 'Special Elite', monospace; font-size: 1.05em; color: var(--ink); margin: 22px 0 10px; }
        .modal-body p { line-height: 1.75; margin-bottom: 12px; }

        /* Five-W breakdown grid */
        .five-w-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin: 18px 0; }
        .five-w-card {
            border: 2px solid var(--worn);
            border-left: 5px solid var(--blue);
            background: #fffdf5;
            padding: 14px 16px;
        }
        .five-w-card.why-card { border-left-color: var(--red); grid-column: span 2; }
        .five-w-letter {
            font-family: 'Special Elite', monospace;
            font-size: 1.5em;
            color: var(--blue);
            line-height: 1;
            margin-bottom: 4px;
        }
        .five-w-card.why-card .five-w-letter { color: var(--red); }
        .five-w-question { font-weight: 700; font-size: 0.92em; margin-bottom: 6px; color: var(--ink); }
        .five-w-hint { font-size: 0.85em; color: var(--faded); line-height: 1.5; font-style: italic; }

        /* Scoring rubric */
        .rubric-table { width: 100%; border-collapse: collapse; margin: 14px 0; font-size: 0.88em; }
        .rubric-table th { background: var(--blue); color: #e8f0f8; font-family: 'Special Elite', monospace; font-size: 0.8em; letter-spacing: 1px; padding: 8px 12px; text-align: left; }
        .rubric-table td { border: 1px solid var(--worn); padding: 8px 12px; vertical-align: top; line-height: 1.5; }
        .rubric-table tr:nth-child(even) td { background: rgba(0,0,0,0.03); }
        .rubric-pts { font-family: 'Special Elite', monospace; font-weight: bold; color: var(--blue); white-space: nowrap; }

        /* Example response */
        .example-block {
            background: #fffdf0;
            border: 2px solid var(--worn);
            border-left: 6px solid var(--stamp-green);
            padding: 20px 22px;
            margin: 18px 0;
            font-size: 0.95em;
            line-height: 1.85;
            position: relative;
        }
        .example-block::before {
            content: 'EXAMPLE RESPONSE';
            position: absolute; top: -11px; left: 14px;
            background: var(--stamp-green); color: #d4ecd4;
            font-family: 'Special Elite', monospace;
            font-size: 0.65em; letter-spacing: 3px;
            padding: 2px 10px;
        }
        .example-annotation {
            display: inline;
            background: rgba(200,168,75,0.25);
            border-bottom: 2px solid var(--gold);
            cursor: default;
            position: relative;
        }
        .example-annotation[data-w]::after {
            content: attr(data-w);
            position: absolute;
            top: -22px; left: 0;
            background: var(--gold);
            color: var(--ink);
            font-family: 'Special Elite', monospace;
            font-size: 0.65em; letter-spacing: 1px;
            padding: 1px 6px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .example-annotation:hover::after { opacity: 1; }
        .example-citation {
            margin-top: 14px; padding-top: 10px;
            border-top: 1px solid var(--worn);
            font-size: 0.82em; color: var(--faded); font-style: italic;
        }

        /* Poor vs strong example comparison */
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }
        .compare-block { border: 2px solid var(--worn); padding: 14px 16px; font-size: 0.88em; line-height: 1.65; }
        .compare-block.poor { border-left: 5px solid var(--red); background: rgba(139,26,26,0.04); }
        .compare-block.strong { border-left: 5px solid var(--stamp-green); background: rgba(42,74,42,0.04); }
        .compare-label {
            font-family: 'Special Elite', monospace; font-size: 0.72em;
            letter-spacing: 2px; text-transform: uppercase;
            margin-bottom: 8px;
        }
        .compare-block.poor .compare-label { color: var(--red); }
        .compare-block.strong .compare-label { color: var(--stamp-green); }

        /* Tip pills */
        .tip-list { list-style: none; margin: 12px 0; }
        .tip-list li { padding: 8px 12px 8px 36px; margin-bottom: 8px; background: rgba(26,44,74,0.06); border-left: 3px solid var(--blue); font-size: 0.9em; line-height: 1.5; position: relative; }
        .tip-list li::before { content: 'üí°'; position: absolute; left: 10px; top: 8px; }

        /* Tutorial open button */
        .btn-tutorial {
            font-family: 'Special Elite', monospace;
            font-size: 0.82em; letter-spacing: 2px;
            padding: 9px 18px;
            border: 2px solid var(--gold);
            background: rgba(200,168,75,0.1);
            color: var(--ink); cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-tutorial:hover { background: var(--gold); }

        /* ‚îÄ‚îÄ PREVIEW MODE JUMP NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #previewNav {
            display: none;
            background: #1a2c4a;
            border: 2px solid var(--gold);
            padding: 14px 20px;
            margin-bottom: 24px;
            font-family: 'Special Elite', monospace;
        }
        #previewNav .pn-label {
            font-size: 0.72em; letter-spacing: 3px; color: var(--gold);
            text-transform: uppercase; margin-bottom: 10px;
        }
        #previewNav .pn-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
        #previewNav .pn-btn {
            background: rgba(200,168,75,0.15); border: 1px solid var(--gold);
            color: var(--gold); font-family: 'Special Elite', monospace;
            font-size: 0.75em; letter-spacing: 1px; padding: 6px 14px;
            cursor: pointer; text-transform: uppercase; transition: all 0.2s;
        }
        #previewNav .pn-btn:hover { background: var(--gold); color: var(--ink); }
        #previewNav .pn-btn.current { background: var(--gold); color: var(--ink); }

        @media (max-width: 650px) {
            h1 { font-size: 1.8em; }
            .student-info-grid { grid-template-columns: 1fr; }
            .student-info-grid-3 { grid-template-columns: 1fr; }
            .id-fields { grid-template-columns: 1fr; }
            .five-w-grid { grid-template-columns: 1fr; }
            .five-w-card.why-card { grid-column: span 1; }
            .compare-grid { grid-template-columns: 1fr; }
            .modal-body { padding: 20px 18px 28px; }
            .lock-body { padding: 24px 20px 28px; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ATTEMPT LOCK SCREEN (shown if prior attempt found)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lockScreen">
    <div class="lock-box">
        <div class="lock-meta">‚ö†Ô∏è &nbsp; Examination Access Restricted ‚Äî HIST 101 Final Exam</div>
        <div class="lock-body">
            <div class="stamp-center">
                <div class="lock-stamp">ACCESS DENIED</div>
            </div>
            <h2>Exam Attempt Already Recorded</h2>
            <p>Our records show that an examination session has already been opened under your Student ID. For academic integrity purposes, this exam is limited to <strong>one attempt only</strong>.</p>
            <p>If you believe this is an error ‚Äî for example, if your browser crashed before you could begin writing ‚Äî please contact Prof. Hauselmann <strong>before</strong> attempting to re-enter the exam.</p>
            <div class="lock-details" id="lockDetails">
                Loading attempt details...
            </div>
            <div class="lock-contact">
                <strong>Contact Prof. Hauselmann:</strong><br>
                Email: <strong>hauselmann@yosemite.edu</strong><br>
                Office Hours: As posted on Canvas<br>
                Canvas Inbox: Available 24/7
            </div>
            <p style="margin-top:18px; font-size:0.88em; color:var(--faded); font-style:italic;">Do not attempt to bypass this screen. All access attempts, including the timestamp of this blocked attempt, are logged automatically.</p>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TIME EXPIRED OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="timeExpiredOverlay">
    <div class="time-expired-box">
        <div class="time-expired-meta">‚è∞ &nbsp; Examination Time Limit Reached ‚Äî HIST 101 Final Exam</div>
        <div class="time-expired-body">
            <div class="stamp-center">
                <div class="time-expired-stamp">TIME EXPIRED</div>
            </div>
            <h2>Your 2-Hour Examination Period Has Ended</h2>
            <p>The allotted time for this examination has elapsed. All answer fields have been locked. Your work up to this point has been preserved.</p>
            <p>Please click <strong>"Submit Now"</strong> to submit your exam immediately. Your responses will be submitted exactly as they were when time expired.</p>
            <div style="background: rgba(139,26,26,0.08); border: 2px solid var(--red); padding: 14px 18px; margin: 18px 0; font-family: 'Special Elite', monospace; font-size: 0.88em; letter-spacing: 1px; color: var(--red);">
                Auto-submitting in <span id="graceCountdown">60</span> seconds if you do not act.
            </div>
            <div style="text-align:center; margin-top: 10px;">
                <button class="btn btn-success" onclick="manualTimeExpiredSubmit()" style="font-size:1.05em; padding:16px 40px;">
                    üì§ &nbsp; Submit Now
                </button>
            </div>
            <p style="margin-top:18px; font-size:0.85em; color:var(--faded); font-style:italic;">If you experienced a technical issue that prevented timely completion, contact Prof. Hauselmann immediately after submitting.</p>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PRE-FLIGHT CHECKING OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="preflightOverlay">
    <div class="preflight-box">
        <div class="spinner"></div>
        <p>VERIFYING ELIGIBILITY</p>
        <p id="preflightStatus" style="font-size:0.8em; color:var(--faded); letter-spacing:1px;">Checking attempt records...</p>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     INSTRUCTOR PREVIEW BANNER (only shown in preview mode)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="previewBanner" style="display:none; background:#1a2c4a; color:#c8a84b; font-family:'Special Elite',monospace; font-size:0.85em; letter-spacing:2px; padding:12px 20px; text-align:center; border-bottom:3px solid #c8a84b; position:sticky; top:0; z-index:500; line-height:1.8;">
    üîç &nbsp; <strong>INSTRUCTOR PREVIEW MODE</strong> &nbsp;‚Äî&nbsp; Attempt locks, timer, word count minimums, and Supabase writes are all disabled
    &nbsp;&nbsp;|&nbsp;&nbsp;
    <a href="?" style="color:#c8a84b; font-size:0.85em; text-decoration:underline;">Exit Preview</a>
    &nbsp;&nbsp;
    <button onclick="document.getElementById('previewBanner').style.display='none'; document.getElementById('previewNav').style.display='none';" style="background:transparent;border:1px solid #c8a84b;color:#c8a84b;font-family:'Special Elite',monospace;font-size:0.8em;padding:3px 12px;cursor:pointer;letter-spacing:1px;">‚úï Dismiss</button>
</div>

<div class="page-wrap">

    <!-- ‚îÄ‚îÄ PREVIEW JUMP NAVIGATION (only shown in preview mode) ‚îÄ‚îÄ -->
    <div id="previewNav">
        <div class="pn-label">üîç Preview ‚Äî Jump to any section:</div>
        <div class="pn-buttons">
            <button class="pn-btn current" onclick="previewJump(0)">üìã Start</button>
            <button class="pn-btn" onclick="previewJump(1)">üìñ ID 1: Great Compromise</button>
            <button class="pn-btn" onclick="previewJump(2)">üìñ ID 2: Manifest Destiny</button>
            <button class="pn-btn" onclick="previewJump(3)">üìñ ID 3: Dred Scott</button>
            <button class="pn-btn" onclick="previewJump(4)">üìñ ID 4: Emancipation</button>
            <button class="pn-btn" onclick="previewJump(5)">üìñ ID 5: Freedmen's Bureau</button>
            <button class="pn-btn" onclick="previewJump(6)">‚úçÔ∏è Essay</button>
            <button class="pn-btn" onclick="previewJump(7)">üì§ Submit</button>
        </div>
    </div>

    <nav class="breadcrumb">
        <a href="index.html">Home</a><span class="sep">‚Ä∫</span>
        <a href="activities.html">Course Materials</a><span class="sep">‚Ä∫</span>
        <span>HIST 101 Final Exam</span>
    </nav>

    <!-- HEADER -->
    <div class="exam-header">
        <div class="exam-stamp">FINAL<br>EXAM<br>SECURE</div>
        <div class="exam-meta">HIST 101 ¬∑ American History to 1877 ¬∑ Prof. Hauselmann</div>
        <div class="exam-title-area">
            <div class="exam-number">Exam No. HIST-101 ¬∑ Final Examination</div>
            <h1><span>HIST 101</span> Final Examination</h1>
            <p class="exam-subtitle">American History to 1877 ¬∑ Two-Part Examination</p>
        </div>
        <div class="timer-bar" id="timerBar">
            <div>
                <div class="timer-label">Time Remaining</div>
                <div class="timer-display" id="timerDisplay">2:00:00</div>
                <div class="timer-remaining-label" id="timerRemainingLabel">of 2-hour limit</div>
            </div>
            <div style="text-align:right;">
                <div class="timer-label">Elapsed</div>
                <div style="font-family:'Special Elite',monospace; font-size:1em; color:#8a9ab0; letter-spacing:2px;" id="elapsedDisplay">00:00:00</div>
                <div class="session-info" id="sessionInfo" style="margin-top:4px;">
                    Started: ‚Äî<br>Current: ‚Äî
                </div>
            </div>
        </div>
    </div>

    <!-- PROGRESS BAR -->
    <div class="progress-bar" id="progressBar">
        <div class="prog-step active" data-phase="0"><span class="step-icon">üìã</span>Start</div>
        <div class="prog-step" data-phase="1"><span class="step-icon">üìñ</span>ID 1</div>
        <div class="prog-step" data-phase="2"><span class="step-icon">üìñ</span>ID 2</div>
        <div class="prog-step" data-phase="3"><span class="step-icon">üìñ</span>ID 3</div>
        <div class="prog-step" data-phase="4"><span class="step-icon">üìñ</span>ID 4</div>
        <div class="prog-step" data-phase="5"><span class="step-icon">üìñ</span>ID 5</div>
        <div class="prog-step" data-phase="6"><span class="step-icon">‚úçÔ∏è</span>Essay</div>
        <div class="prog-step" data-phase="7"><span class="step-icon">üì§</span>Submit</div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PHASE 0: START / STUDENT INFO
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel active" id="phase0">
        <div class="card">
            <div class="card-label">Examination Instructions</div>
            <h2>Welcome to the HIST 101 Final Exam</h2>
            <p>This is a <strong>two-part examination</strong>. You will complete five historical identifications followed by a source-analysis essay. Read all instructions carefully before beginning.</p>

            <div class="question-group" style="border-left-color: var(--red); background: rgba(139,26,26,0.04);">
                <h4>‚ö†Ô∏è Examination Rules</h4>
                <ul style="margin-left: 1.2em; line-height: 2; color: var(--ink);">
                    <li>All work must be your own. Copying and pasting is disabled.</li>
                    <li>You may not go back to Part I once you advance to Part II.</li>
                    <li>You must download your PDF and submit it to Canvas as instructed.</li>
                    <li>The timer runs continuously and cannot be paused.</li>
                    <li>Your start time and end time are recorded automatically.</li>
                    <li>Do not close this window ‚Äî your progress is saved locally every 30 seconds.</li>
                    <li><strong>This exam may only be opened once.</strong> Your Student ID is recorded at the moment you click "Begin Examination."</li>
                </ul>
            </div>

            <div class="question-group" style="margin-top: 20px;">
                <h4>üìã Part I ‚Äî Historical Identifications (40 points total)</h4>
                <p style="margin-bottom: 10px;">For each term, write a paragraph of <strong>75‚Äì150 words</strong> addressing:</p>
                <ul style="margin-left: 1.4em; line-height: 2; color: var(--ink);">
                    <li><strong>WHO?</strong> ‚Äî Who are the key people or groups involved?</li>
                    <li><strong>WHAT?</strong> ‚Äî What exactly is this term referring to?</li>
                    <li><strong>WHERE?</strong> ‚Äî Where did it take place?</li>
                    <li><strong>WHEN?</strong> ‚Äî When did it take place?</li>
                    <li><strong>WHY?</strong> ‚Äî Why is this term historically significant? <em>(Most important)</em></li>
                </ul>
                <p style="margin-top: 10px;">Include a citation for your source (course textbook or other class resources only). Each ID is worth <strong>8 points</strong>.</p>
                <div style="margin-top: 16px;">
                    <button class="btn-tutorial" onclick="openTutorial()">üìñ &nbsp; View Full Instructions &amp; Example Response</button>
                </div>
            </div>

            <div class="question-group" style="margin-top: 20px; border-left-color: var(--blue);">
                <h4>üìù Part II ‚Äî Source Analysis Essay (60 points)</h4>
                <p>You will read primary source documents and write a well-organized essay of <strong>500‚Äì1,000 words</strong> in response to a historical question. Full instructions appear in Part II.</p>
            </div>

            <div style="margin-top: 28px; border-top: 2px solid var(--worn); padding-top: 24px;">
                <h3>Enter Your Information to Begin</h3>
                <p style="font-size:0.9em; color:var(--faded); margin-bottom:16px;">All three fields are required. Your Student ID is used to verify you have not previously opened this exam.</p>
                <div class="student-info-grid-3" style="margin-top: 16px;">
                    <div class="field-group">
                        <label>Full Name</label>
                        <input type="text" id="student-name" placeholder="Enter your full name">
                    </div>
                    <div class="field-group">
                        <label>Student ID</label>
                        <input type="text" id="student-id" placeholder="e.g., 1234567" autocomplete="off">
                    </div>
                    <div class="field-group">
                        <label>Section Number</label>
                        <input type="text" id="section-number" placeholder="e.g., 101, 102">
                    </div>
                </div>
            </div>

            <div class="notice" style="margin-top: 20px;"><strong>Important:</strong> By clicking "Begin Examination" you confirm that all work will be your own and that you understand the exam rules above. <strong>The timer starts and your attempt is recorded the moment you click Begin.</strong> You will not be able to re-open this exam under the same Student ID.</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" id="beginBtn" onclick="beginExam()">Begin Examination ‚Üí</button>
        </div>
        <div id="beginError" style="margin-top:16px; display:none;"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PHASE 1‚Äì5: ID QUESTIONS
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

    <!-- PHASE 1: The Great Compromise -->
    <div class="panel" id="phase1">
        <div class="card">
            <div class="phase-banner part1">Part I ‚Äî Historical Identifications ¬∑ 1 of 5</div>
            <div class="card-label">Historical Identification ¬∑ 8 Points</div>
            <h2>Identification No. 1</h2>
            <div class="id-term">
                <span>üìú</span> Term: <strong>The Great Compromise</strong>
                <span class="pts">8 pts</span>
            </div>
            <p>Write a paragraph of <strong>75‚Äì150 words</strong> addressing WHO, WHAT, WHERE, WHEN, and WHY this term is historically significant. Include a citation for your source.</p>
            <div class="notice">Accepted sources: course textbook or other class resources only. Format: (Author, Year) or (Title, Year).</div>
            <div style="margin: 12px 0 4px;"><button class="btn-tutorial" onclick="openTutorial()">üìñ &nbsp; View Instructions &amp; Example</button></div>
            <div class="q-item" style="margin-top: 20px;">
                <label><span class="q-num">WHO / WHAT / WHERE / WHEN / WHY</span> Your response paragraph:</label>
                <textarea id="id1-response" rows="7" placeholder="Write your paragraph here... (75‚Äì150 words)" oninput="updateWordCount('id1-response','id1-wc',75,150)"></textarea>
                <div class="word-count-bar">
                    <span class="wc-label">Word Count:</span>
                    <span class="wc-number" id="id1-wc">0</span>
                    <span class="wc-range">Required: 75 ‚Äì 150 words</span>
                </div>
            </div>
            <div class="citation-field">
                <label>Citation (required):</label>
                <input type="text" id="id1-citation" placeholder="e.g., (Foner, Give Me Liberty!, 2020) or (Primary Source Title, Year)">
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="advanceID(1)">Next: ID 2 ‚Üí</button>
        </div>
    </div>

    <!-- PHASE 2: Manifest Destiny -->
    <div class="panel" id="phase2">
        <div class="card">
            <div class="phase-banner part1">Part I ‚Äî Historical Identifications ¬∑ 2 of 5</div>
            <div class="card-label">Historical Identification ¬∑ 8 Points</div>
            <h2>Identification No. 2</h2>
            <div class="id-term">
                <span>üåç</span> Term: <strong>Manifest Destiny</strong>
                <span class="pts">8 pts</span>
            </div>
            <p>Write a paragraph of <strong>75‚Äì150 words</strong> addressing WHO, WHAT, WHERE, WHEN, and WHY this term is historically significant. Include a citation for your source.</p>
            <div class="notice">Accepted sources: course textbook or other class resources only.</div>
            <div style="margin: 12px 0 4px;"><button class="btn-tutorial" onclick="openTutorial()">üìñ &nbsp; View Instructions &amp; Example</button></div>
            <div class="q-item" style="margin-top: 20px;">
                <label><span class="q-num">WHO / WHAT / WHERE / WHEN / WHY</span> Your response paragraph:</label>
                <textarea id="id2-response" rows="7" placeholder="Write your paragraph here... (75‚Äì150 words)" oninput="updateWordCount('id2-response','id2-wc',75,150)"></textarea>
                <div class="word-count-bar">
                    <span class="wc-label">Word Count:</span>
                    <span class="wc-number" id="id2-wc">0</span>
                    <span class="wc-range">Required: 75 ‚Äì 150 words</span>
                </div>
            </div>
            <div class="citation-field">
                <label>Citation (required):</label>
                <input type="text" id="id2-citation" placeholder="e.g., (Foner, Give Me Liberty!, 2020)">
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="advanceID(2)">Next: ID 3 ‚Üí</button>
        </div>
    </div>

    <!-- PHASE 3: Dred Scott -->
    <div class="panel" id="phase3">
        <div class="card">
            <div class="phase-banner part1">Part I ‚Äî Historical Identifications ¬∑ 3 of 5</div>
            <div class="card-label">Historical Identification ¬∑ 8 Points</div>
            <h2>Identification No. 3</h2>
            <div class="id-term">
                <span>‚öñÔ∏è</span> Term: <strong>The Dred Scott Decision</strong>
                <span class="pts">8 pts</span>
            </div>
            <p>Write a paragraph of <strong>75‚Äì150 words</strong> addressing WHO, WHAT, WHERE, WHEN, and WHY this term is historically significant. Include a citation for your source.</p>
            <div class="notice">Accepted sources: course textbook or other class resources only.</div>
            <div style="margin: 12px 0 4px;"><button class="btn-tutorial" onclick="openTutorial()">üìñ &nbsp; View Instructions &amp; Example</button></div>
            <div class="q-item" style="margin-top: 20px;">
                <label><span class="q-num">WHO / WHAT / WHERE / WHEN / WHY</span> Your response paragraph:</label>
                <textarea id="id3-response" rows="7" placeholder="Write your paragraph here... (75‚Äì150 words)" oninput="updateWordCount('id3-response','id3-wc',75,150)"></textarea>
                <div class="word-count-bar">
                    <span class="wc-label">Word Count:</span>
                    <span class="wc-number" id="id3-wc">0</span>
                    <span class="wc-range">Required: 75 ‚Äì 150 words</span>
                </div>
            </div>
            <div class="citation-field">
                <label>Citation (required):</label>
                <input type="text" id="id3-citation" placeholder="e.g., (Foner, Give Me Liberty!, 2020)">
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="advanceID(3)">Next: ID 4 ‚Üí</button>
        </div>
    </div>

    <!-- PHASE 4: Emancipation Proclamation -->
    <div class="panel" id="phase4">
        <div class="card">
            <div class="phase-banner part1">Part I ‚Äî Historical Identifications ¬∑ 4 of 5</div>
            <div class="card-label">Historical Identification ¬∑ 8 Points</div>
            <h2>Identification No. 4</h2>
            <div class="id-term">
                <span>üìú</span> Term: <strong>The Emancipation Proclamation</strong>
                <span class="pts">8 pts</span>
            </div>
            <p>Write a paragraph of <strong>75‚Äì150 words</strong> addressing WHO, WHAT, WHERE, WHEN, and WHY this term is historically significant. Include a citation for your source.</p>
            <div class="notice">Accepted sources: course textbook or other class resources only.</div>
            <div style="margin: 12px 0 4px;"><button class="btn-tutorial" onclick="openTutorial()">üìñ &nbsp; View Instructions &amp; Example</button></div>
            <div class="q-item" style="margin-top: 20px;">
                <label><span class="q-num">WHO / WHAT / WHERE / WHEN / WHY</span> Your response paragraph:</label>
                <textarea id="id4-response" rows="7" placeholder="Write your paragraph here... (75‚Äì150 words)" oninput="updateWordCount('id4-response','id4-wc',75,150)"></textarea>
                <div class="word-count-bar">
                    <span class="wc-label">Word Count:</span>
                    <span class="wc-number" id="id4-wc">0</span>
                    <span class="wc-range">Required: 75 ‚Äì 150 words</span>
                </div>
            </div>
            <div class="citation-field">
                <label>Citation (required):</label>
                <input type="text" id="id4-citation" placeholder="e.g., (Foner, Give Me Liberty!, 2020)">
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="advanceID(4)">Next: ID 5 ‚Üí</button>
        </div>
    </div>

    <!-- PHASE 5: Freedmen's Bureau -->
    <div class="panel" id="phase5">
        <div class="card">
            <div class="phase-banner part1">Part I ‚Äî Historical Identifications ¬∑ 5 of 5</div>
            <div class="card-label">Historical Identification ¬∑ 8 Points</div>
            <h2>Identification No. 5</h2>
            <div class="id-term">
                <span>üèõÔ∏è</span> Term: <strong>The Freedmen's Bureau</strong>
                <span class="pts">8 pts</span>
            </div>
            <p>Write a paragraph of <strong>75‚Äì150 words</strong> addressing WHO, WHAT, WHERE, WHEN, and WHY this term is historically significant. Include a citation for your source.</p>
            <div class="notice">Accepted sources: course textbook or other class resources only.</div>
            <div style="margin: 12px 0 4px;"><button class="btn-tutorial" onclick="openTutorial()">üìñ &nbsp; View Instructions &amp; Example</button></div>
            <div class="q-item" style="margin-top: 20px;">
                <label><span class="q-num">WHO / WHAT / WHERE / WHEN / WHY</span> Your response paragraph:</label>
                <textarea id="id5-response" rows="7" placeholder="Write your paragraph here... (75‚Äì150 words)" oninput="updateWordCount('id5-response','id5-wc',75,150)"></textarea>
                <div class="word-count-bar">
                    <span class="wc-label">Word Count:</span>
                    <span class="wc-number" id="id5-wc">0</span>
                    <span class="wc-range">Required: 75 ‚Äì 150 words</span>
                </div>
            </div>
            <div class="citation-field">
                <label>Citation (required):</label>
                <input type="text" id="id5-citation" placeholder="e.g., (Foner, Give Me Liberty!, 2020)">
            </div>
        </div>
        <div class="locked-notice" style="margin-top: 0;">
            ‚ö†Ô∏è Once you advance to Part II, you cannot return to Part I. Make sure your responses above are complete.
        </div>
        <div class="btn-row">
            <button class="btn btn-gold" onclick="advanceToEssay()">Advance to Part II: Source Analysis ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PHASE 6: ESSAY ‚Äî SOURCE ANALYSIS
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="phase6">
        <div class="card">
            <div class="phase-banner part2">Part II ‚Äî Source Analysis Essay ¬∑ 60 Points</div>
            <div class="card-label">Source Analysis ¬∑ 60 Points</div>
            <h2>Were African Americans Free During Reconstruction?</h2>

            <div class="locked-notice">üîí Part I is now locked. You may not return to the identification questions.</div>

            <p style="margin-top: 16px;">Reconstruction was the period between 1865 and 1877, when the nation tried to rebuild itself after the Civil War. One of the main questions facing Americans during this period was whether the federal government would pass laws to protect the rights of African Americans.</p>

            <div style="margin: 20px 0; padding: 16px 20px; background: var(--blue); color: #f0e8d4;">
                <p style="margin: 0; font-family: 'Special Elite', monospace; font-size: 1em; letter-spacing: 1px; color: var(--gold);">‚ùì Essay Question:</p>
                <p style="margin: 8px 0 0; font-size: 1.1em; color: #f0e8d4; font-weight: bold;">Were African Americans free during Reconstruction?</p>
            </div>

            <div class="notice">The sources below are the primary sources for this exam. This is the first time you are seeing them. Read carefully and take notes before writing your essay. The exam clock continues to run while you read.</div>
        </div>

        <!-- SOURCE DOCUMENTS -->
        <div class="card">
            <div class="card-label">Primary Sources ‚Äî Read All Documents</div>
            <h2>Examination Sources</h2>

            <div class="tab-group">
                <button class="tab-btn active" onclick="showTab('timeline-tab', this)">üìÖ Timeline</button>
                <button class="tab-btn" onclick="showTab('docA-tab', this)">Doc A: Amendments</button>
                <button class="tab-btn" onclick="showTab('docB-tab', this)">Doc B: Black Codes</button>
                <button class="tab-btn" onclick="showTab('docC-tab', this)">Doc C: Henry Adams</button>
                <button class="tab-btn" onclick="showTab('docD-tab', this)">Doc D: Officials</button>
                <button class="tab-btn" onclick="showTab('docE-tab', this)">Doc E: Education</button>
            </div>

            <div class="tab-content active" id="timeline-tab">
                <h3>Reconstruction Timeline (1865‚Äì1877)</h3>
                <div class="timeline">
                    <div class="tl-item"><div class="tl-date">1865</div><div>The Civil War ends. Lincoln is assassinated. Andrew Johnson becomes president. 13th Amendment passes. Freedmen's Bureau is created.</div></div>
                    <div class="tl-item highlight"><div class="tl-date">1865</div><div><strong>Black Codes passed across the South</strong>, severely restricting the freedoms of formerly enslaved people.</div></div>
                    <div class="tl-item"><div class="tl-date">1866</div><div>Civil Rights Act of 1866. Ku Klux Klan is founded.</div></div>
                    <div class="tl-item"><div class="tl-date">1867</div><div>Radical Republicans take control of Reconstruction.</div></div>
                    <div class="tl-item"><div class="tl-date">1868</div><div>14th Amendment passes. First African American elected to Congress.</div></div>
                    <div class="tl-item"><div class="tl-date">1870</div><div>15th Amendment passes ‚Äî right to vote regardless of race.</div></div>
                    <div class="tl-item"><div class="tl-date">1871</div><div>Ku Klux Klan Act passed in response to widespread violence against Black Southerners.</div></div>
                    <div class="tl-item"><div class="tl-date">1872</div><div>The Freedmen's Bureau ends.</div></div>
                    <div class="tl-item"><div class="tl-date">1874</div><div>Democrats take control of Congress. Radical Republicans lose power.</div></div>
                    <div class="tl-item highlight"><div class="tl-date">1877</div><div><strong>Reconstruction ends.</strong> Hayes withdraws all Northern troops from the South.</div></div>
                </div>
            </div>

            <div class="tab-content" id="docA-tab">
                <h3>Document A: The Reconstruction Amendments (Modified)</h3>
                <p style="font-style: italic; color: var(--faded); margin-bottom: 10px;">The 13th, 14th, and 15th amendments to the U.S. Constitution are sometimes called the "Reconstruction Amendments." They were passed to abolish slavery and establish the rights of formerly enslaved people.</p>
                <div class="document-block">
                    <p><strong>13th Amendment: 1865</strong><br>Section 1. Neither slavery nor involuntary servitude, except as a punishment for crime whereof the party shall have been duly convicted, shall exist within the United States, or any place subject to their jurisdiction.</p>
                    <p><strong>14th Amendment: 1868</strong><br>Section 1. All persons born or naturalized in the United States . . . are citizens of the United States and of the State wherein they reside. No State shall make or enforce any law which shall abridge the privileges or immunities of citizens of the United States; nor shall any State deprive any person of life, liberty, or property, without due process of law; nor deny to any person within its jurisdiction the equal protection of the laws.</p>
                    <p><strong>15th Amendment: 1870</strong><br>Section 1. The right of citizens of the United States to vote shall not be denied or abridged by the United States or by any State on account of race, color, or previous condition of servitude.</p>
                    <div class="doc-source">Source: 13th, 14th, and 15th Amendments to the United States Constitution, 1865‚Äì1870. (Digital Inquiry Group)</div>
                </div>
            </div>

            <div class="tab-content" id="docB-tab">
                <h3>Document B: Black Codes (Modified)</h3>
                <p style="font-style: italic; color: var(--faded); margin-bottom: 10px;">In the years following the Civil War, many Southern states and cities passed Black Codes. The document below, passed July 3, 1865, is a Black Code from Opelousas, Louisiana.</p>
                <div class="document-block">
                    <p>SECTION 1. No negro shall be allowed to come within the limits of the town of Opelousas without special permission from his employers.</p>
                    <p>SECTION 3. No negro shall be permitted to rent or keep a house within the limits of the town under any circumstances.</p>
                    <p>SECTION 4. No negro shall reside within the limits of the town of Opelousas who is not in the regular service of some white person or former owner.</p>
                    <p>SECTION 5. No public meetings of negroes shall be allowed within the limits of the town of Opelousas under any circumstances without the permission of the mayor or president of the board of police. This, however, does not prevent the freedmen from attending the usual church services.</p>
                    <p>SECTION 7. No freedman who is not in the military service shall be allowed to carry firearms, or any kind of weapons, within the limits of the town of Opelousas without the special permission of his employer, in writing, and approved by the mayor or president of the board of police.</p>
                    <p>SECTION 11. All the foregoing provisions apply to freedmen and freedwomen.</p>
                    <div class="doc-source">Source: Black Code from Opelousas, Louisiana, July 3, 1865. (Digital Inquiry Group)</div>
                </div>
            </div>

            <div class="tab-content" id="docC-tab">
                <h3>Document C: Henry Adams Statement (Modified)</h3>
                <p style="font-style: italic; color: var(--faded); margin-bottom: 10px;">Formerly enslaved person Henry Adams made this statement before the U.S. Senate in 1880 about the early days of his freedom after the Civil War.</p>
                <div class="document-block">
                    <p>In September 1865 I asked the boss to let me go to the city of Shreveport. He said, "All right, when will you come back?" I told him "next week." He said, "You had better carry a pass." I said, "I will see whether I am free by going without a pass."</p>
                    <p>I met four white men about six miles south of town. One of them asked me who I belonged to. I told him no one. So him and two others struck me with a stick and told me they were going to kill me and every other Negro who told them that they did not belong to anyone. They left me and I then went on to Shreveport. I saw over twelve colored men and women, beat, shot and hung between there and Shreveport.</p>
                    <p>Sunday I went back home. The boss was not at home. I asked the madam [the boss's wife], "where was the boss?" She said, "You should say 'master'. You all are not free . . . and you shall call every white lady 'missus' and every white man 'master.'"</p>
                    <p>During the same week the madam took a stick and beat one of the young colored girls, who was about fifteen years of age. The boss came the next day and whipped the same girl nearly to death. . . . After the whipping a large number of young colored people decided to leave that place for Shreveport. [On our way], out came about forty armed white men and shot at us and took my horse. They said they were going to kill every colored person they found leaving their masters.</p>
                    <div class="doc-source">Source: Henry Adams, statement before the U.S. Senate, 1880. (Digital Inquiry Group)</div>
                </div>
            </div>

            <div class="tab-content" id="docD-tab">
                <h3>Document D: Elected Black Officials During Reconstruction</h3>
                <div class="document-block">
                    <p>During Reconstruction, thousands of African Americans were elected to local and state governments throughout the Southern states. In addition, <strong>17 African Americans were elected to the United States Congress from Southern states between 1870 and 1877.</strong></p>
                    <p>Among them were: <strong>Blanche Bruce</strong> (U.S. Senator, Mississippi, 1875‚Äì1881), <strong>Robert DeLarge</strong> (U.S. Representative, South Carolina, 1871‚Äì1873), <strong>Jefferson Long</strong> (U.S. Representative, Georgia, 1871), <strong>Joseph Rainey</strong> (U.S. Representative, South Carolina, 1870‚Äì1879), <strong>Benjamin Turner</strong> (U.S. Representative, Alabama, 1871‚Äì1873), and <strong>Josiah Walls</strong> (U.S. Representative, Florida, 1871‚Äì1876).</p>
                    <img src="hist101/online/final/elected-black-officials1.jpg" alt="Portraits of elected African American officials during Reconstruction" style="width: 100%; max-width: 600px; display: block; margin: 16px auto; border: 2px solid var(--worn);">
                    <div class="doc-source">Source: Digital Inquiry Group. Photographs from the Library of Congress.</div>
                </div>
            </div>

            <div class="tab-content" id="docE-tab">
                <h3>Document E: Education (Modified)</h3>
                <p style="font-style: italic; color: var(--faded); margin-bottom: 10px;">The document below is an excerpt from a report by a Northern white man to the United States government in 1866.</p>
                <div class="document-block">
                    <p>In 1865 the United States government created the Freedmen's Bureau to help formerly enslaved people in Southern states. The Freedmen's Bureau helped people by providing medical supplies and health care and establishing schools.</p>
                    <p>The creation of schools for formerly enslaved people was an important part of Reconstruction. Before the Civil War, Southern states outlawed the teaching of reading and writing to enslaved people.</p>
                    <p>Many of the negroes . . . common plantation negroes, and day laborers in the towns and villages, were supporting little schools themselves. Everywhere I found them hoping to get their children into schools. I often noticed that workers in stores and men working in warehouses, and cart drivers on the streets, had spelling books with them, and were studying them during the time they were not working. Go outside any large town in the South, and walk among the negro housing, and you will see children and in many cases grown negroes, sitting in the sun alongside their cabins studying.</p>
                    <div class="doc-source">Source: Sidney Andrews, quoted in the Joint Report on Reconstruction, 1866.</div>
                </div>
            </div>
        </div>

        <!-- DOCUMENT NOTES -->
        <div class="card">
            <div class="card-label">Reading Notes ‚Äî Optional but Recommended</div>
            <h2>Document Notes</h2>
            <p>Use this space to jot notes as you read through the documents. These notes will appear in your PDF but are not graded ‚Äî they are here to help you organize your thinking before writing your essay.</p>
            <div class="notes-box">
                <label>Your Notes on the Sources:</label>
                <textarea id="essay-notes" rows="6" placeholder="e.g., Doc A ‚Äî Amendments establish legal freedom and citizenship, but Doc B shows laws immediately restricted this freedom. Doc C ‚Äî personal testimony of violence shows freedom was not real in practice..."></textarea>
            </div>
        </div>

        <!-- ESSAY WRITING -->
        <div class="card">
            <div class="card-label">Your Essay Response ¬∑ 60 Points</div>
            <h2>Write Your Essay</h2>
            <div style="padding: 14px 18px; background: var(--blue); color: #f0e8d4; margin-bottom: 20px;">
                <strong style="font-family: 'Special Elite', monospace; letter-spacing: 1px; color: var(--gold);">Essay Question:</strong> Were African Americans free during Reconstruction?
            </div>
            <div class="question-group" style="border-left-color: var(--blue); background: rgba(26,44,74,0.05);">
                <h4>üìù Essay Requirements</h4>
                <ul style="margin-left: 1.2em; line-height: 2; color: var(--ink); font-size: 0.95em;">
                    <li><strong>Thesis Statement</strong> (1‚Äì2 sentences): Clearly state your argument.</li>
                    <li><strong>Source Analysis</strong> (2‚Äì3 paragraphs): Use <em>all</em> five sources. Explain how each supports or complicates your argument. Consider author, purpose, and historical context. Compare and contrast perspectives.</li>
                    <li><strong>Contextualization</strong> (1 paragraph): Connect Reconstruction to broader historical events. Include one piece of outside knowledge from lectures or readings.</li>
                    <li><strong>Conclusion</strong> (2‚Äì3 sentences): Restate thesis, explain larger significance.</li>
                    <li>Minimum <strong>one direct quote</strong> from each document with citation (Author, Year).</li>
                    <li>Length: <strong>500‚Äì1,000 words</strong>. All work must be your own.</li>
                </ul>
            </div>
            <div class="q-item" style="margin-top: 20px;">
                <label><span class="q-num">Essay</span> Your response (500‚Äì1,000 words):</label>
                <textarea id="essay-response" rows="28" placeholder="Begin your essay here. Remember to include a thesis, source analysis (use all 5 sources with citations), contextualization, and conclusion..." oninput="updateWordCount('essay-response','essay-wc',500,1000)"></textarea>
                <div class="word-count-bar">
                    <span class="wc-label">Word Count:</span>
                    <span class="wc-number" id="essay-wc">0</span>
                    <span class="wc-range">Required: 500 ‚Äì 1,000 words</span>
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-gold" onclick="advanceToSubmit()">Review &amp; Submit ‚Üí</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PHASE 7: SUBMISSION
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="phase7">
        <div class="card">
            <div class="phase-banner complete">Examination Complete ¬∑ Submit Your Work</div>
            <div class="stamp-center">
                <div class="verdict-stamp">EXAM COMPLETE</div>
            </div>
            <div class="card-label">Final Submission</div>
            <h2>Review &amp; Submit</h2>

            <div id="exam-summary" style="margin: 16px 0; padding: 18px 20px; background: var(--aged); border: 2px solid var(--worn); font-family: 'Special Elite', monospace; font-size: 0.9em; line-height: 2; letter-spacing: 1px;"></div>

            <div class="question-group" style="border-left-color: var(--red); background: rgba(139,26,26,0.04);">
                <h4>üì§ Submission Instructions</h4>
                <ol style="margin-left: 1.4em; line-height: 2.2; color: var(--ink); font-size: 0.95em;">
                    <li><strong>Click "Download PDF"</strong> to save your exam responses to your computer.</li>
                    <li><strong>Open the Canvas assignment</strong> using the link below and upload your PDF.</li>
                    <li>Your exam is also automatically submitted to Prof. Hauselmann's records when you click "Submit to Prof. Hauselmann."</li>
                </ol>
            </div>

            <div id="canvas-link-display" style="margin: 16px 0; padding: 14px 18px; background: rgba(26,44,74,0.08); border-left: 4px solid var(--blue);">
                <div style="font-family: 'Special Elite', monospace; font-size: 0.8em; letter-spacing: 2px; color: var(--faded); text-transform: uppercase; margin-bottom: 10px;">Step 2 ‚Äî Submit PDF to Canvas</div>
                <a id="canvas-submit-btn" href="CANVAS_URL_PLACEHOLDER" target="_blank" class="btn btn-primary" style="display:inline-block; text-decoration:none;">üìã &nbsp; Go to Canvas Assignment ‚Üí</a>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="downloadPDF()">üìÑ Download PDF</button>
            <button class="btn btn-success" onclick="submitToSupabase()" id="submitBtn">üì§ Submit to Prof. Hauselmann</button>
        </div>
        <div id="submitMessage"></div>
    </div>

</div><!-- end page-wrap -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TUTORIAL MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="tutorialModal" onclick="closeTutorialOnOverlay(event)">
  <div class="modal-box" role="dialog" aria-modal="true" aria-label="How to Write a Historical Identification">
    <div class="modal-meta">
        <span>üìñ &nbsp; How to Write a Historical Identification</span>
        <button class="modal-close" onclick="closeTutorial()">‚úï CLOSE</button>
    </div>
    <div class="modal-body">
        <h2>Writing a Strong Historical Identification</h2>
        <p>A historical identification is a short, focused paragraph that proves you understand a key term from the course ‚Äî not just what it is, but <strong>why it mattered</strong>. You must address five questions, each of equal importance, in 75‚Äì150 words.</p>

        <h3>The Five W's ‚Äî What Each One Is Asking</h3>
        <div class="five-w-grid">
            <div class="five-w-card">
                <div class="five-w-letter">WHO?</div>
                <div class="five-w-question">Who are the key people or groups involved?</div>
                <div class="five-w-hint">Name the specific individuals, groups, institutions, or parties at the center of this term. Don't just say "people" or "Americans" ‚Äî be precise.</div>
            </div>
            <div class="five-w-card">
                <div class="five-w-letter">WHAT?</div>
                <div class="five-w-question">What exactly is this term referring to?</div>
                <div class="five-w-hint">Describe the event, law, idea, decision, or institution in concrete terms. What actually happened, or what did it actually do?</div>
            </div>
            <div class="five-w-card">
                <div class="five-w-letter">WHERE?</div>
                <div class="five-w-question">Where did this take place?</div>
                <div class="five-w-hint">Be as specific as the term allows. Some terms are national in scope; others happened in a specific city, region, or state.</div>
            </div>
            <div class="five-w-card">
                <div class="five-w-letter">WHEN?</div>
                <div class="five-w-question">When did this occur?</div>
                <div class="five-w-hint">Give a specific date, year, or time period. Timing often reveals cause-and-effect relationships.</div>
            </div>
            <div class="five-w-card why-card">
                <div class="five-w-letter">WHY? ‚Üê This is the most important part</div>
                <div class="five-w-question">Why is this term historically significant? What was its impact or consequence?</div>
                <div class="five-w-hint">Don't just restate what it was ‚Äî explain <strong>what it caused, changed, or revealed</strong> about American history. A strong "WHY" separates a good identification from a great one.</div>
            </div>
        </div>

        <h3>How Your Response Will Be Scored (8 Points)</h3>
        <table class="rubric-table">
            <thead><tr><th>Points</th><th>What It Looks Like</th></tr></thead>
            <tbody>
                <tr><td class="rubric-pts">8 pts<br><em>Excellent</em></td><td>All five W's addressed accurately. Significance clearly explained. Within 75‚Äì150 words. Properly cited.</td></tr>
                <tr><td class="rubric-pts">6‚Äì7 pts<br><em>Good</em></td><td>Most W's addressed. WHY present but could be more developed. Citation included.</td></tr>
                <tr><td class="rubric-pts">4‚Äì5 pts<br><em>Adequate</em></td><td>At least three W's addressed. Basic understanding but lacks depth in significance.</td></tr>
                <tr><td class="rubric-pts">1‚Äì3 pts<br><em>Weak</em></td><td>Only one or two W's addressed. Vague, too short, or largely inaccurate.</td></tr>
                <tr><td class="rubric-pts">0 pts</td><td>No response, off-topic, or plagiarized.</td></tr>
            </tbody>
        </table>

        <h3>Example: "The Missouri Compromise" <span style="font-size:0.75em; color:var(--faded); font-style:italic;">(Not on your exam ‚Äî illustration only)</span></h3>
        <div class="example-block">
            <p>
                <span class="example-annotation" data-w="WHO">Congress, led by Senator Henry Clay of Kentucky,</span>
                negotiated the Missouri Compromise in
                <span class="example-annotation" data-w="WHEN">1820</span>
                to settle a crisis over the expansion of slavery.
                <span class="example-annotation" data-w="WHAT">The agreement admitted Missouri as a slave state and Maine as a free state, maintaining the Senate balance, and drew a line across the Louisiana Territory at 36¬∞30'.</span>
                <span class="example-annotation" data-w="WHERE">The compromise applied to the entire Louisiana Territory west of the Mississippi River.</span>
                <span class="example-annotation" data-w="WHY">It was significant because it delayed the national crisis over slavery for three decades ‚Äî and when the Kansas-Nebraska Act repealed it in 1854, it reignited tensions that led directly to the Civil War.</span>
            </p>
            <div class="example-citation">Citation: (Foner, <em>Give Me Liberty!</em>, 2020, p. 315)</div>
        </div>

        <h3>Poor vs. Strong Responses</h3>
        <div class="compare-grid">
            <div class="compare-block poor">
                <div class="compare-label">‚ùå Weak Response</div>
                <p>The Missouri Compromise was a compromise about slavery. It was made in 1820. Henry Clay was involved. It helped keep the peace for a while.</p>
                <p style="margin-top:8px; font-size:0.85em; color:var(--red);">Too vague, too short (37 words), no specific WHAT or significant WHY.</p>
            </div>
            <div class="compare-block strong">
                <div class="compare-label">‚úÖ Strong Response</div>
                <p>Congress, led by Henry Clay, negotiated the Missouri Compromise in 1820 to resolve a crisis over slavery's expansion. It admitted Missouri as a slave state and Maine as a free state, and drew a line at 36¬∞30'. Its repeal in 1854 helped trigger the sectional conflict leading to the Civil War.</p>
                <p style="margin-top:8px; font-size:0.85em; color:var(--stamp-green);">All five W's. Specific. Clear significance. ‚úì</p>
            </div>
        </div>

        <div style="text-align:center; margin-top:28px;">
            <button class="btn btn-gold" onclick="closeTutorial()" style="padding:12px 36px; font-size:1em;">I'm Ready ‚Äî Close This Guide</button>
        </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURATION ‚Äî UPDATE BEFORE PUBLISHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CANVAS_URL = 'https://modesto.instructure.com/courses/69528/assignments/2259860?module_item_id=5918226';

const SUPABASE_URL  = 'https://bqrluqymscucvbiaaeai.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcmx1cXltc2N1Y3ZiaWFhZWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njg4MTMsImV4cCI6MjA4NDI0NDgxM30.AVOjnQe_TDoWydE2wDP1_YftU1lBkYxcPuyQeZb8Nfs';

const ASSIGNMENT_OPEN       = true;
const SUBMISSION_CUTOFF     = null;
const EXAM_DURATION_MINUTES = 120;
const GRACE_PERIOD_SECONDS  = 60;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INSTRUCTOR PREVIEW MODE
//  Access via: yourpage.html?preview=true
//  - Bypasses Supabase preflight check and attempt logging
//  - Disables timer countdown and expiry
//  - Removes word count minimums on all navigation
//  - Blocks all real Supabase writes
//  - Shows jump navigation bar for instant section access
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PREVIEW_MODE = new URLSearchParams(window.location.search).get('preview') === 'true';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE CLIENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentPhase    = 0;
let examStartTime   = null;
let examEndTime     = null;
let timerInterval   = null;
let graceInterval   = null;
let timeExpired     = false;
let idPhaseLocked   = false;
let attemptId       = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS BUTTON WIRE-UP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('canvas-submit-btn');
    if (btn && CANVAS_URL !== 'CANVAS_URL_PLACEHOLDER') btn.href = CANVAS_URL;
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTimer() {
    examStartTime  = new Date();
    // In preview mode, still show the timer running but never trigger expiry
    timerInterval  = setInterval(updateTimer, 1000);
    updateTimer();
    updateSessionInfo();
}

function updateTimer() {
    if (!examStartTime) return;

    const elapsed      = Math.floor((new Date() - examStartTime) / 1000);
    const totalSeconds = EXAM_DURATION_MINUTES * 60;
    const remaining    = totalSeconds - elapsed;

    const eh = String(Math.floor(elapsed / 3600)).padStart(2,'0');
    const em = String(Math.floor((elapsed % 3600) / 60)).padStart(2,'0');
    const es = String(elapsed % 60).padStart(2,'0');
    const elapsedEl = document.getElementById('elapsedDisplay');
    if (elapsedEl) elapsedEl.textContent = `${eh}:${em}:${es}`;

    const display = document.getElementById('timerDisplay');
    if (!display) return;
    display.classList.remove('countdown-warn','countdown-crit','countdown-done','timer-warning');

    if (remaining <= 0) {
        display.textContent = '0:00:00';
        display.classList.add('countdown-done');
        // Only trigger expiry if NOT in preview mode
        if (!timeExpired && !PREVIEW_MODE) triggerTimeExpired();
        return;
    }

    const rh = Math.floor(remaining / 3600);
    const rm = String(Math.floor((remaining % 3600) / 60)).padStart(2,'0');
    const rs = String(remaining % 60).padStart(2,'0');
    display.textContent = `${rh}:${rm}:${rs}`;

    if      (remaining <= 600)  display.classList.add('countdown-crit');
    else if (remaining <= 1800) display.classList.add('countdown-warn');

    updateSessionInfo();
}

function updateSessionInfo() {
    const el = document.getElementById('sessionInfo');
    if (!examStartTime) { if (el) el.innerHTML = ''; return; }
    if (el) el.innerHTML = `Started: ${examStartTime.toLocaleTimeString()}<br>Current: ${new Date().toLocaleTimeString()}`;
}

function getElapsedString() {
    if (!examStartTime) return 'N/A';
    const elapsed = Math.floor((new Date() - examStartTime) / 1000);
    return `${Math.floor(elapsed/3600)}h ${Math.floor((elapsed%3600)/60)}m ${elapsed%60}s`;
}

function triggerTimeExpired() {
    timeExpired = true;
    clearInterval(timerInterval);
    lockExamFields();
    document.getElementById('timeExpiredOverlay').classList.add('visible');
    let secondsLeft = GRACE_PERIOD_SECONDS;
    document.getElementById('graceCountdown').textContent = secondsLeft;
    graceInterval = setInterval(() => {
        secondsLeft--;
        const cd = document.getElementById('graceCountdown');
        if (cd) cd.textContent = secondsLeft;
        if (secondsLeft <= 0) {
            clearInterval(graceInterval);
            autoForceSubmit();
        }
    }, 1000);
}

function lockExamFields() {
    document.querySelectorAll('input[type="text"], textarea').forEach(el => {
        el.disabled = true;
        el.style.background = '#f0e8d4';
        el.style.color = '#7a6a52';
        el.style.cursor = 'not-allowed';
    });
    document.querySelectorAll('.btn:not(#timeExpiredOverlay .btn)').forEach(el => {
        if (el.id !== 'submitBtn') el.disabled = true;
    });
}

async function autoForceSubmit() {
    document.getElementById('timeExpiredOverlay').classList.remove('visible');
    examEndTime = new Date();
    buildSummary();
    document.getElementById(`phase${currentPhase}`).classList.remove('active');
    document.getElementById('phase7').classList.add('active');
    currentPhase = 7;
    updateProgress();
    window.scrollTo(0,0);
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) submitBtn.disabled = false;
    await submitToSupabase();
}

function manualTimeExpiredSubmit() {
    clearInterval(graceInterval);
    autoForceSubmit();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goToPhase(n) {
    document.getElementById(`phase${currentPhase}`).classList.remove('active');
    document.getElementById(`phase${n}`).classList.add('active');
    currentPhase = n;
    updateProgress();
    updatePreviewNav();
    window.scrollTo(0,0);
    autoSave();
}

function updateProgress() {
    document.querySelectorAll('.prog-step').forEach((el,i) => {
        el.classList.remove('active','done');
        if (i < currentPhase) el.classList.add('done');
        else if (i === currentPhase) el.classList.add('active');
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PREVIEW MODE ‚Äî JUMP NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function previewJump(n) {
    // Fill in dummy student info if jumping past phase 0
    if (n > 0 && !examStartTime) {
        const nameEl = document.getElementById('student-name');
        const idEl   = document.getElementById('student-id');
        const secEl  = document.getElementById('section-number');
        if (!nameEl.value) nameEl.value = 'PREVIEW ‚Äî Prof. Hauselmann';
        if (!idEl.value)   idEl.value   = 'PREVIEW';
        if (!secEl.value)  secEl.value  = '101';
        startTimer();
    }
    if (n >= 6) idPhaseLocked = true;
    if (n === 7) { examEndTime = new Date(); buildSummary(); }
    document.getElementById(`phase${currentPhase}`).classList.remove('active');
    document.getElementById(`phase${n}`).classList.add('active');
    currentPhase = n;
    updateProgress();
    updatePreviewNav();
    window.scrollTo(0, 0);
}

function updatePreviewNav() {
    if (!PREVIEW_MODE) return;
    document.querySelectorAll('#previewNav .pn-btn').forEach((btn, i) => {
        btn.classList.toggle('current', i === currentPhase);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCK SCREEN HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showLockScreen(attemptData) {
    const details = document.getElementById('lockDetails');
    const startedAt = attemptData.started_at
        ? new Date(attemptData.started_at).toLocaleString()
        : 'Unknown';
    const status = attemptData.attempt_status === 'completed' ? 'COMPLETED' : 'IN PROGRESS (or abandoned)';
    details.innerHTML =
        `Student Name: ${attemptData.student_name || '‚Äî'}<br>` +
        `Student ID: ${attemptData.student_id || '‚Äî'}<br>` +
        `Attempt Started: ${startedAt}<br>` +
        `Attempt Status: ${status}`;
    document.getElementById('lockScreen').classList.add('visible');
}

function showPreflight(msg) {
    document.getElementById('preflightStatus').textContent = msg || 'Checking attempt records...';
    document.getElementById('preflightOverlay').classList.add('visible');
}
function hidePreflight() {
    document.getElementById('preflightOverlay').classList.remove('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BEGIN EXAM ‚Äî preflight check then register attempt
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function beginExam() {
    const name      = document.getElementById('student-name').value.trim();
    const studentId = document.getElementById('student-id').value.trim();
    const section   = document.getElementById('section-number').value.trim();

    if (!name) {
        alert('Please enter your full name before beginning.');
        document.getElementById('student-name').focus(); return;
    }
    if (!studentId) {
        alert('Please enter your Student ID before beginning.');
        document.getElementById('student-id').focus(); return;
    }
    if (!section) {
        alert('Please enter your section number.');
        document.getElementById('section-number').focus(); return;
    }

    const beginBtn = document.getElementById('beginBtn');
    const errDiv   = document.getElementById('beginError');
    beginBtn.disabled = true;
    errDiv.style.display = 'none';

    // ‚îÄ‚îÄ PREVIEW MODE: skip all DB checks and just start ‚îÄ‚îÄ
    if (PREVIEW_MODE) {
        startTimer();
        goToPhase(1);
        return;
    }

    // ‚îÄ‚îÄ STEP 1: Check for existing attempt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    showPreflight('Checking attempt records for Student ID ' + studentId + '‚Ä¶');

    try {
        const { data: existing, error: checkErr } = await supabaseClient
            .from('exam_attempts')
            .select('id, student_name, student_id, started_at, attempt_status')
            .eq('student_id', studentId.toLowerCase().trim())
            .eq('worksheet_type', 'hist101-final-exam')
            .limit(1);

        if (checkErr) {
            console.error('Preflight check error:', checkErr);
            hidePreflight();
            showBeginError(`Warning: We could not verify your eligibility (network error). Your attempt will be recorded. If this is your first attempt, you may proceed.`, true);
            beginBtn.disabled = false;
            await registerAttemptAndStart(name, studentId, section);
            return;
        }

        if (existing && existing.length > 0) {
            hidePreflight();
            showLockScreen(existing[0]);
            await supabaseClient.from('exam_attempts').insert({
                student_name:   name,
                student_id:     studentId.toLowerCase().trim(),
                section_number: section,
                worksheet_type: 'hist101-final-exam',
                attempt_status: 'blocked',
                started_at:     new Date().toISOString(),
                notes:          `Blocked: prior attempt ID ${existing[0].id} found`
            });
            return;
        }

        hidePreflight();
        await registerAttemptAndStart(name, studentId, section);

    } catch (e) {
        console.error('Unexpected preflight error:', e);
        hidePreflight();
        beginBtn.disabled = false;
        await registerAttemptAndStart(name, studentId, section);
    }
}

async function registerAttemptAndStart(name, studentId, section) {
    try {
        const { data, error } = await supabaseClient
            .from('exam_attempts')
            .insert({
                student_name:   name,
                student_id:     studentId.toLowerCase().trim(),
                section_number: section,
                worksheet_type: 'hist101-final-exam',
                attempt_status: 'started',
                started_at:     new Date().toISOString()
            })
            .select('id')
            .single();

        if (!error && data) {
            attemptId = data.id;
        } else {
            console.error('Attempt registration error:', error);
        }
    } catch(e) {
        console.error('Attempt registration exception:', e);
    }

    startTimer();
    goToPhase(1);
}

function showBeginError(msg, isWarning = false) {
    const errDiv = document.getElementById('beginError');
    errDiv.innerHTML = `<div class="${isWarning ? 'notice' : 'error-msg'}">${msg}</div>`;
    errDiv.style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ID ADVANCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function advanceID(idNum) {
    // Preview mode: skip all validation
    if (PREVIEW_MODE) { goToPhase(idNum + 1); return; }

    const response = document.getElementById(`id${idNum}-response`).value.trim();
    const citation = document.getElementById(`id${idNum}-citation`).value.trim();
    if (!response) { alert('Please write your response before continuing.'); return; }
    const wc = countWords(response);
    if (wc < 75) { alert(`Your response is only ${wc} words. You need at least 75 words.`); return; }
    if (wc > 150) { alert(`Your response is ${wc} words, which exceeds the 150-word maximum. Please trim your response.`); return; }
    if (!citation) { alert('Please include a citation before continuing.'); document.getElementById(`id${idNum}-citation`).focus(); return; }
    goToPhase(idNum + 1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADVANCE TO ESSAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function advanceToEssay() {
    // Preview mode: skip all validation and confirmation
    if (PREVIEW_MODE) { idPhaseLocked = true; goToPhase(6); return; }

    const response = document.getElementById('id5-response').value.trim();
    const citation = document.getElementById('id5-citation').value.trim();
    if (!response) { alert('Please complete ID 5 before advancing.'); return; }
    const wc = countWords(response);
    if (wc < 75) { alert(`Your response for ID 5 is only ${wc} words. You need at least 75 words.`); return; }
    if (wc > 150) { alert(`Your response for ID 5 exceeds 150 words. Please trim it.`); return; }
    if (!citation) { alert('Please include a citation for ID 5.'); document.getElementById('id5-citation').focus(); return; }
    const confirmed = confirm('‚ö†Ô∏è WARNING: Once you advance to Part II, you cannot return to Part I. Are you sure all five identifications are complete?');
    if (!confirmed) return;
    idPhaseLocked = true;
    goToPhase(6);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADVANCE TO SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function advanceToSubmit() {
    // Preview mode: skip all validation
    if (PREVIEW_MODE) { examEndTime = new Date(); buildSummary(); goToPhase(7); return; }

    const essay = document.getElementById('essay-response').value.trim();
    if (!essay && !timeExpired) { alert('Please write your essay before submitting.'); return; }
    if (!timeExpired) {
        const wc = countWords(essay);
        if (wc < 500) { alert(`Your essay is only ${wc} words. You need at least 500 words.`); return; }
        if (wc > 1000) { alert(`Your essay is ${wc} words, which exceeds the 1,000-word maximum. Please trim your response.`); return; }
    }
    examEndTime = new Date();
    clearInterval(timerInterval);
    buildSummary();
    goToPhase(7);
}

function buildSummary() {
    const name      = document.getElementById('student-name').value.trim();
    const studentId = document.getElementById('student-id').value.trim();
    const section   = document.getElementById('section-number').value.trim();
    const elapsed   = getElapsedString();
    const startStr  = examStartTime ? examStartTime.toLocaleString() : 'N/A';
    const endStr    = examEndTime   ? examEndTime.toLocaleString()   : 'N/A';
    const essayWC   = countWords(document.getElementById('essay-response').value);
    const terms = ['‚Äî','The Great Compromise','Manifest Destiny','The Dred Scott Decision','The Emancipation Proclamation',"The Freedmen's Bureau"];
    const idWords = [1,2,3,4,5].map(i => {
        const wc = countWords(document.getElementById(`id${i}-response`).value);
        return `ID ${i} (${terms[i]}): ${wc} words`;
    }).join('<br>');
    document.getElementById('exam-summary').innerHTML =
        `<strong>Student:</strong> ${name} &nbsp;|&nbsp; <strong>ID:</strong> ${studentId} &nbsp;|&nbsp; <strong>Section:</strong> ${section}<br>` +
        `<strong>Exam Started:</strong> ${startStr}<br>` +
        `<strong>Exam Completed:</strong> ${endStr}<br>` +
        `<strong>Total Time:</strong> ${elapsed}<br><br>` +
        idWords + `<br><strong>Essay:</strong> ${essayWC} words`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WORD COUNT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function countWords(text) {
    if (!text || !text.trim()) return 0;
    return text.trim().split(/\s+/).length;
}
function updateWordCount(textareaId, displayId, min, max) {
    try {
        const el = document.getElementById(textareaId);
        const display = document.getElementById(displayId);
        if (!el || !display) return;
        const wc = countWords(el.value);
        display.textContent = wc;
        display.className = 'wc-number';
        if (wc >= min && wc <= max) display.classList.add('wc-ok');
        else if (wc > max) display.classList.add('wc-over');
        else if (wc > 0) display.classList.add('wc-warn');
    } catch(e) { console.warn('Word count error:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(tabId, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TUTORIAL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openTutorial() {
    document.getElementById('tutorialModal').classList.add('open');
    document.body.style.overflow = 'hidden';
}
function closeTutorial() {
    document.getElementById('tutorialModal').classList.remove('open');
    document.body.style.overflow = '';
}
function closeTutorialOnOverlay(e) {
    if (e.target === document.getElementById('tutorialModal')) closeTutorial();
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTutorial(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PASTE PREVENTION (disabled in preview mode)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('paste', function(e) {
    if (PREVIEW_MODE) return; // Allow paste in preview
    const target = e.target;
    if (target.tagName !== 'INPUT' && target.tagName !== 'TEXTAREA') return;
    if (target.id === 'essay-notes') return;
    const text = (e.clipboardData || window.clipboardData) && e.clipboardData.getData('text');
    if (text === undefined || text === null) return;
    e.preventDefault();
    target.style.outline = '3px solid #8b1a1a';
    const old = document.getElementById('paste-toast');
    if (old) old.remove();
    const msg = document.createElement('div');
    msg.id = 'paste-toast';
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#8b1a1a;color:#fff;padding:12px 24px;font-family:Georgia,serif;letter-spacing:1px;font-size:0.95em;z-index:9999;border:2px solid #f5edda;box-shadow:4px 4px 0 rgba(0,0,0,0.4);';
    msg.textContent = '‚ö†Ô∏è Paste is not permitted on this exam.';
    document.body.appendChild(msg);
    setTimeout(() => { target.style.outline = ''; if (msg.parentNode) msg.remove(); }, 2000);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BEFOREUNLOAD WARNING (disabled in preview mode)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('beforeunload', function(e) {
    if (PREVIEW_MODE) return; // No warning in preview
    if (currentPhase > 0 && currentPhase < 7) {
        e.preventDefault();
        e.returnValue = 'You have an exam in progress. Are you sure you want to leave? Your work may be lost.';
        return e.returnValue;
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTO SAVE (disabled in preview mode)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function collectState() {
    const state = { phase: currentPhase, startTime: examStartTime ? examStartTime.toISOString() : null };
    document.querySelectorAll('input[type=text], textarea').forEach(el => { if (el.id) state[el.id] = el.value; });
    return state;
}
function autoSave() {
    if (PREVIEW_MODE) return; // Don't save preview sessions to localStorage
    localStorage.setItem('hist101FinalExam', JSON.stringify(collectState()));
}
setInterval(autoSave, 30000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PDF GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildPDFDoc() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    const lh = 7, ph = doc.internal.pageSize.height, m = 20;
    const name      = document.getElementById('student-name').value.trim();
    const studentId = document.getElementById('student-id').value.trim();
    const section   = document.getElementById('section-number').value.trim();
    const startStr  = examStartTime ? examStartTime.toLocaleString() : 'N/A';
    const endStr    = examEndTime   ? examEndTime.toLocaleString()   : new Date().toLocaleString();
    const elapsed   = getElapsedString();

    function addText(text, size=11, bold=false) {
        doc.setFontSize(size); doc.setFont(undefined, bold ? 'bold' : 'normal');
        const lines = doc.splitTextToSize(String(text || '[Not answered]'), 170);
        lines.forEach(l => {
            if (y > ph - m) { doc.addPage(); y = 20; }
            doc.text(l, 20, y); y += lh;
        });
        y += 3;
    }

    addText('HIST 101 ‚Äî Final Examination', 16, true); y += 2;
    addText('American History to 1877 ¬∑ Prof. Hauselmann', 12);
    if (PREVIEW_MODE) addText('[INSTRUCTOR PREVIEW ‚Äî NOT A STUDENT SUBMISSION]', 11, true);
    addText(`Student: ${name}`, 12, true);
    addText(`Student ID: ${studentId}`, 12, true);
    if (section) addText(`Section: ${section}`, 12, true);
    addText(`Exam Started: ${startStr}`, 10);
    addText(`Exam Completed: ${endStr}`, 10);
    addText(`Total Time: ${elapsed}`, 10); y += 4;

    addText('PART I ‚Äî HISTORICAL IDENTIFICATIONS', 14, true);
    const terms = ['The Great Compromise','Manifest Destiny','The Dred Scott Decision','The Emancipation Proclamation',"The Freedmen's Bureau"];
    for (let i = 1; i <= 5; i++) {
        addText(`Identification ${i}: ${terms[i-1]}`, 12, true);
        const wc = countWords(document.getElementById(`id${i}-response`).value);
        addText(`[Word count: ${wc}]`, 9);
        addText(document.getElementById(`id${i}-response`).value);
        addText(`Citation: ${document.getElementById(`id${i}-citation`).value}`, 10);
        y += 4;
    }

    addText('PART II ‚Äî SOURCE ANALYSIS ESSAY', 14, true);
    addText('Essay Question: Were African Americans free during Reconstruction?', 11, true); y += 2;
    const essayWC = countWords(document.getElementById('essay-response').value);
    addText(`[Word count: ${essayWC}]`, 9);
    if (document.getElementById('essay-notes').value.trim()) {
        addText('Document Notes (not graded):', 10, true);
        addText(document.getElementById('essay-notes').value, 10);
        y += 2;
    }
    addText('Essay Response:', 11, true);
    addText(document.getElementById('essay-response').value);
    return doc;
}

function downloadPDF() {
    const name = document.getElementById('student-name').value.trim();
    if (!name) { alert('Please enter your name.'); return; }
    try {
        const doc = buildPDFDoc();
        const dateStr = new Date().toISOString().split('T')[0];
        const studentId = document.getElementById('student-id').value.trim();
        const prefix = PREVIEW_MODE ? 'PREVIEW_' : '';
        doc.save(`${prefix}HIST101_FinalExam_${name.replace(/\s+/g,'_')}_${studentId}_${dateStr}.pdf`);
    } catch(e) { console.error(e); alert('Error generating PDF: ' + e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function submitToSupabase() {
    // Preview mode: block all real submissions
    if (PREVIEW_MODE) {
        document.getElementById('submitMessage').innerHTML =
            '<div class="notice" style="font-family:\'Special Elite\',monospace; letter-spacing:1px;">üîç <strong>Preview Mode</strong> ‚Äî No data submitted to Supabase. PDF download still works normally.</div>';
        return;
    }

    if (!ASSIGNMENT_OPEN) {
        document.getElementById('submitMessage').innerHTML = '<div class="error-msg">‚ùå This assignment is now closed. Please contact Prof. Hauselmann.</div>'; return;
    }
    if (SUBMISSION_CUTOFF && new Date() > new Date(SUBMISSION_CUTOFF)) {
        document.getElementById('submitMessage').innerHTML = '<div class="error-msg">‚ùå Submission deadline has passed. Contact Prof. Hauselmann.</div>'; return;
    }

    const name      = document.getElementById('student-name').value.trim();
    const studentId = document.getElementById('student-id').value.trim();
    const section   = document.getElementById('section-number').value.trim();
    if (!name || !studentId) { alert('Student name and ID are required.'); return; }

    const btn = document.getElementById('submitBtn');
    const msg = document.getElementById('submitMessage');
    btn.disabled = true; btn.textContent = '‚è≥ Submitting...';
    msg.innerHTML = '<div style="padding:14px;color:var(--faded);font-style:italic;">Generating and uploading your exam...</div>';

    try {
        const doc  = buildPDFDoc();
        const blob = doc.output('blob');
        const ts   = new Date().toISOString().replace(/[:.]/g,'-');
        const safeName = name.replace(/[^a-zA-Z0-9]/g,'_');
        const safeId   = studentId.replace(/[^a-zA-Z0-9]/g,'_');
        const filePath = `hist101-final/${section}/${safeName}_${safeId}_${ts}.pdf`;

        const { error: upErr } = await supabaseClient.storage
            .from('student-submissions')
            .upload(filePath, blob, { contentType: 'application/pdf', upsert: false });
        if (upErr) throw new Error(upErr.message);

        const { data: urlData } = supabaseClient.storage
            .from('student-submissions')
            .getPublicUrl(filePath);

        const allData = {};
        document.querySelectorAll('input[type=text], textarea').forEach(el => {
            if (el.id) allData[el.id] = el.value;
        });

        await supabaseClient.from('worksheet_submissions').insert({
            student_name:   name,
            section_number: section,
            worksheet_type: 'hist101-final-exam',
            file_path:      filePath,
            file_url:       urlData.publicUrl,
            form_data: {
                ...allData,
                student_id:       studentId,
                exam_start_time:  examStartTime ? examStartTime.toISOString() : null,
                exam_end_time:    examEndTime   ? examEndTime.toISOString()   : new Date().toISOString(),
                elapsed_time:     getElapsedString()
            },
            submitted_at: new Date().toISOString()
        });

        if (attemptId) {
            await supabaseClient
                .from('exam_attempts')
                .update({
                    attempt_status: 'completed',
                    completed_at:   new Date().toISOString(),
                    file_url:       urlData.publicUrl
                })
                .eq('id', attemptId);
        }

        msg.innerHTML = '<div class="success-msg">‚úÖ Successfully submitted to Prof. Hauselmann. Remember to also upload your PDF to Canvas.</div>';
        btn.textContent = '‚úì Submitted';

    } catch(e) {
        console.error(e);
        msg.innerHTML = `<div class="error-msg">‚ùå Submission failed: ${e.message}. Download the PDF and submit it to Canvas as a backup.</div>`;
        btn.disabled = false; btn.textContent = 'üì§ Submit to Prof. Hauselmann';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT / RESTORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onload = () => {
    // ‚îÄ‚îÄ PREVIEW MODE INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (PREVIEW_MODE) {
        document.getElementById('previewBanner').style.display = 'block';
        document.getElementById('previewNav').style.display = 'block';
        updateProgress();
        updatePreviewNav();
        return; // Skip localStorage restore entirely in preview
    }

    // ‚îÄ‚îÄ NORMAL STUDENT INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const saved = localStorage.getItem('hist101FinalExam');
    if (saved) {
        try {
            const state = JSON.parse(saved);
            if (state.phase && parseInt(state.phase) > 0) {
                const restore = confirm(
                    'A previous exam session was found in this browser.\n\n' +
                    'If this is your session and your browser crashed, click OK to restore your work.\n\n' +
                    'IMPORTANT: If this is a shared computer and this is not your session, click Cancel and do not proceed.'
                );
                if (restore) {
                    Object.entries(state).forEach(([id, val]) => {
                        if (id === 'phase' || id === 'startTime') return;
                        const el = document.getElementById(id);
                        if (el) el.value = val;
                    });
                    if (state.startTime) {
                        examStartTime  = new Date(state.startTime);
                        const elapsed = Math.floor((new Date() - examStartTime) / 1000);
                        if (elapsed >= EXAM_DURATION_MINUTES * 60) {
                            timerInterval = setInterval(updateTimer, 1000);
                            updateTimer();
                            triggerTimeExpired();
                        } else {
                            timerInterval  = setInterval(updateTimer, 1000);
                            updateTimer(); updateSessionInfo();
                        }
                    }
                    const phase = parseInt(state.phase);
                    currentPhase = phase;
                    document.getElementById('phase0').classList.remove('active');
                    document.getElementById(`phase${phase}`).classList.add('active');
                    updateProgress();
                    if (phase >= 6) idPhaseLocked = true;
                    [1,2,3,4,5].forEach(i => {
                        const el = document.getElementById(`id${i}-response`);
                        if (el && el.value) updateWordCount(`id${i}-response`,`id${i}-wc`,75,150);
                    });
                    const essayEl = document.getElementById('essay-response');
                    if (essayEl && essayEl.value) updateWordCount('essay-response','essay-wc',500,1000);
                } else {
                    localStorage.removeItem('hist101FinalExam');
                }
            }
        } catch(e) { console.error('Restore error:', e); }
    }
    updateProgress();
};
</script>
</body>
</html>
