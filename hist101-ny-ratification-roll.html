

<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Ratification 1788 Â· Roll Sheet</title> <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Libre+Baskerville:ital,wght@0,400;0

pasted

For some reason th page gets stuck on the page and says loading.

7:27 PM
Looking at the code, the loading overlay is hidden only inside the onAuthStateChange callback. If Supabase fails to initialize or the auth state change never fires, the overlay just sits there forever.

The most likely culprit: the Supabase JS library loads from a CDN, and your network settings show external network access is disabled in this environment â€” but more practically for your deployed page, the issue is that onAuthStateChange may not fire quickly enough, or there's a silent initialization error.

Here are the fixes:


Editing file
Editing file
Let me just give you the corrected script section directly â€” here's what to change and why:

Root causes:

onAuthStateChange sometimes doesn't fire if the Supabase client has a network hiccup or the session check stalls
There's no fallback to dismiss the overlay
Three targeted fixes:

Fix 1 â€” Add a timeout fallback right before sb.auth.onAuthStateChange(...):

javascript
// Safety fallback â€” if auth state never fires, show login after 6s
setTimeout(() => {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay && overlay.style.display !== 'none') {
    overlay.style.display = 'none';
    document.getElementById('authScreen').style.display = 'flex';
  }
}, 6000);
Fix 2 â€” Also check getSession() immediately (more reliable than waiting for the event):

javascript
// Check session directly on load â€” don't rely solely on the event
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  document.getElementById('loadingOverlay').style.display = 'none';
  if (session?.user) {
    currentUser = session.user;
    document.getElementById('userEmail').textContent = session.user.email;
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';
    await renderSection(currentSection);
  } else {
    document.getElementById('authScreen').style.display = 'flex';
  }
})();
Fix 3 â€” Wrap Supabase client creation in a try/catch to catch any init errors silently failing:

javascript
let sb;
try {
  sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
} catch(e) {
  document.getElementById('loadingOverlay').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
  console.error('Supabase init failed:', e);
}
The most impactful fix is #2 â€” calling getSession() directly rather than waiting for the auth state change event. The event is designed for changes, not initial load detection, so on first page load it can be unreliable. Add all three for robustness.

Can you rewrite the whole thing?

7:28 PM

Viewed a file, created a file, read a file
Viewed a file, created a file, read a file
Here's the full rewrite. Key improvements:

Auth fix (the main bug): The old version relied entirely on onAuthStateChange to dismiss the loading screen â€” which can stall on first load. The new version calls sb.auth.getSession() directly and immediately on startup, which reads the cached token without any network round-trip. The event listener is still there for sign-in/sign-out changes, but it's no longer responsible for the initial load. A 7-second fallback timeout is also in place as a last resort.

Other improvements:

Supabase client creation is wrapped in a try/catch so any init error gracefully drops to the login screen instead of freezing
Loading overlay fades out smoothly instead of just snapping off
Refreshed visual design â€” Playfair Display + Crimson Pro typography, deeper ink tones, cleaner stat chips, and more polished faction/vote cards
All the same data (delegates, factions, sections, vote tracker, notes) is preserved exactly
Ratification roll
Code Â· HTML 





Claude is AI and can make mistakes. Please double-check responses.
Ratification roll Â· HTML
Copy

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raising the Eleventh Pillar Â· Roll Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --ink:         #18120a;
  --ink-mid:     #3c2c14;
  --ink-soft:    #6b4e24;
  --parch:       #faf3e0;
  --parch-dark:  #ede0c4;
  --parch-warm:  #f5e8c8;
  --gold:        #9a7b2f;
  --gold-lit:    #c9a84c;
  --gold-pale:   #e8d5a0;
  --red:         #7a1c1c;
  --red-bg:      #fae8e8;
  --blue:        #1a3457;
  --blue-bg:     #e4ecf7;
  --green:       #1e4a28;
  --green-bg:    #e2f0e5;
  --shadow:      rgba(24,18,10,.18);
  --shadow-sm:   rgba(24,18,10,.09);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Crimson Pro', Georgia, serif;
  background: var(--ink-mid);
  background-image:
    repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(0,0,0,.03) 28px, rgba(0,0,0,.03) 29px),
    repeating-linear-gradient(90deg, transparent, transparent 28px, rgba(0,0,0,.03) 28px, rgba(0,0,0,.03) 29px);
  color: var(--ink);
  min-height: 100vh;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOADING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loadingOverlay {
  position: fixed; inset: 0;
  background: var(--ink-mid);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 18px; z-index: 9999;
  transition: opacity .4s ease;
}
#loadingOverlay.fade-out { opacity: 0; pointer-events: none; }

.loader-emblem {
  font-size: 2.4rem;
  animation: bob 2s ease-in-out infinite;
}
@keyframes bob {
  0%,100% { transform: translateY(0); }
  50%      { transform: translateY(-6px); }
}
.loader-text {
  font-family: 'Playfair Display', serif;
  font-size: 1rem; font-style: italic;
  color: var(--gold-pale); letter-spacing: .12em;
}
.loader-bar {
  width: 160px; height: 2px;
  background: rgba(255,255,255,.1); border-radius: 2px; overflow: hidden;
}
.loader-bar-fill {
  height: 100%; width: 40%;
  background: var(--gold-lit);
  animation: slide 1.2s ease-in-out infinite alternate;
  border-radius: 2px;
}
@keyframes slide {
  from { transform: translateX(-100%); }
  to   { transform: translateX(350%); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   AUTH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#authScreen {
  display: none; min-height: 100vh;
  align-items: center; justify-content: center;
  padding: 24px;
  background: var(--ink-mid);
  background-image:
    radial-gradient(ellipse 70% 50% at 30% 40%, rgba(154,123,47,.15) 0%, transparent 60%),
    radial-gradient(ellipse 60% 60% at 80% 70%, rgba(26,52,87,.2) 0%, transparent 60%);
}

.auth-wrap {
  width: 100%; max-width: 420px;
  background: var(--parch);
  border-radius: 2px;
  border: 1px solid var(--parch-dark);
  box-shadow: 0 24px 60px rgba(0,0,0,.45), 0 2px 0 var(--gold) inset;
  overflow: hidden;
  animation: rise .5s cubic-bezier(.2,.8,.3,1) both;
}
@keyframes rise {
  from { opacity:0; transform: translateY(20px); }
  to   { opacity:1; transform: translateY(0); }
}

.auth-masthead {
  background: var(--ink);
  padding: 32px 36px 28px;
  text-align: center;
  border-bottom: 3px solid var(--gold);
  position: relative; overflow: hidden;
}
.auth-masthead::before {
  content: '';
  position: absolute; inset: 0;
  background: repeating-linear-gradient(
    45deg, transparent, transparent 8px,
    rgba(154,123,47,.04) 8px, rgba(154,123,47,.04) 9px
  );
}
.auth-seal {
  font-size: 2.2rem; line-height: 1;
  margin-bottom: 12px; position: relative;
}
.auth-masthead h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem; font-weight: 600;
  color: var(--parch-warm); margin-bottom: 5px; position: relative;
}
.auth-masthead p {
  font-size: .78rem; color: var(--gold-pale);
  font-style: italic; opacity: .7; position: relative;
}

.auth-body { padding: 28px 36px 32px; }

.tab-row {
  display: flex; border: 1px solid var(--parch-dark);
  border-radius: 3px; overflow: hidden; margin-bottom: 24px;
}
.tab-btn {
  flex: 1; padding: 9px 12px; border: none; cursor: pointer;
  font-family: 'Crimson Pro', serif; font-size: .88rem;
  background: var(--parch-dark); color: var(--ink-soft);
  transition: all .15s; letter-spacing: .03em;
}
.tab-btn.active { background: var(--ink); color: var(--parch-warm); }
.tab-btn:hover:not(.active) { background: var(--parch-warm); }

.field { margin-bottom: 18px; }
.field label {
  display: block; font-size: .7rem; font-weight: 600;
  letter-spacing: .1em; text-transform: uppercase;
  color: var(--ink-soft); margin-bottom: 6px;
}
.field input {
  width: 100%; padding: 9px 13px;
  font-family: 'Crimson Pro', serif; font-size: .95rem;
  border: 1px solid var(--parch-dark); border-radius: 2px;
  background: #fff; color: var(--ink); outline: none;
  transition: border-color .15s, box-shadow .15s;
}
.field input:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(154,123,47,.12);
}

.auth-submit {
  width: 100%; padding: 12px;
  background: var(--ink); color: var(--parch-warm);
  border: none; border-radius: 2px; cursor: pointer;
  font-family: 'Playfair Display', serif; font-size: 1rem;
  font-style: italic; letter-spacing: .06em;
  transition: background .15s; margin-top: 6px;
}
.auth-submit:hover { background: var(--ink-mid); }
.auth-submit:disabled { opacity: .5; cursor: not-allowed; }

.auth-alert {
  margin-top: 14px; padding: 10px 13px;
  border-radius: 2px; font-size: .82rem; display: none;
}
.auth-alert.err { background: #f8e0e0; border: 1px solid #e0b0b0; color: #7a2020; }
.auth-alert.ok  { background: #e0f0e4; border: 1px solid #a0cca8; color: #1e5a2a; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   APP SHELL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#appScreen { display: none; min-height: 100vh; }

.topbar {
  position: sticky; top: 0; z-index: 200;
  background: var(--ink);
  border-bottom: 3px solid var(--gold);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px; height: 54px;
  box-shadow: 0 4px 20px rgba(0,0,0,.35);
}
.topbar-brand {
  display: flex; align-items: center; gap: 10px;
}
.topbar-brand .seal { font-size: 1.2rem; }
.topbar-brand h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem; font-weight: 600; font-style: italic;
  color: var(--parch-warm); letter-spacing: .04em;
}
.topbar-brand h1 span { color: var(--gold-lit); }
.topbar-right { display: flex; align-items: center; gap: 16px; }
.save-pill {
  font-size: .7rem; font-style: italic;
  color: rgba(250,243,224,.4); transition: color .3s;
}
.save-pill.ok { color: #7ecf7e; }
.user-badge {
  font-size: .7rem; color: rgba(250,243,224,.4);
  max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.sign-out-btn {
  padding: 5px 14px;
  background: transparent;
  border: 1px solid rgba(154,123,47,.35);
  border-radius: 2px; cursor: pointer;
  font-family: 'Crimson Pro', serif; font-size: .78rem;
  color: rgba(250,243,224,.5); transition: all .15s;
}
.sign-out-btn:hover { background: rgba(250,243,224,.08); color: var(--parch-warm); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SECTION TABS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-nav {
  display: flex; gap: 6px; flex-wrap: wrap;
  max-width: 1020px; margin: 28px auto 0; padding: 0 22px;
}
.sec-tab {
  padding: 9px 26px;
  font-family: 'Playfair Display', serif;
  font-size: .9rem; font-style: italic;
  border: 2px solid rgba(250,243,224,.18);
  border-bottom: none;
  border-radius: 4px 4px 0 0;
  background: rgba(24,18,10,.4);
  color: rgba(250,243,224,.5);
  cursor: pointer; transition: all .2s;
}
.sec-tab:hover:not(.active) { background: rgba(24,18,10,.6); color: rgba(250,243,224,.8); }
.sec-tab.active {
  background: var(--parch);
  color: var(--ink); border-color: var(--parch-dark);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MAIN PANEL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel {
  max-width: 1020px; margin: 0 auto;
  padding: 0 22px 60px;
}

.sheet {
  background: var(--parch);
  border: 1px solid var(--parch-dark);
  border-radius: 0 4px 4px 4px;
  box-shadow: 0 12px 40px var(--shadow), 0 2px 8px var(--shadow-sm);
  overflow: hidden;
}

/* Sheet header */
.sheet-header {
  background: var(--ink);
  padding: 26px 32px;
  display: flex; align-items: flex-start;
  justify-content: space-between; gap: 20px; flex-wrap: wrap;
  border-bottom: 3px solid var(--gold);
  position: relative; overflow: hidden;
}
.sheet-header::after {
  content: '1788';
  position: absolute; right: 32px; bottom: -12px;
  font-family: 'Playfair Display', serif;
  font-size: 5rem; font-weight: 700;
  color: rgba(154,123,47,.08); letter-spacing: -.02em;
  pointer-events: none; user-select: none;
}
.sheet-header h2 {
  font-family: 'Playfair Display', serif;
  font-size: 1.45rem; font-weight: 600;
  color: var(--parch-warm); margin-bottom: 4px;
}
.sheet-header p {
  font-size: .8rem; color: var(--gold-pale);
  font-style: italic; opacity: .7;
}
.date-field {
  display: flex; align-items: center; gap: 10px; position: relative; z-index: 1;
}
.date-field label {
  font-size: .7rem; letter-spacing: .1em; text-transform: uppercase;
  color: rgba(250,243,224,.4);
}
.date-input {
  font-family: 'Crimson Pro', serif; font-size: .88rem;
  padding: 7px 13px;
  background: rgba(250,243,224,.08);
  border: 1px solid rgba(154,123,47,.35);
  border-radius: 2px; color: var(--parch-warm); outline: none;
  transition: border-color .15s;
}
.date-input:focus { border-color: var(--gold-lit); }

/* Stats bar */
.stats-bar {
  display: flex; gap: 0; border-bottom: 1px solid var(--parch-dark);
  background: var(--parch-warm);
  flex-wrap: wrap;
}
.stat-chip {
  padding: 9px 20px; font-size: .78rem;
  border-right: 1px solid var(--parch-dark);
  display: flex; align-items: center; gap: 7px;
}
.stat-chip:last-child { border-right: none; }
.stat-chip .val {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem; font-weight: 600; line-height: 1;
}
.stat-chip .lbl { color: var(--ink-soft); }
.val-present { color: var(--green); }
.val-absent  { color: var(--red); }
.val-assign  { color: var(--gold); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   FACTION BLOCKS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.faction-block { border-bottom: 1px solid var(--parch-dark); }
.faction-block:last-of-type { border-bottom: none; }

.faction-head {
  display: flex; align-items: center; gap: 12px;
  padding: 13px 28px 12px;
  cursor: pointer; user-select: none;
  border-bottom: 1px solid var(--parch-dark);
  transition: background .12s;
}
.faction-head:hover { background: rgba(154,123,47,.04); }

.faction-head.fed  { border-left: 5px solid var(--blue); background: linear-gradient(90deg, var(--blue-bg), var(--parch) 65%); }
.faction-head.anti { border-left: 5px solid var(--red);  background: linear-gradient(90deg, var(--red-bg),  var(--parch) 65%); }
.faction-head.mod  { border-left: 5px solid var(--green); background: linear-gradient(90deg, var(--green-bg), var(--parch) 65%); }

.f-tag {
  font-size: .6rem; font-weight: 700; letter-spacing: .14em;
  text-transform: uppercase; padding: 3px 9px; border-radius: 2px;
}
.fed  .f-tag { background: var(--blue); color: #fff; }
.anti .f-tag { background: var(--red);  color: #fff; }
.mod  .f-tag { background: var(--green); color: #fff; }

.faction-head h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem; font-style: italic; flex: 1;
  color: var(--ink);
}
.f-count { font-size: .72rem; color: var(--ink-soft); font-style: italic; }
.f-chev { color: var(--gold); font-size: .75rem; transition: transform .22s; }
.faction-block.closed .f-chev { transform: rotate(-90deg); }
.faction-block.closed .delegate-table { display: none; }

/* Delegate table */
.delegate-table { width: 100%; border-collapse: collapse; }
.d-row {
  border-bottom: 1px dashed var(--parch-dark);
  transition: background .1s;
}
.d-row:last-child { border-bottom: none; }
.d-row:hover { background: rgba(154,123,47,.04); }

.td-num {
  width: 38px; padding: 11px 6px 11px 28px;
  font-size: .66rem; color: rgba(61,43,14,.3);
  font-style: italic; vertical-align: middle;
}
.td-info {
  padding: 11px 14px; vertical-align: middle;
}
.d-name {
  font-weight: 600; font-size: .9rem; color: var(--ink);
  display: inline;
}
.d-star {
  font-size: .6rem; font-weight: 700; letter-spacing: .1em; text-transform: uppercase;
  color: var(--gold); margin-left: 7px; vertical-align: middle;
}
.d-role {
  font-size: .7rem; color: var(--gold); font-style: italic; margin-left: 8px;
}
.d-county { font-size: .75rem; color: var(--ink-soft); font-style: italic; margin-top: 2px; }

.td-student {
  padding: 8px 12px; vertical-align: middle; width: 220px;
}
.student-inp {
  width: 100%; padding: 7px 10px;
  font-family: 'Crimson Pro', serif; font-size: .88rem;
  border: 1px solid var(--parch-dark); border-radius: 2px;
  background: #fff; color: var(--ink); outline: none;
  transition: border-color .15s, background .15s;
}
.student-inp:focus { border-color: var(--gold); }
.student-inp.has-val { background: #fffdf5; border-color: var(--gold-pale); }

.td-att {
  width: 68px; text-align: center;
  padding: 8px 6px; vertical-align: middle;
}
.att-btn {
  width: 32px; height: 32px; border-radius: 50%;
  border: 2px solid var(--parch-dark);
  background: #fff; cursor: pointer; font-size: 1rem;
  display: inline-flex; align-items: center; justify-content: center;
  color: transparent; transition: all .15s;
}
.att-btn.present { background: #d4f0da; border-color: #5a9a6a; color: #1e6030; }
.att-btn.absent  { background: #f0d4d4; border-color: #b06060; color: #6a1c1c; }
.att-btn:hover { transform: scale(1.1); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   VOTE TRACKER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vote-section {
  padding: 22px 32px;
  border-top: 2px solid var(--parch-dark);
  background: rgba(154,123,47,.03);
}
.section-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem; font-style: italic;
  color: var(--ink); margin-bottom: 16px;
  display: flex; align-items: center; gap: 8px;
}
.section-title::after {
  content: ''; flex: 1; height: 1px;
  background: var(--parch-dark); margin-left: 4px;
}

.vote-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px,1fr)); gap: 12px; }

.vote-card {
  background: var(--parch-warm);
  border: 1px solid var(--parch-dark); border-radius: 3px;
  padding: 14px 16px;
  box-shadow: 0 2px 8px var(--shadow-sm);
}
.vc-title {
  font-family: 'Playfair Display', serif;
  font-size: .88rem; font-style: italic;
  margin-bottom: 10px; color: var(--ink);
}
.vc-btns { display: flex; gap: 7px; align-items: center; flex-wrap: wrap; }
.vc-lbl { font-size: .7rem; color: var(--ink-soft); width: 74px; }
.vbtn {
  font-family: 'Crimson Pro', serif; font-size: .78rem;
  padding: 4px 12px; border-radius: 2px;
  border: 1px solid var(--parch-dark);
  background: #fff; cursor: pointer; transition: all .15s;
}
.vbtn:hover { background: var(--parch-dark); }
.vbtn.sel-fed  { background: var(--blue);  color: #fff; border-color: var(--blue); }
.vbtn.sel-anti { background: var(--red);   color: #fff; border-color: var(--red); }
.vc-result {
  margin-top: 8px; font-size: .72rem;
  font-style: italic; color: var(--gold); min-height: 1.1em;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   NOTES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notes-section {
  padding: 22px 32px;
  border-top: 1px solid var(--parch-dark);
}
.notes-ta {
  width: 100%; min-height: 110px; resize: vertical;
  font-family: 'Crimson Pro', serif; font-size: .9rem; line-height: 1.75;
  padding: 12px 14px;
  border: 1px solid var(--parch-dark); border-radius: 2px;
  background: #fffdf5; color: var(--ink); outline: none;
  transition: border-color .15s;
}
.notes-ta:focus { border-color: var(--gold); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ACTION BAR
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.action-bar {
  padding: 14px 32px;
  border-top: 2px solid var(--parch-dark);
  display: flex; align-items: center;
  justify-content: space-between; gap: 10px; flex-wrap: wrap;
  background: var(--parch-warm);
}
.act-group { display: flex; gap: 8px; flex-wrap: wrap; }

.act-btn {
  padding: 7px 16px;
  font-family: 'Crimson Pro', serif; font-size: .82rem;
  border: 1.5px solid var(--ink-soft); border-radius: 2px;
  background: var(--parch); color: var(--ink);
  cursor: pointer; transition: all .15s; letter-spacing: .03em;
}
.act-btn:hover { background: var(--ink); color: var(--parch-warm); border-color: var(--ink); }
.act-btn.primary { background: var(--ink); color: var(--parch-warm); border-color: var(--ink); }
.act-btn.primary:hover { background: var(--ink-mid); }
.act-btn.danger { border-color: var(--red); color: var(--red); }
.act-btn.danger:hover { background: var(--red); color: #fff; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESPONSIVE / PRINT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 600px) {
  .td-num { display: none; }
  .td-student { width: 130px; }
  .vote-grid { grid-template-columns: 1fr; }
  .action-bar { flex-direction: column; align-items: stretch; }
  .sheet-header { flex-direction: column; }
}

@media print {
  body { background: #fff; }
  .topbar, .section-nav, .action-bar, .vote-section { display: none !important; }
  .sheet { box-shadow: none; }
  .panel { max-width: 100%; padding: 0; }
  .student-inp { border: none; border-bottom: 1px solid #ccc; background: transparent; }
}
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay">
  <div class="loader-emblem">âš–</div>
  <div class="loader-text">Loading the Convention Rollâ€¦</div>
  <div class="loader-bar"><div class="loader-bar-fill"></div></div>
</div>

<!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-wrap">
    <div class="auth-masthead">
      <div class="auth-seal">âš–</div>
      <h1>Raising the Eleventh Pillar</h1>
      <p>Roll Sheet Â· Instructor Access</p>
    </div>
    <div class="auth-body">
      <div class="tab-row">
        <button class="tab-btn active" id="tabLogin" onclick="switchTab('login')">Sign In</button>
        <button class="tab-btn" id="tabSignup" onclick="switchTab('signup')">Create Account</button>
      </div>

      <div id="loginForm">
        <div class="field">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email">
        </div>
        <div class="field">
          <label>Password</label>
          <input type="password" id="loginPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>
        <button class="auth-submit" id="loginBtn" onclick="doLogin()">Sign In to the Convention</button>
      </div>

      <div id="signupForm" style="display:none">
        <div class="field">
          <label>Email</label>
          <input type="email" id="signupEmail" placeholder="your@email.com" autocomplete="email">
        </div>
        <div class="field">
          <label>Password</label>
          <input type="password" id="signupPw" placeholder="At least 6 characters" autocomplete="new-password">
        </div>
        <div class="field">
          <label>Confirm Password</label>
          <input type="password" id="signupConfirm" placeholder="Repeat password" autocomplete="new-password">
        </div>
        <button class="auth-submit" id="signupBtn" onclick="doSignup()">Create Account</button>
      </div>

      <div class="auth-alert err" id="authErr"></div>
      <div class="auth-alert ok"  id="authOk"></div>
    </div>
  </div>
</div>

<!-- APP SCREEN -->
<div id="appScreen">
  <div class="topbar">
    <div class="topbar-brand">
      <span class="seal">âš–</span>
      <h1>Raising the Eleventh Pillar <span>Â· Roll Sheet</span></h1>
    </div>
    <div class="topbar-right">
      <span class="save-pill" id="savePill">All changes saved</span>
      <span class="user-badge" id="userBadge"></span>
      <button class="sign-out-btn" onclick="doLogout()">Sign Out</button>
    </div>
  </div>

  <div class="section-nav">
    <button class="sec-tab active" data-sec="3945">HIST 101 Â· 3945</button>
    <button class="sec-tab" data-sec="3946">HIST 101 Â· 3946</button>
    <button class="sec-tab" data-sec="3944">HIST 101 Â· 3944</button>
  </div>

  <div class="panel" id="panel"></div>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SUPABASE INIT (wrapped so errors are caught)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SUPABASE_URL = 'https://bqrluqymscucvbiaaeai.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcmx1cXltc2N1Y3ZiaWFhZWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njg4MTMsImV4cCI6MjA4NDI0NDgxM30.AVOjnQe_TDoWydE2wDP1_YftU1lBkYxcPuyQeZb8Nfs';

let sb;
try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); }
catch(e) { console.error('Supabase init failed:', e); showLoader(false); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DATA CONSTANTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const DELEGATES = [
  {f:'fed',  name:'Chancellor Robert R. Livingston', county:'New York City',  role:'Party Leader',                  req:true},
  {f:'fed',  name:'Alexander Hamilton',              county:'New York City',  role:'Party Lieutenant',              req:true},
  {f:'fed',  name:'John Jay',                        county:'New York City',  role:null,                            req:false},
  {f:'fed',  name:'James Duane',                     county:'New York City',  role:null,                            req:false},
  {f:'fed',  name:'John Sloss Hobart',               county:'New York City',  role:null,                            req:false},
  {f:'fed',  name:'Isaac Roosevelt',                 county:'New York City',  role:null,                            req:false},
  {f:'fed',  name:'Richard Morris',                  county:'New York City',  role:null,                            req:false},
  {f:'fed',  name:'Lewis Morris',                    county:'Westchester',    role:null,                            req:false},
  {f:'fed',  name:'Philip Van Cortlandt',            county:'Westchester',    role:null,                            req:false},
  {f:'fed',  name:'Peter Lefferts',                  county:'Kings',          role:null,                            req:false},
  {f:'fed',  name:'Abraham Bancker',                 county:'Richmond',       role:null,                            req:false},
  {f:'anti', name:'Governor George Clinton',         county:'Ulster',         role:'Party Leader & Conv. President',req:true},
  {f:'anti', name:'Melancton Smith',                 county:'Dutchess',       role:'Party Lieutenant',              req:true},
  {f:'anti', name:'John Lansing Jr.',                county:'Albany',         role:null,                            req:false},
  {f:'anti', name:'Robert Yates',                    county:'Albany',         role:null,                            req:false},
  {f:'anti', name:'General James Clinton',           county:'Ulster',         role:null,                            req:false},
  {f:'anti', name:'Gilbert Livingston',              county:'Dutchess',       role:null,                            req:false},
  {f:'anti', name:'John Haring',                     county:'Orange',         role:null,                            req:false},
  {f:'anti', name:'Henry Wisner',                    county:'Orange',         role:null,                            req:false},
  {f:'anti', name:'Thomas Tredwell',                 county:'Suffolk',        role:null,                            req:false},
  {f:'anti', name:'Zephaniah Platt',                 county:'Dutchess',       role:null,                            req:false},
  {f:'anti', name:'John Williams',                   county:'Washington',     role:null,                            req:false},
  {f:'mod',  name:'Henry Oothoudt',                  county:'Albany',         role:'Convention Chair',              req:true},
  {f:'mod',  name:'Jonathan N. Havens',              county:'Suffolk',        role:'Federalist Liaison',            req:true},
  {f:'mod',  name:'Jacobus Swartwout',               county:'Dutchess',       role:'Antifederalist Liaison',        req:true},
  {f:'mod',  name:'David Hedges',                    county:'Suffolk',        role:null,                            req:false},
  {f:'mod',  name:'Jesse Woodhull',                  county:'Orange',         role:null,                            req:false},
  {f:'mod',  name:'John Cantine',                    county:'Ulster',         role:null,                            req:false},
  {f:'mod',  name:'Cornelius C. Schoonmaker',        county:'Ulster',         role:null,                            req:false},
  {f:'mod',  name:'Dirck Swart',                     county:'Albany',         role:null,                            req:false},
  {f:'mod',  name:'Peter Vrooman',                   county:'Albany',         role:null,                            req:false},
  {f:'mod',  name:'Nicholas Low',                    county:'New York City',  role:null,                            req:false},
  {f:'mod',  name:'Samuel Jones',                    county:'Queens',         role:null,                            req:false},
  {f:'mod',  name:'Peter Van Ness',                  county:'Columbia',       role:null,                            req:false},
  {f:'mod',  name:'Thaddeus Crane',                  county:'Westchester',    role:null,                            req:false},
];

const FACTIONS = {
  fed:  { label: 'Federalists',     count: '11 Delegates', icon: 'âš‘' },
  anti: { label: 'Antifederalists', count: '11 Delegates', icon: 'âš' },
  mod:  { label: 'Moderates',       count: '13 Delegates', icon: 'âš–' },
};

const ISSUES = [
  { id: 'districts', title: 'Issue I Â· Size of Electoral Districts' },
  { id: 'rotation',  title: 'Issue II Â· Rotation / Term Limits'     },
  { id: 'instruct',  title: 'Issue III Â· Instructed Voting'         },
];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentUser = null;
let currentSec  = '3945';
let saveTimer   = null;
const cache = {};

function blankData() {
  const s = {}, a = {};
  DELEGATES.forEach(d => { s[d.name] = ''; a[d.name] = null; });
  return { date:'', students:s, attendance:a, notes:'', votes:{districts:null,rotation:null,instruct:null} };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UI HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showLoader(visible) {
  const el = document.getElementById('loadingOverlay');
  if (!visible) {
    el.classList.add('fade-out');
    setTimeout(() => { el.style.display = 'none'; }, 420);
  } else {
    el.style.display = 'flex';
    el.classList.remove('fade-out');
  }
}

function showAuth() {
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('appScreen').style.display  = 'none';
}

function showApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('appScreen').style.display  = 'block';
}

function setAlert(type, msg) {
  ['authErr','authOk'].forEach(id => {
    const el = document.getElementById(id);
    el.style.display = 'none'; el.textContent = '';
  });
  if (!msg) return;
  const el = document.getElementById(type === 'err' ? 'authErr' : 'authOk');
  el.textContent = msg; el.style.display = 'block';
}

function esc(s) {
  return String(s||'')
    .replace(/&/g,'&amp;').replace(/"/g,'&quot;')
    .replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   AUTH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function switchTab(tab) {
  document.getElementById('loginForm').style.display  = tab === 'login'  ? '' : 'none';
  document.getElementById('signupForm').style.display = tab === 'signup' ? '' : 'none';
  document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
  document.getElementById('tabSignup').classList.toggle('active', tab === 'signup');
  setAlert(null, null);
}

async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pw    = document.getElementById('loginPw').value;
  if (!email || !pw) { setAlert('err','Please enter your email and password.'); return; }
  const btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'Signing inâ€¦';
  const { error } = await sb.auth.signInWithPassword({ email, password: pw });
  btn.disabled = false; btn.textContent = 'Sign In to the Convention';
  if (error) setAlert('err', error.message);
}

async function doSignup() {
  const email = document.getElementById('signupEmail').value.trim();
  const pw    = document.getElementById('signupPw').value;
  const pw2   = document.getElementById('signupConfirm').value;
  if (!email || !pw) { setAlert('err','Please fill in all fields.'); return; }
  if (pw !== pw2)    { setAlert('err','Passwords do not match.'); return; }
  if (pw.length < 6) { setAlert('err','Password must be at least 6 characters.'); return; }
  const btn = document.getElementById('signupBtn');
  btn.disabled = true; btn.textContent = 'Creating accountâ€¦';
  const { error } = await sb.auth.signUp({ email, password: pw });
  btn.disabled = false; btn.textContent = 'Create Account';
  if (error) { setAlert('err', error.message); return; }
  setAlert('ok', 'Account created! You are now signed in.');
}

async function doLogout() {
  await sb.auth.signOut();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ROBUST AUTH INIT  â† the key fix
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function initAuth() {
  // Fallback: if nothing resolves in 7 s, show auth
  const fallback = setTimeout(() => { showLoader(false); showAuth(); }, 7000);

  try {
    // getSession() is synchronous against the cached token â€” very fast
    const { data: { session } } = await sb.auth.getSession();
    clearTimeout(fallback);
    showLoader(false);
    if (session?.user) {
      currentUser = session.user;
      document.getElementById('userBadge').textContent = session.user.email;
      showApp();
      await renderSection(currentSec);
    } else {
      showAuth();
    }
  } catch(e) {
    clearTimeout(fallback);
    console.error('Auth init error:', e);
    showLoader(false);
    showAuth();
  }

  // Still listen for changes (sign-in / sign-out)
  sb.auth.onAuthStateChange(async (event, session) => {
    if (session?.user) {
      currentUser = session.user;
      document.getElementById('userBadge').textContent = session.user.email;
      showApp();
      if (!cache[currentSec]) await renderSection(currentSec);
    } else {
      currentUser = null;
      Object.keys(cache).forEach(k => delete cache[k]);
      showAuth();
    }
  });
}

initAuth();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SECTION TABS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.querySelectorAll('.sec-tab').forEach(btn => {
  btn.addEventListener('click', async () => {
    document.querySelectorAll('.sec-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    currentSec = btn.dataset.sec;
    await renderSection(currentSec);
  });
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DATA OPS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadSection(sec) {
  if (cache[sec]) return cache[sec];
  const { data, error } = await sb
    .from('ratification_roll').select('*')
    .eq('user_id', currentUser.id).eq('section', sec).maybeSingle();
  if (error) console.error(error);
  const d = blankData();
  if (data) {
    d.date  = data.date  || '';
    d.notes = data.notes || '';
    d.votes = Object.assign(d.votes, data.votes || {});
    Object.assign(d.students,   data.students   || {});
    Object.assign(d.attendance, data.attendance || {});
  }
  cache[sec] = d;
  return d;
}

function scheduleSave(sec) {
  clearTimeout(saveTimer);
  const pill = document.getElementById('savePill');
  if (pill) { pill.textContent = 'Savingâ€¦'; pill.classList.remove('ok'); }
  saveTimer = setTimeout(async () => {
    const d = cache[sec];
    if (!d) return;
    const { error } = await sb.from('ratification_roll').upsert({
      user_id: currentUser.id, section: sec,
      date: d.date, students: d.students, attendance: d.attendance,
      notes: d.notes, votes: d.votes,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id,section' });
    if (error) console.error(error);
    if (pill) { pill.textContent = 'Saved âœ“'; pill.classList.add('ok'); }
    setTimeout(() => {
      if (pill) { pill.textContent = 'All changes saved'; pill.classList.remove('ok'); }
    }, 2200);
  }, 900);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RENDER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderSection(sec) {
  document.getElementById('panel').innerHTML =
    `<div style="padding:44px;text-align:center;font-family:'Playfair Display',serif;
      font-style:italic;color:rgba(250,243,224,.4);font-size:1rem;">
      Loading sectionâ€¦</div>`;
  const data = await loadSection(sec);
  buildSheet(sec, data);
}

function buildSheet(sec, data) {
  const pres   = Object.values(data.attendance).filter(v => v === true).length;
  const abs    = Object.values(data.attendance).filter(v => v === false).length;
  const assign = Object.values(data.students).filter(v => v && v.trim()).length;

  document.getElementById('panel').innerHTML = `
  <div class="sheet">
    <div class="sheet-header">
      <div>
        <h2>HIST 101 Â· Section ${esc(sec)}</h2>
        <p>New York State Ratifying Convention, 1788 Â· 35 Delegates</p>
      </div>
      <div class="date-field">
        <label>Date</label>
        <input class="date-input" type="date" id="dateIn" value="${esc(data.date)}">
      </div>
    </div>

    <div class="stats-bar" id="statsBar">
      ${statsHTML(assign, pres, abs)}
    </div>

    ${factionBlock('fed',  DELEGATES.filter(d => d.f==='fed'),  data)}
    ${factionBlock('anti', DELEGATES.filter(d => d.f==='anti'), data)}
    ${factionBlock('mod',  DELEGATES.filter(d => d.f==='mod'),  data)}

    <div class="vote-section">
      <div class="section-title">âš– Issue Vote Tracker</div>
      <div class="vote-grid">
        ${ISSUES.map(i => voteCard(i, data.votes[i.id])).join('')}
      </div>
    </div>

    <div class="notes-section">
      <div class="section-title">ğŸ“ Game Notes</div>
      <textarea class="notes-ta" id="notesTA"
        placeholder="Record key arguments, turning points, notable moments, final vote outcomeâ€¦">${esc(data.notes)}</textarea>
    </div>

    <div class="action-bar">
      <div class="act-group">
        <button class="act-btn" onclick="markAll(true)">âœ“ All Present</button>
        <button class="act-btn" onclick="markAll(false)">âœ— All Absent</button>
        <button class="act-btn" onclick="clearAtt()">Clear Attendance</button>
      </div>
      <div class="act-group">
        <button class="act-btn danger" onclick="confirmClear()">Clear Section Data</button>
        <button class="act-btn primary" onclick="window.print()">ğŸ–¨ Print</button>
      </div>
    </div>
  </div>`;

  // Wire events
  document.getElementById('dateIn').addEventListener('change', e => {
    cache[sec].date = e.target.value; scheduleSave(sec);
  });
  document.getElementById('notesTA').addEventListener('input', e => {
    cache[sec].notes = e.target.value; scheduleSave(sec);
  });
  document.querySelectorAll('.student-inp').forEach(inp => {
    inp.addEventListener('input', e => {
      cache[sec].students[e.target.dataset.d] = e.target.value;
      e.target.classList.toggle('has-val', !!e.target.value.trim());
      scheduleSave(sec); updateStats(sec);
    });
  });
  document.querySelectorAll('.att-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const nm = btn.dataset.d;
      const cur = cache[sec].attendance[nm];
      cache[sec].attendance[nm] = cur === null ? true : cur === true ? false : null;
      renderAttBtn(btn, cache[sec].attendance[nm]);
      scheduleSave(sec); updateStats(sec);
    });
  });
  document.querySelectorAll('.faction-head').forEach(h => {
    h.addEventListener('click', () => h.closest('.faction-block').classList.toggle('closed'));
  });
  document.querySelectorAll('.vbtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const { issue, side } = btn.dataset;
      cache[sec].votes[issue] = cache[sec].votes[issue] === side ? null : side;
      scheduleSave(sec); refreshVoteCard(issue, cache[sec].votes[issue]);
    });
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function statsHTML(assign, pres, abs) {
  return `
    <div class="stat-chip"><span class="val val-assign">${assign}</span><span class="lbl">of 35 assigned</span></div>
    <div class="stat-chip"><span class="val val-present">${pres}</span><span class="lbl">present</span></div>
    <div class="stat-chip"><span class="val val-absent">${abs}</span><span class="lbl">absent</span></div>
    <div class="stat-chip"><span class="val">${35 - pres - abs}</span><span class="lbl">unmarked</span></div>`;
}

function updateStats(sec) {
  const d = cache[sec];
  const pres   = Object.values(d.attendance).filter(v => v === true).length;
  const abs    = Object.values(d.attendance).filter(v => v === false).length;
  const assign = Object.values(d.students).filter(v => v && v.trim()).length;
  const bar = document.getElementById('statsBar');
  if (bar) bar.innerHTML = statsHTML(assign, pres, abs);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   FACTION HTML
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function factionBlock(faction, delegates, data) {
  const info = FACTIONS[faction];
  const rows = delegates.map((d, i) => {
    const sv  = data.students[d.name] || '';
    const att = data.attendance[d.name];
    const ac  = att === true ? 'present' : att === false ? 'absent' : '';
    const ai  = att === true ? 'âœ“' : att === false ? 'âœ—' : '';
    return `<tr class="d-row">
      <td class="td-num">${i+1}</td>
      <td class="td-info">
        <span class="d-name">${esc(d.name)}</span>
        ${d.req  ? '<span class="d-star">â˜… required</span>' : ''}
        ${d.role ? `<span class="d-role">Â· ${esc(d.role)}</span>` : ''}
        <div class="d-county">${esc(d.county)}</div>
      </td>
      <td class="td-student">
        <input class="student-inp ${sv ? 'has-val' : ''}" type="text"
          placeholder="Student nameâ€¦" value="${esc(sv)}" data-d="${esc(d.name)}">
      </td>
      <td class="td-att">
        <button class="att-btn ${ac}" data-d="${esc(d.name)}" title="Toggle attendance">${ai}</button>
      </td>
    </tr>`;
  }).join('');

  return `<div class="faction-block">
    <div class="faction-head ${faction}">
      <span class="f-tag">${info.icon} ${info.label}</span>
      <h3>${info.label}</h3>
      <span class="f-count">${info.count}</span>
      <span class="f-chev">â–¼</span>
    </div>
    <table class="delegate-table"><tbody>${rows}</tbody></table>
  </div>`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   VOTES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function voteCard(issue, v) {
  return `<div class="vote-card" id="vc-${issue.id}">
    <div class="vc-title">${esc(issue.title)}</div>
    <div class="vc-btns">
      <span class="vc-lbl">Outcome:</span>
      <button class="vbtn ${v==='fed' ?'sel-fed' :''}" data-issue="${issue.id}" data-side="fed">Federalist</button>
      <button class="vbtn ${v==='anti'?'sel-anti':''}" data-issue="${issue.id}" data-side="anti">Antifederalist</button>
    </div>
    <div class="vc-result">${voteText(v)}</div>
  </div>`;
}

function voteText(v) {
  return v === 'fed'  ? 'âš‘ Federalist position prevails'
       : v === 'anti' ? 'âš Antifederalist position prevails'
       : '';
}

function refreshVoteCard(issueId, vote) {
  const card = document.getElementById(`vc-${issueId}`);
  if (!card) return;
  card.querySelectorAll('.vbtn').forEach(b => {
    b.className = 'vbtn' + (vote === b.dataset.side ? ` sel-${b.dataset.side}` : '');
  });
  card.querySelector('.vc-result').textContent = voteText(vote);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ATTENDANCE BUTTONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderAttBtn(btn, state) {
  btn.className = 'att-btn' + (state === true ? ' present' : state === false ? ' absent' : '');
  btn.textContent = state === true ? 'âœ“' : state === false ? 'âœ—' : '';
}

function markAll(present) {
  DELEGATES.forEach(d => { cache[currentSec].attendance[d.name] = present; });
  document.querySelectorAll('.att-btn').forEach(b => renderAttBtn(b, present));
  scheduleSave(currentSec); updateStats(currentSec);
}

function clearAtt() {
  DELEGATES.forEach(d => { cache[currentSec].attendance[d.name] = null; });
  document.querySelectorAll('.att-btn').forEach(b => renderAttBtn(b, null));
  scheduleSave(currentSec); updateStats(currentSec);
}

async function confirmClear() {
  if (!confirm(`Clear ALL data for Section ${currentSec}? This cannot be undone.`)) return;
  cache[currentSec] = blankData();
  await sb.from('ratification_roll').delete()
    .eq('user_id', currentUser.id).eq('section', currentSec);
  buildSheet(currentSec, cache[currentSec]);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   KEYBOARD SHORTCUTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
['loginEmail','loginPw'].forEach(id => {
  document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
});
['signupEmail','signupPw','signupConfirm'].forEach(id => {
  document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doSignup(); });
});
</script>
</body>
</html>
