<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lexington Case ‚Äî HIST 101</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #1a1208;
            --parchment: #f5edda;
            --aged: #e8d9b8;
            --worn: #d4c49a;
            --red: #8b1a1a;
            --dark-red: #5c1010;
            --blue: #1a2c4a;
            --gold: #c8a84b;
            --stamp-green: #2a4a2a;
            --faded: #7a6a52;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Libre Baskerville', Georgia, serif;
            background-color: #2a1f0e;
            background-image: 
                radial-gradient(ellipse at 20% 50%, rgba(139,26,26,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 20%, rgba(26,44,74,0.08) 0%, transparent 60%),
                repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(0,0,0,0.03) 50px, rgba(0,0,0,0.03) 51px);
            color: var(--ink);
            min-height: 100vh;
            padding: 20px;
        }

        .page-wrap {
            max-width: 900px;
            margin: 0 auto;
        }

        /* === CASE FILE HEADER === */
        .case-header {
            background: var(--parchment);
            border: 3px solid var(--ink);
            border-top: 8px solid var(--red);
            padding: 0;
            margin-bottom: 30px;
            position: relative;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.4), inset 0 0 60px rgba(200,168,75,0.15);
        }

        .case-stamp {
            position: absolute;
            top: 12px;
            right: 20px;
            border: 3px solid var(--red);
            color: var(--red);
            font-family: 'Special Elite', monospace;
            font-size: 0.7em;
            padding: 6px 10px;
            text-align: center;
            transform: rotate(3deg);
            letter-spacing: 2px;
            opacity: 0.85;
            line-height: 1.3;
        }

        .case-meta {
            background: var(--blue);
            color: #a8bdd0;
            font-family: 'Special Elite', monospace;
            font-size: 0.75em;
            padding: 8px 20px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .case-title-area {
            padding: 30px 30px 25px;
            border-bottom: 2px solid var(--worn);
        }

        .case-number {
            font-family: 'Special Elite', monospace;
            font-size: 0.85em;
            color: var(--faded);
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        h1 {
            font-family: 'Special Elite', monospace;
            font-size: 2.8em;
            color: var(--ink);
            line-height: 1.1;
            margin-bottom: 6px;
        }

        h1 span {
            color: var(--red);
        }

        .case-subtitle {
            font-size: 1.05em;
            color: var(--faded);
            font-style: italic;
        }

        .central-question {
            background: var(--blue);
            color: #f0e8d4;
            padding: 18px 30px;
            font-size: 1.1em;
            font-family: 'Special Elite', monospace;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .central-question::before {
            content: "‚ùì";
            font-size: 1.3em;
            flex-shrink: 0;
        }

        /* === PROGRESS BAR === */
        .progress-bar {
            display: flex;
            background: var(--aged);
            border: 2px solid var(--ink);
            border-top: none;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .prog-step {
            flex: 1;
            text-align: center;
            padding: 10px 4px;
            font-family: 'Special Elite', monospace;
            font-size: 0.72em;
            letter-spacing: 1px;
            color: var(--faded);
            border-right: 1px solid var(--worn);
            cursor: default;
            transition: all 0.3s;
            line-height: 1.4;
        }

        .prog-step:last-child { border-right: none; }

        .prog-step.active {
            background: var(--red);
            color: #f5edda;
        }

        .prog-step.done {
            background: var(--stamp-green);
            color: #c8e4c8;
        }

        .prog-step .step-icon { display: block; font-size: 1.2em; margin-bottom: 3px; }

        /* === PANELS === */
        .panel {
            display: none;
            animation: slideIn 0.4s ease;
        }

        .panel.active { display: block; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === CARDS === */
        .card {
            background: var(--parchment);
            border: 2px solid var(--ink);
            padding: 28px 30px;
            margin-bottom: 24px;
            position: relative;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            background-image: linear-gradient(to bottom right, var(--parchment), var(--aged));
        }

        .card-label {
            font-family: 'Special Elite', monospace;
            font-size: 0.72em;
            letter-spacing: 3px;
            color: var(--red);
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--worn);
        }

        h2 {
            font-family: 'Special Elite', monospace;
            font-size: 1.6em;
            color: var(--blue);
            margin-bottom: 16px;
            border-bottom: 2px solid var(--worn);
            padding-bottom: 10px;
        }

        h3 {
            font-family: 'Special Elite', monospace;
            font-size: 1.2em;
            color: var(--ink);
            margin-bottom: 12px;
            margin-top: 20px;
        }

        p { line-height: 1.75; margin-bottom: 14px; color: var(--ink); }

        /* === STUDENT INFO === */
        .student-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 4px;
        }

        .field-group { display: flex; flex-direction: column; gap: 6px; }
        .field-group label {
            font-family: 'Special Elite', monospace;
            font-size: 0.8em;
            letter-spacing: 2px;
            color: var(--faded);
            text-transform: uppercase;
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px 14px;
            background: #fffdf6;
            border: 2px solid var(--worn);
            border-radius: 0;
            color: var(--ink);
            font-family: 'Libre Baskerville', serif;
            font-size: 0.95em;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--blue);
            background: #fff;
        }

        textarea { min-height: 90px; resize: vertical; line-height: 1.6; }

        /* === EVIDENCE IMAGES === */
        .evidence-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .evidence-item {
            border: 3px solid var(--ink);
            overflow: hidden;
            position: relative;
            background: var(--aged);
        }

        .evidence-tag {
            background: var(--ink);
            color: var(--parchment);
            font-family: 'Special Elite', monospace;
            font-size: 0.75em;
            padding: 6px 12px;
            letter-spacing: 2px;
        }

        .evidence-image-placeholder {
            width: 100%;
            height: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #d8cba8;
            border-top: 1px solid var(--worn);
            gap: 8px;
            color: var(--faded);
        }

        .evidence-image-placeholder .ph-icon {
            font-size: 2.5em;
            opacity: 0.5;
        }

        .evidence-image-placeholder .ph-text {
            font-family: 'Special Elite', monospace;
            font-size: 0.75em;
            letter-spacing: 2px;
            text-align: center;
            padding: 0 10px;
            opacity: 0.6;
        }

        /* === DOCUMENT BLOCK === */
        .document-block {
            background: #fffdf5;
            border: 2px solid var(--worn);
            border-left: 6px solid var(--blue);
            padding: 24px 26px;
            margin: 20px 0;
            font-size: 1em;
            line-height: 1.85;
            position: relative;
        }

        .document-block::before {
            content: '"';
            position: absolute;
            top: -10px;
            left: 16px;
            font-size: 3em;
            color: var(--blue);
            opacity: 0.2;
            font-family: Georgia;
            line-height: 1;
        }

        .doc-source {
            margin-top: 18px;
            padding-top: 12px;
            border-top: 1px solid var(--worn);
            font-size: 0.82em;
            color: var(--faded);
            font-style: italic;
        }

        /* === QUESTION SECTIONS === */
        .question-group {
            background: #f0e8d4;
            border: 1px solid var(--worn);
            border-left: 4px solid var(--gold);
            padding: 22px 24px;
            margin: 20px 0;
        }

        .question-group h4 {
            font-family: 'Special Elite', monospace;
            font-size: 0.9em;
            letter-spacing: 2px;
            color: var(--faded);
            text-transform: uppercase;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .q-item { margin-bottom: 20px; }
        .q-item:last-child { margin-bottom: 0; }

        .q-item label {
            display: block;
            font-weight: 700;
            color: var(--ink);
            margin-bottom: 8px;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .q-item label .q-num {
            display: inline-block;
            background: var(--red);
            color: #fff;
            font-family: 'Special Elite', monospace;
            font-size: 0.8em;
            padding: 1px 7px;
            margin-right: 6px;
        }

        /* === VERDICT SECTION === */
        .verdict-box {
            background: var(--aged);
            border: 3px solid var(--red);
            padding: 24px;
            margin: 20px 0;
            text-align: center;
        }

        .verdict-box h3 {
            font-family: 'Special Elite', monospace;
            font-size: 1.4em;
            color: var(--red);
            margin-bottom: 8px;
            text-align: center;
        }

        /* === BUTTONS === */
        .btn-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 28px;
        }

        .btn {
            font-family: 'Special Elite', monospace;
            font-size: 0.95em;
            letter-spacing: 2px;
            padding: 13px 28px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: var(--red);
            color: var(--parchment);
            border-color: var(--dark-red);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--dark-red);
            transform: translateY(-2px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--ink);
            border-color: var(--worn);
        }

        .btn-secondary:hover {
            border-color: var(--ink);
            background: rgba(0,0,0,0.05);
        }

        .btn-success {
            background: var(--stamp-green);
            color: #d4ecd4;
            border-color: #1a3a1a;
        }

        .btn-success:hover:not(:disabled) {
            background: #1a3a1a;
            transform: translateY(-2px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* === TIMELINE === */
        .timeline { margin: 20px 0; }

        .tl-item {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            padding: 14px 16px;
            background: #fffdf5;
            border: 1px solid var(--worn);
            border-left: 4px solid var(--worn);
        }

        .tl-item.highlight { border-left-color: var(--red); background: rgba(139,26,26,0.05); }

        .tl-date {
            font-family: 'Special Elite', monospace;
            color: var(--red);
            font-size: 0.85em;
            min-width: 90px;
            padding-top: 2px;
        }

        /* === NOTICE BOXES === */
        .notice {
            padding: 14px 18px;
            border-left: 4px solid var(--blue);
            background: rgba(26,44,74,0.07);
            margin: 16px 0;
            font-size: 0.9em;
            font-style: italic;
            color: var(--faded);
        }

        .notice.warning {
            border-left-color: var(--red);
            background: rgba(139,26,26,0.06);
        }

        /* === REVEAL SECTION === */
        .reveal-card {
            background: var(--blue);
            color: #d4e4f4;
            padding: 28px 30px;
            margin: 20px 0;
            border: 2px solid #0a1a2e;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .reveal-card h3 {
            color: var(--gold);
            font-family: 'Special Elite', monospace;
            font-size: 1.3em;
            margin-bottom: 14px;
        }

        .reveal-card p, .reveal-card li { color: #c8dce8; line-height: 1.75; }

        .verdict-stamp {
            font-family: 'Special Elite', monospace;
            font-size: 1.8em;
            color: var(--red);
            border: 4px solid var(--red);
            display: inline-block;
            padding: 8px 20px;
            transform: rotate(-4deg);
            letter-spacing: 4px;
            opacity: 0.9;
            margin: 20px auto;
        }

        #submitMessage {
            margin-top: 16px;
            font-size: 0.95em;
        }

        .success-msg {
            background: var(--stamp-green);
            color: #d4ecd4;
            padding: 16px 20px;
            border-left: 4px solid var(--gold);
            font-family: 'Special Elite', monospace;
            letter-spacing: 1px;
        }

        .error-msg {
            background: rgba(139,26,26,0.15);
            color: var(--red);
            padding: 16px 20px;
            border-left: 4px solid var(--red);
        }

        /* Breadcrumb */
        .breadcrumb {
            font-family: 'Special Elite', monospace;
            font-size: 0.8em;
            letter-spacing: 2px;
            color: #8a7a60;
            margin-bottom: 16px;
        }

        .breadcrumb a { color: var(--gold); text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep { margin: 0 8px; opacity: 0.4; }

        @media (max-width: 650px) {
            h1 { font-size: 1.9em; }
            .student-info-grid { grid-template-columns: 1fr; }
            .evidence-board { grid-template-columns: 1fr; }
            .prog-step .step-icon { font-size: 1em; }
        }
    </style>
</head>
<body>
<div class="page-wrap">

    <nav class="breadcrumb">
        <a href="index.html">Home</a><span class="sep">‚Ä∫</span>
        <a href="activities.html">Interactive Activities</a><span class="sep">‚Ä∫</span>
        <span>The Lexington Case</span>
    </nav>

    <!-- HEADER -->
    <div class="case-header">
        <div class="case-stamp">OPEN<br>CASE<br>FILE</div>
        <div class="case-meta">HIST 101 ¬∑ American History ¬∑ Prof. Hauselmann</div>
        <div class="case-title-area">
            <div class="case-number">Case No. HIST-101 ¬∑ April 19, 1775</div>
            <h1>The <span>Lexington</span> Case</h1>
            <p class="case-subtitle">A Historical Detective Investigation ¬∑ Lexington, Massachusetts</p>
        </div>
        <div class="central-question">
            Central Question: Who fired the first shot at the Battle of Lexington?
        </div>
    </div>

    <!-- PROGRESS -->
    <div class="progress-bar" id="progressBar">
        <div class="prog-step active" data-phase="0">
            <span class="step-icon">üìã</span>Briefing
        </div>
        <div class="prog-step" data-phase="1">
            <span class="step-icon">üñºÔ∏è</span>Evidence
        </div>
        <div class="prog-step" data-phase="2">
            <span class="step-icon">üìú</span>Doc A
        </div>
        <div class="prog-step" data-phase="3">
            <span class="step-icon">üìú</span>Doc B
        </div>
        <div class="prog-step" data-phase="4">
            <span class="step-icon">üîç</span>Verdict
        </div>
        <div class="prog-step" data-phase="5">
            <span class="step-icon">‚öñÔ∏è</span>Reveal
        </div>
    </div>

    <!-- ======= PHASE 0: BRIEFING ======= -->
    <div class="panel active" id="phase0">

        <div class="card">
            <div class="card-label">Detective Briefing</div>
            <h2>Your Mission</h2>
            <p>You are a historical detective. It is your job to examine the evidence and determine: <strong>Who fired the first shot at the Battle of Lexington on April 19, 1775?</strong></p>
            <p>The battle is considered the first engagement of the American Revolution ‚Äî but the key question about what <em>actually happened</em> that morning remains disputed. You will examine visual evidence and two written accounts from people who were there, then render your verdict.</p>

            <div class="student-info-grid" style="margin-top: 24px;">
                <div class="field-group">
                    <label>Your Full Name</label>
                    <input type="text" id="student-name" placeholder="Enter your full name">
                </div>
                <div class="field-group">
                    <label>Section Number</label>
                    <input type="text" id="section-number" placeholder="e.g., 101, 102">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-label">Case Background</div>
            <h2>What You Need to Know</h2>

            <p>Before examining the evidence, review these key facts:</p>

            <div class="timeline">
                <div class="tl-item">
                    <div class="tl-date">1765‚Äì1775</div>
                    <div>Rising conflict between American colonists and British authorities over taxation, representation, and governance of the colonies.</div>
                </div>
                <div class="tl-item">
                    <div class="tl-date">April 18, 1775</div>
                    <div>British troops march out of Boston, reportedly to seize colonial military supplies stored in Concord. Colonial riders alert the countryside.</div>
                </div>
                <div class="tl-item highlight">
                    <div class="tl-date">April 19, 1775<br>~5:00 AM</div>
                    <div><strong>British troops arrive at Lexington Green, where a group of colonial militiamen are assembled. A shot is fired ‚Äî but by whom?</strong></div>
                </div>
                <div class="tl-item">
                    <div class="tl-date">After Lexington</div>
                    <div>British troops continue to Concord, where further fighting occurs. The events of April 19, 1775 mark the opening of the American Revolutionary War.</div>
                </div>
            </div>

            <div class="question-group">
                <h4>üîé Warm-Up: Before You Begin</h4>
                <div class="q-item">
                    <label><span class="q-num">1</span> What do you already know about the Battle of Lexington? What have you heard or read?</label>
                    <textarea id="warmup-q1" placeholder="Write what you know..."></textarea>
                </div>
                <div class="q-item">
                    <label><span class="q-num">2</span> Before looking at any evidence, who do you think fired first ‚Äî the British or the colonists? Why?</label>
                    <textarea id="warmup-q2" placeholder="Make a prediction and explain your reasoning..."></textarea>
                </div>
            </div>

            <div class="notice">
                <strong>Detective's Rule:</strong> A good detective never accepts the first version of events. You must examine multiple sources, consider who made them and why, and weigh conflicting accounts before reaching a verdict.
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-primary" onclick="startCase()">Open the Case File ‚Üí</button>
        </div>
    </div>

    <!-- ======= PHASE 1: IMAGE EVIDENCE ======= -->
    <div class="panel" id="phase1">

        <!-- STEP 1: IMAGE 1 ONLY -->
        <div id="img-step-1">
            <div class="card">
                <div class="card-label">Visual Evidence ‚Äî Exhibit A</div>
                <h2>Examining the Scene: Image 1</h2>
                <p>Study this image carefully before answering the questions below. Do not look up anything about it yet ‚Äî examine it as a detective would.</p>
                <div class="notice">
                    <strong>Detective's Rule:</strong> Observe first. Describe only what you actually see ‚Äî not what you expect or already believe happened.
                </div>
                <div class="evidence-item" style="margin: 20px 0; border: 3px solid var(--ink);">
                    <div class="evidence-tag">EXHIBIT A ‚Äî IMAGE 1</div>
                    <img src="images/sandham-lexington-1886.jpg" alt="Battle of Lexington, Image 1" style="width:100%; display:block;">
                </div>
                <div class="question-group">
                    <h4>üñºÔ∏è Image 1 Analysis</h4>
                    <div class="q-item">
                        <label><span class="q-num">1</span> What do you see in Image 1? Describe the participants, the location, and the actions taking place.</label>
                        <textarea id="img1-q1" placeholder="Who is in the image? What are they doing? What is the setting?"></textarea>
                    </div>
                    <div class="q-item">
                        <label><span class="q-num">2</span> What evidence does Image 1 provide about what happened at Lexington? Can you tell who fired first?</label>
                        <textarea id="img1-q2" placeholder="What clues does this image offer? What can you not tell from it?"></textarea>
                    </div>
                </div>
            </div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="goToPhase(0)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="revealImage2()">Continue to Image 2 ‚Üí</button>
            </div>
        </div>

        <!-- STEP 2: IMAGE 2 ONLY -->
        <div id="img-step-2" style="display:none;">
            <div class="card">
                <div class="card-label">Visual Evidence ‚Äî Exhibit B</div>
                <h2>Examining the Scene: Image 2</h2>
                <p>Now study this second image. It also depicts the Battle of Lexington ‚Äî but look closely for differences from Image 1.</p>
                <div class="evidence-item" style="margin: 20px 0; border: 3px solid var(--ink);">
                    <div class="evidence-tag">EXHIBIT B ‚Äî IMAGE 2</div>
                    <img src="images/amos-doolittle-battle-lexington-1775.jpg" alt="Battle of Lexington, Image 2" style="width:100%; display:block;">
                </div>
                <div class="question-group">
                    <h4>üñºÔ∏è Image 2 Analysis</h4>
                    <div class="q-item">
                        <label><span class="q-num">3</span> What do you see in Image 2? Describe the participants, the location, and the actions taking place.</label>
                        <textarea id="img2-q1" placeholder="Who is in the image? What are they doing? What is the setting?"></textarea>
                    </div>
                    <div class="q-item">
                        <label><span class="q-num">4</span> What evidence does Image 2 provide about what happened at Lexington?</label>
                        <textarea id="img2-q2" placeholder="What clues does this image offer?"></textarea>
                    </div>
                </div>
            </div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="backToImage1()">‚Üê Back to Image 1</button>
                <button class="btn btn-primary" onclick="revealComparison()">Compare the Images ‚Üí</button>
            </div>
        </div>

        <!-- STEP 3: SIDE-BY-SIDE -->
        <div id="img-step-3" style="display:none;">
            <div class="card">
                <div class="card-label">Visual Evidence ‚Äî Side by Side</div>
                <h2>Comparing the Two Images</h2>
                <p>Now that you've studied each image on its own, examine them together.</p>

                <div class="evidence-board">
                    <div class="evidence-item">
                        <div class="evidence-tag">EXHIBIT A ‚Äî IMAGE 1</div>
                        <img src="images/sandham-lexington-1886.jpg" alt="Battle of Lexington, Image 1" style="width:100%; display:block;">
                    </div>
                    <div class="evidence-item">
                        <div class="evidence-tag">EXHIBIT B ‚Äî IMAGE 2</div>
                        <img src="images/amos-doolittle-battle-lexington-1775.jpg" alt="Battle of Lexington, Image 2" style="width:100%; display:block;">
                    </div>
                </div>

                <div class="question-group">
                    <h4>üîç Comparison</h4>
                    <div class="q-item">
                        <label><span class="q-num">5</span> How are the two images similar to each other?</label>
                        <textarea id="img2-q3" placeholder="What do both images agree on?"></textarea>
                    </div>
                    <div class="q-item">
                        <label><span class="q-num">6</span> How are the two images different from each other? What might explain these differences?</label>
                        <textarea id="img2-q4" placeholder="What is different? Why might two images of the same event look different?"></textarea>
                    </div>
                </div>

                <div class="question-group" style="border-left-color: var(--red); background: rgba(139,26,26,0.04);">
                    <h4>üïµÔ∏è Detective's Instinct</h4>
                    <div class="q-item">
                        <label><span class="q-num">7</span> Which image do you find more trustworthy? What other information would you want to know about these images before deciding?</label>
                        <textarea id="img-eval" placeholder="Think about what you would need to know about WHO made these images and WHEN..."></textarea>
                    </div>
                </div>

                <div class="notice">
                    <strong>Artist Reveal:</strong> Image 1 was painted by Canadian artist <strong>Henry Sandham in 1886</strong> ‚Äî commissioned by the Lexington Historical Society to commemorate their forefathers. Image 2 is an engraving made by <strong>Amos Doolittle in the fall of 1775</strong>, just months after the battle. Doolittle was a Connecticut militiaman who visited Lexington and spoke with people who were there.<br><br>
                    Does this change how you evaluate the images?
                </div>

                <div class="question-group">
                    <h4>üñºÔ∏è After the Reveal</h4>
                    <div class="q-item">
                        <label><span class="q-num">8</span> Now that you know who made the images and when, does this change your evaluation? Which is more trustworthy, and why?</label>
                        <textarea id="img-artist-eval" placeholder="Think about: time gap, purpose, access to witnesses, potential bias..."></textarea>
                    </div>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-secondary" onclick="backToImage2()">‚Üê Back to Image 2</button>
                <button class="btn btn-primary" onclick="goToPhaseValidated(1, 2)">Continue to Document A ‚Üí</button>
            </div>
        </div>

    </div>

    <!-- ======= PHASE 2: DOCUMENT A ======= -->
    <div class="panel" id="phase2">
        <div class="card">
            <div class="card-label">Written Evidence ‚Äî Document A</div>
            <h2>The British Officer's Account</h2>

            <div class="question-group" style="margin-bottom: 0; border-left-color: var(--blue); background: rgba(26,44,74,0.06);">
                <h4>üîé Sourcing ‚Äî Answer these questions BEFORE reading</h4>
                <div class="q-item">
                    <label><span class="q-num">1</span> Who was John Barker?</label>
                    <input type="text" id="docA-q1" placeholder="What do you know about him?">
                </div>
                <div class="q-item">
                    <label><span class="q-num">2</span> What kind of document is this?</label>
                    <input type="text" id="docA-q2" placeholder="Diary entry, letter, court testimony, newspaper...?">
                </div>
                <div class="q-item">
                    <label><span class="q-num">3</span> When was this written? What was happening at that time?</label>
                    <input type="text" id="docA-q3" placeholder="When was it written, and what does that context mean?">
                </div>
                <div class="q-item">
                    <label><span class="q-num">4</span> Given what you know about the author and the document type, what do you predict this document will say about who fired first?</label>
                    <textarea id="docA-q4" placeholder="Make a prediction before reading..." style="min-height: 70px;"></textarea>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-label">Document A ‚Äî Now Read</div>
            <div class="document-block">
                <p>At 2 o'clock we began our march by wading through a very long stream up to our middles. About 5 miles away from a town called Lexington, we heard there were some hundreds of people collected together intending to oppose us.</p>
                <p>At 5 o'clock we arrived there and saw a number of people, I believe between 200 and 300, formed in a common in the middle of the town. We still continued advancing, keeping prepared against an attack though <em>without intending to attack them</em>. As we came near them, <strong>they fired one or two shots</strong>, upon which our men without any orders, fired and put them to flight.</p>
                <p>We then formed on the Common, but with some difficulty, the men were so wild they could hear no orders; we waited a considerable time there, and at length proceeded on our way to Concord.</p>
                <div class="doc-source">Source: Entry for April 19, 1775, from the diary of Lieutenant John Barker, an officer in the British army. Published in <em>Atlantic Monthly</em>, 1877.</div>
            </div>

            <div class="question-group">
                <h4>üìñ Close Reading</h4>
                <div class="q-item">
                    <label><span class="q-num">5</span> According to this document, what happened at the Battle of Lexington? Describe the sequence of events.</label>
                    <textarea id="docA-q5" placeholder="What happened, step by step, according to Barker?"></textarea>
                </div>
                <div class="q-item">
                    <label><span class="q-num">6</span> According to this document, who fired the first shot at the Battle of Lexington?</label>
                    <input type="text" id="docA-q6" placeholder="Who does Barker say fired first?">
                </div>
            </div>

            <div class="question-group" style="border-left-color: var(--red); background: rgba(139,26,26,0.04);">
                <h4>‚öñÔ∏è Reliability Assessment</h4>
                <div class="q-item">
                    <label><span class="q-num">7</span> Do you think this document provides a trustworthy account of what happened? Why or why not? Consider: Was Barker present? What might motivate him to tell this version of events?</label>
                    <textarea id="docA-q7" placeholder="Think about his role, his purpose, and what he might gain or lose from this account..."></textarea>
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-secondary" onclick="goToPhase(1)">‚Üê Back</button>
            <button class="btn btn-primary" onclick="goToPhaseValidated(2, 3)">Continue to Document B ‚Üí</button>
        </div>
    </div>

    <!-- ======= PHASE 3: DOCUMENT B ======= -->
    <div class="panel" id="phase3">
        <div class="card">
            <div class="card-label">Written Evidence ‚Äî Document B</div>
            <h2>The Colonists' Testimony</h2>

            <div class="question-group" style="margin-bottom: 0; border-left-color: var(--blue); background: rgba(26,44,74,0.06);">
                <h4>üîé Sourcing ‚Äî Answer these questions BEFORE reading</h4>
                <div class="q-item">
                    <label><span class="q-num">1</span> Who were the authors of this document?</label>
                    <input type="text" id="docB-q1" placeholder="Who are Nathaniel Mulliken, Philip Russell, and the others?">
                </div>
                <div class="q-item">
                    <label><span class="q-num">2</span> What kind of document is this?</label>
                    <input type="text" id="docB-q2" placeholder="What is sworn testimony? Who would they give it to?">
                </div>
                <div class="q-item">
                    <label><span class="q-num">3</span> When was this written? How much time had passed since the battle?</label>
                    <input type="text" id="docB-q3" placeholder="The battle was April 19. This was sworn April 25. What might have happened in those six days?">
                </div>
                <div class="q-item">
                    <label><span class="q-num">4</span> Given 34 colonists swore to the same account, what do you predict this document will say?</label>
                    <textarea id="docB-q4" placeholder="Predict the content before reading..." style="min-height: 70px;"></textarea>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-label">Document B ‚Äî Now Read</div>
            <div class="document-block">
                <p><em>We</em> Nathaniel Mulliken, Philip Russell, [followed by the names of 32 other men present on Lexington Green on April 19, 1775] . . . all of lawful age, and inhabitants of Lexington . . . do testify and declare, that on the nineteenth of April, about five o'clock in the morning, we proceeded towards the Green, and saw a large body of troops marching towards us.</p>
                <p>Some of our men were coming to the Green, and others had reached it, at which time, they began to disperse. While our backs were turned on the British troops, <strong>they fired on us</strong>, and a number of our men were instantly killed and wounded, <em>not a gun was fired by any person in our company on the British soldiers to our knowledge before they fired on us</em>, and continued firing until we had all made our escape.</p>
                <div class="doc-source">Source: Sworn by 34 minutemen on April 25, 1775, before three justices of the peace. Lexington, Massachusetts.</div>
            </div>

            <div class="question-group">
                <h4>üìñ Close Reading &amp; Corroboration</h4>
                <div class="q-item">
                    <label><span class="q-num">5</span> What details about the Battle of Lexington do Documents A and B have in common?</label>
                    <textarea id="docB-q5" placeholder="Where do Barker and the colonists agree?"></textarea>
                </div>
                <div class="q-item">
                    <label><span class="q-num">6</span> What details about the battle are different between the two documents?</label>
                    <textarea id="docB-q6" placeholder="Where do they disagree? What does each side claim?"></textarea>
                </div>
            </div>

            <div class="question-group" style="border-left-color: var(--red); background: rgba(139,26,26,0.04);">
                <h4>‚öñÔ∏è Reliability Assessment</h4>
                <div class="q-item">
                    <label><span class="q-num">7</span> Do you think this document provides a trustworthy account of what happened? Why or why not? Consider: Were the authors present? Why might 34 men swear to the same story?</label>
                    <textarea id="docB-q7" placeholder="Think about the six-day gap, the coordinated testimony, their identities as colonists, and what they stood to gain..."></textarea>
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-secondary" onclick="goToPhase(2)">‚Üê Back</button>
            <button class="btn btn-primary" onclick="goToPhaseValidated(3, 4)">Continue to Verdict ‚Üí</button>
        </div>
    </div>

    <!-- ======= PHASE 4: VERDICT ======= -->
    <div class="panel" id="phase4">
        <div class="card">
            <div class="card-label">Detective's Final Analysis</div>
            <h2>Render Your Verdict</h2>
            <p>You have examined two images and two written accounts. It is time to weigh the evidence and reach your conclusion as a historical detective.</p>

            <div class="verdict-box">
                <h3>‚öñÔ∏è THE CENTRAL QUESTION</h3>
                <p style="font-size: 1.15em; font-family: 'Special Elite', monospace; color: var(--blue);">Who fired the first shot at the Battle of Lexington?</p>
            </div>

            <div class="question-group">
                <h4>üîç Final Case Analysis</h4>
                <div class="q-item">
                    <label><span class="q-num">1</span> Based on all the evidence you've examined (both images and both documents), what is your verdict? Who do you believe fired the first shot ‚Äî and why?</label>
                    <textarea id="verdict-q1" placeholder="State your verdict clearly, then explain your reasoning. Which sources were most persuasive to you and why?" style="min-height: 120px;"></textarea>
                </div>
                <div class="q-item">
                    <label><span class="q-num">2</span> What specific evidence from the documents and images supports your conclusion? List at least two pieces of evidence.</label>
                    <textarea id="verdict-q2" placeholder="Evidence 1: ...&#10;Evidence 2: ...&#10;Evidence 3 (optional): ..."></textarea>
                </div>
                <div class="q-item">
                    <label><span class="q-num">3</span> What evidence works against your verdict ‚Äî and how do you explain it away or account for it?</label>
                    <textarea id="verdict-q3" placeholder="A good detective addresses evidence that complicates their theory, not just evidence that supports it..."></textarea>
                </div>
                <div class="q-item">
                    <label><span class="q-num">4</span> Can we ever know for certain who fired first? Why or why not? What types of additional evidence would help resolve this question?</label>
                    <textarea id="verdict-q4" placeholder="Think about what other sources might exist ‚Äî and why the question may never be fully resolved..."></textarea>
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-secondary" onclick="goToPhase(3)">‚Üê Back</button>
            <button class="btn btn-primary" onclick="submitVerdict()">Submit Verdict &amp; See What Historians Say ‚Üí</button>
        </div>
    </div>

    <!-- ======= PHASE 5: REVEAL ======= -->
    <div class="panel" id="phase5">
        <div class="card">
            <div class="card-label">Case Closed ‚Äî Historical Perspective</div>
            <h2>What Do Historians Say?</h2>

            <div style="text-align: center; padding: 10px 0 20px;">
                <div class="verdict-stamp">CASE REVIEWED</div>
            </div>

            <div class="reveal-card">
                <h3>The Historical Consensus</h3>
                <p>Historians have studied the Battle of Lexington for over 250 years ‚Äî and the question of who fired first remains genuinely unresolved. Here is what scholars generally conclude:</p>
                <ul style="margin-left: 20px; margin-top: 14px; line-height: 2;">
                    <li><strong>The "shot heard round the world"</strong> may have come from a bystander, a nervous soldier, or even a random accident ‚Äî rather than a deliberate order on either side.</li>
                    <li><strong>Most evidence suggests the British fired the main volley</strong> ‚Äî but the source of the very first shot remains disputed.</li>
                    <li><strong>Both sides had reasons to claim the other fired first</strong> ‚Äî the British to justify their use of force, the colonists to present themselves as victims of aggression.</li>
                    <li><strong>The colonists were vastly outnumbered</strong>. With 200‚Äì300 militiamen facing British regulars, most historians consider it unlikely the colonists would have fired first deliberately.</li>
                    <li><strong>However:</strong> Barker's note that his own men "could hear no orders" and were "wild" suggests the British volley may itself have been unordered.</li>
                </ul>
            </div>

            <div class="reveal-card" style="background: var(--ink); margin-top: 20px;">
                <h3>About the Documents</h3>
                <p><strong style="color: var(--gold);">John Barker</strong> ‚Äî A British officer, present at Lexington. His diary was a private record but one he likely knew might someday be read. He had reason to protect himself and his troops from accountability for killing colonial civilians. His claim that his men fired "without orders" may shift blame from leadership ‚Äî but also may simply be true of a chaotic dawn engagement.</p>
                <br>
                <p><strong style="color: var(--gold);">The 34 Colonists</strong> ‚Äî All were present. Their testimony was sworn before justices of the peace just six days after the battle. The coordination raises questions ‚Äî did they agree on a story beforehand? But sworn testimony was a serious legal act, and 34 witnesses agreeing on the basic facts carries weight. The phrase <em>"to our knowledge"</em> is notably careful ‚Äî they are not claiming certainty, only what they observed.</p>
            </div>

            <div class="card" style="margin-top: 24px;">
                <div class="card-label">Reflection</div>
                <div class="question-group">
                    <h4>üïµÔ∏è After the Reveal</h4>
                    <div class="q-item">
                        <label><span class="q-num">1</span> How does your verdict compare to what historians say? What did you get right? What would you add or change?</label>
                        <textarea id="reflect-q1" placeholder="Reflect on your reasoning process..."></textarea>
                    </div>
                    <div class="q-item">
                        <label><span class="q-num">2</span> Why do historians have such difficulty answering "who fired first" ‚Äî even with multiple eyewitness accounts? What does this tell us about history?</label>
                        <textarea id="reflect-q2" placeholder="Think about bias, memory, chaos, and the nature of historical evidence..."></textarea>
                    </div>
                    <div class="q-item">
                        <label><span class="q-num">3</span> Even if we cannot answer who fired first, what CAN historians confidently say about the Battle of Lexington based on these sources?</label>
                        <textarea id="reflect-q3" placeholder="Look for what all the sources agree on ‚Äî participants, location, outcome..."></textarea>
                    </div>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" onclick="downloadPDF()">üìÑ Download PDF</button>
                <button class="btn btn-success" onclick="submitToSupabase()" id="submitBtn">üì§ Submit to Prof. Hauselmann</button>
                <button class="btn btn-secondary" onclick="goToPhase(4)">‚Üê Back to Verdict</button>
            </div>
            <div id="submitMessage"></div>
        </div>
    </div>

</div><!-- end page-wrap -->

<script>
    // ===== CONFIG =====
    const SUPABASE_URL = 'https://bqrluqymscucvbiaaeai.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcmx1cXltc2N1Y3ZiaWFhZWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njg4MTMsImV4cCI6MjA4NDI0NDgxM30.AVOjnQe_TDoWydE2wDP1_YftU1lBkYxcPuyQeZb8Nfs';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ASSIGNMENT_OPEN = true; // Set false to close
    const SUBMISSION_CUTOFF = null; // e.g. '2026-03-20T23:59:59'

    let currentPhase = 0;
    let verdictSubmitted = false;

    // ===== NAVIGATION =====
    function goToPhase(n) {
        document.getElementById(`phase${currentPhase}`).classList.remove('active');
        document.getElementById(`phase${n}`).classList.add('active');
        currentPhase = n;
        updateProgress();
        if (n === 1) restoreImageStep();
        window.scrollTo(0, 0);
    }

    function updateProgress() {
        document.querySelectorAll('.prog-step').forEach((el, i) => {
            el.classList.remove('active', 'done');
            if (i < currentPhase) el.classList.add('done');
            else if (i === currentPhase) el.classList.add('active');
        });
    }

    // ===== IMAGE STEP NAVIGATION =====
    function revealImage2() {
        const q1 = document.getElementById('img1-q1').value.trim();
        const q2 = document.getElementById('img1-q2').value.trim();
        if (!q1 || !q2) {
            alert('Please answer both questions about Image 1 before continuing.');
            return;
        }
        document.getElementById('img-step-1').style.display = 'none';
        document.getElementById('img-step-2').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function backToImage1() {
        document.getElementById('img-step-2').style.display = 'none';
        document.getElementById('img-step-1').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function revealComparison() {
        const q1 = document.getElementById('img2-q1').value.trim();
        const q2 = document.getElementById('img2-q2').value.trim();
        if (!q1 || !q2) {
            alert('Please answer both questions about Image 2 before continuing.');
            return;
        }
        document.getElementById('img-step-2').style.display = 'none';
        document.getElementById('img-step-3').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function backToImage2() {
        document.getElementById('img-step-3').style.display = 'none';
        document.getElementById('img-step-2').style.display = 'block';
        window.scrollTo(0, 0);
    }

    // When navigating back to phase 1 from phase 2, restore correct sub-step
    function restoreImageStep() {
        const hasComparison = document.getElementById('img2-q3').value.trim();
        const hasImg2 = document.getElementById('img2-q1').value.trim();
        document.getElementById('img-step-1').style.display = 'none';
        document.getElementById('img-step-2').style.display = 'none';
        document.getElementById('img-step-3').style.display = 'none';
        if (hasComparison) {
            document.getElementById('img-step-3').style.display = 'block';
        } else if (hasImg2) {
            document.getElementById('img-step-2').style.display = 'block';
        } else {
            document.getElementById('img-step-1').style.display = 'block';
        }
    }

    function startCase() {
        const name = document.getElementById('student-name').value.trim();
        if (!name) { alert('Please enter your name before continuing.'); document.getElementById('student-name').focus(); return; }
        if (!document.getElementById('warmup-q1').value.trim() || !document.getElementById('warmup-q2').value.trim()) {
            alert('Please complete both warm-up questions before continuing.');
            return;
        }
        goToPhase(1);
    }

    const phaseFields = {
        1: ['img1-q1','img1-q2','img2-q1','img2-q2','img2-q3','img2-q4','img-eval','img-artist-eval'],
        2: ['docA-q1','docA-q2','docA-q3','docA-q4','docA-q5','docA-q6','docA-q7'],
        3: ['docB-q1','docB-q2','docB-q3','docB-q4','docB-q5','docB-q6','docB-q7'],
        4: ['verdict-q1','verdict-q2','verdict-q3','verdict-q4'],
    };

    function goToPhaseValidated(from, to) {
        const fields = phaseFields[from] || [];
        for (const id of fields) {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                alert('Please complete all questions before continuing.');
                el.focus();
                return;
            }
        }
        goToPhase(to);
    }

    function submitVerdict() {
        const fields = phaseFields[4];
        for (const id of fields) {
            if (!document.getElementById(id).value.trim()) {
                alert('Please complete all verdict questions before continuing.');
                document.getElementById(id).focus();
                return;
            }
        }
        verdictSubmitted = true;
        goToPhase(5);
    }

    // ===== PDF GENERATION =====
    function buildPDFDoc() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;
        const lh = 7, ph = doc.internal.pageSize.height, m = 20;
        const name = document.getElementById('student-name').value.trim();
        const section = document.getElementById('section-number').value.trim();

        function addText(text, size = 11, bold = false) {
            doc.setFontSize(size);
            doc.setFont(undefined, bold ? 'bold' : 'normal');
            const lines = doc.splitTextToSize(String(text || '[Not answered]'), 170);
            lines.forEach(l => { if (y > ph - m) { doc.addPage(); y = 20; } doc.text(l, 20, y); y += lh; });
            y += 3;
        }

        addText('The Lexington Case', 18, true); y += 3;
        addText('HIST 101 ¬∑ Who Fired the First Shot?', 13);
        addText(`Student: ${name}`, 12, true);
        if (section) addText(`Section: ${section}`, 12, true);
        addText(`Completed: ${new Date().toLocaleString()}`, 10); y += 4;

        addText('WARM-UP', 13, true);
        addText('1. What do you know about the Battle of Lexington?', 11, true);
        addText(document.getElementById('warmup-q1').value);
        addText('2. Who do you predict fired first?', 11, true);
        addText(document.getElementById('warmup-q2').value); y += 4;

        addText('IMAGE EVIDENCE', 13, true);
        [['img1-q1','Image 1 ‚Äì What do you see?'],['img1-q2','Image 1 ‚Äì What evidence does it provide?'],
         ['img2-q1','Image 2 ‚Äì What do you see?'],['img2-q2','Image 2 ‚Äì What evidence does it provide?'],
         ['img2-q3','How are the images similar?'],['img2-q4','How are the images different?'],
         ['img-eval','Which image is more trustworthy (before artist reveal)?'],
         ['img-artist-eval','Does knowing the artists change your evaluation?']
        ].forEach(([id, q]) => { addText(q, 11, true); addText(document.getElementById(id).value); });
        y += 4;

        addText('DOCUMENT A ‚Äî Barker', 13, true);
        [['docA-q1','1. Who was John Barker?'],['docA-q2','2. What kind of document?'],
         ['docA-q3','3. When written?'],['docA-q4','4. Prediction?'],
         ['docA-q5','5. What happened at Lexington according to Barker?'],
         ['docA-q6','6. Who fired first according to Barker?'],
         ['docA-q7','7. Is this document trustworthy?']
        ].forEach(([id, q]) => { addText(q, 11, true); addText(document.getElementById(id).value); });
        y += 4;

        addText('DOCUMENT B ‚Äî Colonists', 13, true);
        [['docB-q1','1. Who were the authors?'],['docB-q2','2. What kind of document?'],
         ['docB-q3','3. When written?'],['docB-q4','4. Prediction?'],
         ['docB-q5','5. What do A and B have in common?'],
         ['docB-q6','6. What is different between A and B?'],
         ['docB-q7','7. Is this document trustworthy?']
        ].forEach(([id, q]) => { addText(q, 11, true); addText(document.getElementById(id).value); });
        y += 4;

        addText('VERDICT', 13, true);
        [['verdict-q1','1. Your verdict: who fired first?'],
         ['verdict-q2','2. What evidence supports your verdict?'],
         ['verdict-q3','3. What evidence works against your verdict?'],
         ['verdict-q4','4. Can we ever know for certain?']
        ].forEach(([id, q]) => { addText(q, 11, true); addText(document.getElementById(id).value); });
        y += 4;

        addText('REFLECTIONS', 13, true);
        [['reflect-q1','1. How does your verdict compare to historians?'],
         ['reflect-q2','2. Why is "who fired first" so hard to answer?'],
         ['reflect-q3','3. What CAN we confidently say about the battle?']
        ].forEach(([id, q]) => { addText(q, 11, true); addText(document.getElementById(id).value); });

        return doc;
    }

    function downloadPDF() {
        if (!verdictSubmitted) { alert('Please submit your verdict first.'); return; }
        const name = document.getElementById('student-name').value.trim();
        if (!name) { alert('Please enter your name in the Briefing section.'); return; }
        try {
            const doc = buildPDFDoc();
            doc.save(`Lexington_Case_${name.replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        } catch(e) { console.error(e); alert('Error generating PDF: ' + e.message); }
    }

    async function submitToSupabase() {
        if (!ASSIGNMENT_OPEN) {
            document.getElementById('submitMessage').innerHTML = '<div class="error-msg">‚ùå This assignment is now closed. Please contact Prof. Hauselmann.</div>';
            return;
        }
        if (SUBMISSION_CUTOFF && new Date() > new Date(SUBMISSION_CUTOFF)) {
            document.getElementById('submitMessage').innerHTML = '<div class="error-msg">‚ùå Submission deadline has passed. Contact Prof. Hauselmann.</div>';
            return;
        }
        const name = document.getElementById('student-name').value.trim();
        const section = document.getElementById('section-number').value.trim();
        if (!name) { alert('Please enter your name.'); return; }
        if (!section) { alert('Please enter your section number.'); return; }
        if (!verdictSubmitted) { alert('Please submit your verdict first.'); return; }

        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('submitMessage');
        btn.disabled = true; btn.textContent = '‚è≥ Submitting...';
        msg.innerHTML = '<div style="padding:14px;color:var(--faded);font-style:italic;">Generating and uploading your worksheet...</div>';

        try {
            const doc = buildPDFDoc();
            const blob = doc.output('blob');
            const ts = new Date().toISOString().replace(/[:.]/g,'-');
            const safeName = name.replace(/[^a-zA-Z0-9]/g,'_');
            const filePath = `lexington-case/${section}/${safeName}_${ts}.pdf`;

            const { error: upErr } = await supabaseClient.storage.from('student-submissions').upload(filePath, blob, { contentType: 'application/pdf', upsert: false });
            if (upErr) throw new Error(upErr.message);

            const { data: urlData } = supabaseClient.storage.from('student-submissions').getPublicUrl(filePath);

            const allData = {};
            document.querySelectorAll('input[type=text], textarea').forEach(el => { if (el.id) allData[el.id] = el.value; });

            await supabaseClient.from('worksheet_submissions').insert({
                student_name: name, section_number: section,
                worksheet_type: 'lexington-case',
                file_path: filePath, file_url: urlData.publicUrl,
                form_data: allData, submitted_at: new Date().toISOString()
            });

            msg.innerHTML = '<div class="success-msg">‚úÖ Successfully submitted to Prof. Hauselmann.</div>';
            btn.textContent = '‚úì Submitted';
        } catch(e) {
            console.error(e);
            msg.innerHTML = `<div class="error-msg">‚ùå Submission failed: ${e.message}. Download the PDF and email it as a backup.</div>`;
            btn.disabled = false; btn.textContent = 'üì§ Submit to Prof. Hauselmann';
        }
    }

    // ===== BLOCK PASTE =====
    document.addEventListener('paste', function(e) {
        const target = e.target;
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
            e.preventDefault();
            target.style.outline = '2px solid var(--red)';
            setTimeout(() => target.style.outline = '', 800);
        }
    });

    // ===== AUTO-SAVE =====
    function collectState() {
        const state = {};
        document.querySelectorAll('input[type=text], textarea').forEach(el => { if(el.id) state[el.id] = el.value; });
        return state;
    }

    setInterval(() => { localStorage.setItem('lexingtonCase', JSON.stringify(collectState())); }, 30000);

    window.onload = () => {
        const saved = localStorage.getItem('lexingtonCase');
        if (saved) {
            try {
                const restore = confirm('Restore your previous session?');
                if (restore) {
                    const state = JSON.parse(saved);
                    Object.entries(state).forEach(([id, val]) => {
                        const el = document.getElementById(id);
                        if (el) el.value = val;
                    });
                }
            } catch(e) {}
        }
        updateProgress();
    };
</script>
</body>
</html>
