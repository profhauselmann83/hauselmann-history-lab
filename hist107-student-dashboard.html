<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <title>HIST 107 Class Dashboard | Student View</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f5f5f0;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        nav {
            background-color: #34495e;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }

        nav a:hover {
            text-decoration: underline;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .stat-card.success {
            border-left-color: #27ae60;
        }

        .stat-card.warning {
            border-left-color: #f39c12;
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: 700;
            color: #2c3e50;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #ecf0f1;
        }

        .tab.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.production {
            background: #d4edda;
            color: #155724;
        }

        .badge.labor {
            background: #fff3cd;
            color: #856404;
        }

        .badge.empire {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge.circulation {
            background: #f8d7da;
            color: #721c24;
        }

        .source-card {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
            border-radius: 3px;
        }

        .source-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .source-card p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .source-card .meta {
            font-size: 0.85em;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 10px;
        }

        .filters {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters label {
            font-weight: 600;
            color: #2c3e50;
            margin-right: 8px;
        }

        .filters select {
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-family: 'Open Sans', sans-serif;
        }

        .info-box {
            background-color: #e8f4f8;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
            border-radius: 3px;
        }

        .info-box strong {
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: #7f8c8d;
            padding: 20px 0;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“š HIST 107 Class Dashboard</h1>
            <p>Group Project: Shared Commodity, Divided Lenses</p>
        </header>

        <nav>
            <a href="index.html">Home</a>
            <a href="activities.html">Interactive Activities</a>
            <a href="research.html">Research Tools</a>
            <a href="research-hist107.html">HIST 107 Research Guide</a>
            <a href="blog.html">Blog</a>
            <a href="https://profhauselmann.org/bss-ai-types.html">AI & Learning</a>
        </nav>

        <div class="info-box">
            <strong>ðŸ‘‹ Welcome to the Class Dashboard!</strong>
            <p>This is your space to see what other students are researching, coordinate with your group, and get inspired by the sources others have found. All submissions are visible to help facilitate collaboration and prevent duplicate work.</p>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Students</h3>
                <div class="number" id="stat-students">--</div>
            </div>
            <div class="stat-card success">
                <h3>Commodities Being Studied</h3>
                <div class="number" id="stat-commodities">--</div>
            </div>
            <div class="stat-card warning">
                <h3>Sources in Class Archive</h3>
                <div class="number" id="stat-sources">--</div>
            </div>
            <div class="stat-card">
                <h3>Groups Formed</h3>
                <div class="number" id="stat-groups">--</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('roles')">ðŸŽ¯ Role Selections</div>
            <div class="tab" onclick="switchTab('archive')">ðŸ“š Class Archive</div>
            <div class="tab" onclick="switchTab('progress')">ðŸ“Š Class Progress</div>
        </div>

        <!-- Tab Content: Role Selections -->
        <div id="tab-roles" class="tab-content active">
            <div class="card">
                <h2>Role Selections & Group Coordination</h2>
                <div class="info-box">
                    <strong>ðŸ’¡ Use this to coordinate with your group:</strong> Make sure no two people in your group have the same analytical lens. Check which commodities are being studied and who's working on what.
                </div>
                <div class="filters">
                    <label>Section:</label>
                    <select id="filter-section-roles" onchange="loadRoles()">
                        <option value="">All Sections</option>
                    </select>
                    <label>Commodity:</label>
                    <select id="filter-commodity-roles" onchange="loadRoles()">
                        <option value="">All Commodities</option>
                    </select>
                </div>
                <div id="roles-content" class="loading">Loading role selections...</div>
            </div>
        </div>

        <!-- Tab Content: Class Archive -->
        <div id="tab-archive" class="tab-content">
            <div class="card">
                <h2>Class-Wide Source Archive</h2>
                <div class="info-box">
                    <strong>ðŸ“– Browse sources from across the class:</strong> See what primary and secondary sources other students have found. Use this for inspiration, to avoid duplication, and to understand different approaches to similar commodities.
                </div>
                <div class="filters">
                    <label>Commodity:</label>
                    <select id="filter-commodity-archive" onchange="loadArchive()">
                        <option value="">All Commodities</option>
                    </select>
                    <label>Analytical Lens:</label>
                    <select id="filter-lens-archive" onchange="loadArchive()">
                        <option value="">All Lenses</option>
                        <option value="Production & Environment">Production & Environment</option>
                        <option value="Labor & Coercion">Labor & Coercion</option>
                        <option value="Empire, State & Corporations">Empire, State & Corporations</option>
                        <option value="Circulation & Consumption">Circulation & Consumption</option>
                    </select>
                </div>
                <div id="archive-content" class="loading">Loading class archive...</div>
            </div>
        </div>

        <!-- Tab Content: Class Progress -->
        <div id="tab-progress" class="tab-content">
            <div class="card">
                <h2>Class Progress Overview</h2>
                <div class="info-box">
                    <strong>ðŸ“ˆ See how the class is progressing:</strong> This shows who has selected roles and started adding sources. Use this to check in on your group members' progress.
                </div>
                <div class="filters">
                    <label>Section:</label>
                    <select id="filter-section-progress" onchange="loadProgress()">
                        <option value="">All Sections</option>
                    </select>
                    <label>Commodity:</label>
                    <select id="filter-commodity-progress" onchange="loadProgress()">
                        <option value="">All Commodities</option>
                    </select>
                </div>
                <div id="progress-content" class="loading">Loading progress data...</div>
            </div>
        </div>
    </div>

    <footer>
        <p>Prof. Hauselmann | profhauselmann.org</p>
    </footer>

    <script>
        const SUPABASE_URL = 'https://bqrluqymscucvbiaaeai.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcmx1cXltc2N1Y3ZiaWFhZWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njg4MTMsImV4cCI6MjA4NDI0NDgxM30.AVOjnQe_TDoWydE2wDP1_YftU1lBkYxcPuyQeZb8Nfs'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        async function init() {
            await loadStats()
            await populateFilters()
            await loadRoles()
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'))
            event.target.classList.add('active')

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'))
            document.getElementById('tab-' + tabName).classList.add('active')

            // Load data for the tab
            switch(tabName) {
                case 'roles':
                    loadRoles()
                    break
                case 'archive':
                    loadArchive()
                    break
                case 'progress':
                    loadProgress()
                    break
            }
        }

        async function loadStats() {
            try {
                // Total students from role selections
                const { data: roles } = await supabaseClient
                    .from('hist107_role_selection')
                    .select('student_name, commodity_name')

                const uniqueStudents = new Set(roles?.map(r => r.student_name) || [])
                document.getElementById('stat-students').textContent = uniqueStudents.size

                // Unique commodities
                const uniqueCommodities = new Set(roles?.map(r => r.commodity_name).filter(Boolean) || [])
                document.getElementById('stat-commodities').textContent = uniqueCommodities.size

                // Total sources in class archive
                const { data: sources } = await supabaseClient
                    .from('hist107_class_archive')
                    .select('id')

                document.getElementById('stat-sources').textContent = sources?.length || 0

                // Approximate groups (students / 3.5 average)
                const approxGroups = Math.round(uniqueStudents.size / 3.5)
                document.getElementById('stat-groups').textContent = approxGroups || '--'

            } catch (error) {
                console.error('Error loading stats:', error)
            }
        }

        async function populateFilters() {
            try {
                // Get unique sections and commodities
                const { data: roles } = await supabaseClient
                    .from('hist107_role_selection')
                    .select('section_number, commodity_name')

                const sections = [...new Set(roles?.map(r => r.section_number).filter(Boolean))]
                sections.sort()

                const commodities = [...new Set(roles?.map(r => r.commodity_name).filter(Boolean))]
                commodities.sort()

                // Populate section filters
                const sectionSelects = [
                    'filter-section-roles',
                    'filter-section-progress'
                ]

                sectionSelects.forEach(selectId => {
                    const select = document.getElementById(selectId)
                    sections.forEach(section => {
                        const option = document.createElement('option')
                        option.value = section
                        option.textContent = section
                        select.appendChild(option)
                    })
                })

                // Populate commodity filters
                const commoditySelects = [
                    'filter-commodity-roles',
                    'filter-commodity-archive',
                    'filter-commodity-progress'
                ]

                commoditySelects.forEach(selectId => {
                    const select = document.getElementById(selectId)
                    commodities.forEach(commodity => {
                        const option = document.createElement('option')
                        option.value = commodity
                        option.textContent = commodity
                        select.appendChild(option)
                    })
                })

            } catch (error) {
                console.error('Error populating filters:', error)
            }
        }

        async function loadRoles() {
            const content = document.getElementById('roles-content')
            content.innerHTML = '<div class="loading">Loading...</div>'

            try {
                const section = document.getElementById('filter-section-roles').value
                const commodity = document.getElementById('filter-commodity-roles').value

                let query = supabaseClient
                    .from('hist107_role_selection')
                    .select('*')
                    .order('commodity_name')
                    .order('student_name')

                if (section) query = query.eq('section_number', section)
                if (commodity) query = query.eq('commodity_name', commodity)

                const { data, error } = await query

                if (error) throw error

                if (!data || data.length === 0) {
                    content.innerHTML = '<div class="empty-state"><h3>No role selections yet</h3><p>Be the first to select your role and commodity!</p></div>'
                    return
                }

                // Group by commodity
                const byCommodity = {}
                data.forEach(role => {
                    const comm = role.commodity_name || 'Unspecified'
                    if (!byCommodity[comm]) byCommodity[comm] = []
                    byCommodity[comm].push(role)
                })

                let html = ''

                for (const [comm, roles] of Object.entries(byCommodity)) {
                    html += `<h3 style="color: #2c3e50; margin-top: 30px;">${comm} (${roles.length} students)</h3>`
                    html += '<table><thead><tr><th>Student</th><th>Section</th><th>Analytical Lens</th><th>Group Members</th></tr></thead><tbody>'

                    roles.forEach(role => {
                        const lensClass = getLensClass(role.role_name)
                        html += `
                            <tr>
                                <td><strong>${role.student_name}</strong></td>
                                <td>${role.section_number}</td>
                                <td><span class="badge ${lensClass}">${role.role_name || 'Not selected'}</span></td>
                                <td>${role.group_members ? role.group_members.split('\n').join(', ') : 'Not listed'}</td>
                            </tr>
                        `
                    })

                    html += '</tbody></table>'
                }

                content.innerHTML = html

            } catch (error) {
                console.error('Error loading roles:', error)
                console.error('Error details:', error.message, error.details, error.hint)
                content.innerHTML = `<div class="empty-state"><h3>Error loading data</h3><p>${error.message || 'Please try again later.'}</p></div>`
            }
        }

        async function loadArchive() {
            const content = document.getElementById('archive-content')
            content.innerHTML = '<div class="loading">Loading...</div>'

            try {
                const commodity = document.getElementById('filter-commodity-archive').value
                const lens = document.getElementById('filter-lens-archive').value

                let query = supabaseClient
                    .from('hist107_class_archive')
                    .select('*')
                    .order('submitted_at', { ascending: false })

                if (commodity) query = query.eq('commodity', commodity)
                if (lens) query = query.eq('analytical_lens', lens)

                const { data, error } = await query

                if (error) throw error

                if (!data || data.length === 0) {
                    content.innerHTML = '<div class="empty-state"><h3>No sources in archive yet</h3><p>Be the first to add sources to the class archive!</p></div>'
                    return
                }

                // Group by commodity
                const byCommodity = {}
                data.forEach(source => {
                    const comm = source.commodity || 'Unspecified'
                    if (!byCommodity[comm]) byCommodity[comm] = []
                    byCommodity[comm].push(source)
                })

                let html = `<div style="background-color: #d4edda; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #27ae60;">
                    <strong>Total sources in archive: ${data.length}</strong>
                </div>`

                for (const [comm, sources] of Object.entries(byCommodity)) {
                    html += `<h3 style="color: #2c3e50; margin-top: 30px;">${comm} (${sources.length} sources)</h3>`

                    sources.forEach((source, idx) => {
                        html += `
                            <div class="source-card">
                                <h4>${source.analytical_lens} | Source ${idx + 1}</h4>
                                <p><strong>Citation:</strong> ${source.citation}</p>
                                <p><strong>Type:</strong> ${source.source_type || 'Not specified'}</p>
                                <p><strong>Producer:</strong> ${source.producer || 'Not specified'}</p>
                                <p><strong>What it reveals:</strong> ${source.historical_question || 'Not specified'}</p>
                                <p><strong>Limitations:</strong> ${source.limitations || 'Not specified'}</p>
                                ${source.url ? `<p><strong>URL:</strong> <a href="${source.url}" target="_blank">${source.url}</a></p>` : ''}
                                <p class="meta">Contributed by ${source.student_name} (${source.section_number}) on ${new Date(source.submitted_at).toLocaleDateString()}</p>
                            </div>
                        `
                    })
                }

                content.innerHTML = html

            } catch (error) {
                console.error('Error loading archive:', error)
                console.error('Error details:', error.message, error.details, error.hint)
                content.innerHTML = `<div class="empty-state"><h3>Error loading data</h3><p>${error.message || 'Please try again later.'}</p></div>`
            }
        }

        async function loadProgress() {
            const content = document.getElementById('progress-content')
            content.innerHTML = '<div class="loading">Loading...</div>'

            try {
                const section = document.getElementById('filter-section-progress').value
                const commodity = document.getElementById('filter-commodity-progress').value

                let query = supabaseClient
                    .from('hist107_role_selection')
                    .select('*')
                    .order('student_name')

                if (section) query = query.eq('section_number', section)
                if (commodity) query = query.eq('commodity_name', commodity)

                const { data: roles, error } = await query

                if (error) throw error

                if (!roles || roles.length === 0) {
                    content.innerHTML = '<div class="empty-state"><h3>No students found</h3></div>'
                    return
                }

                // Get mini-archive data
                const { data: archives } = await supabaseClient
                    .from('hist107_mini_archive')
                    .select('student_name, sources')

                const archiveMap = new Map()
                archives?.forEach(a => {
                    archiveMap.set(a.student_name, a.sources?.length || 0)
                })

                let html = '<table><thead><tr><th>Student</th><th>Section</th><th>Commodity</th><th>Lens</th><th>Sources Added</th></tr></thead><tbody>'

                roles.forEach(role => {
                    const sourcesCount = archiveMap.get(role.student_name) || 0
                    const lensClass = getLensClass(role.role_name)

                    html += `
                        <tr>
                            <td><strong>${role.student_name}</strong></td>
                            <td>${role.section_number}</td>
                            <td>${role.commodity_name || 'Not selected'}</td>
                            <td><span class="badge ${lensClass}">${role.role_name || 'Not selected'}</span></td>
                            <td><strong>${sourcesCount}</strong> / 3-4</td>
                        </tr>
                    `
                })

                html += '</tbody></table>'
                content.innerHTML = html

            } catch (error) {
                console.error('Error loading progress:', error)
                console.error('Error details:', error.message, error.details, error.hint)
                content.innerHTML = `<div class="empty-state"><h3>Error loading data</h3><p>${error.message || 'Please try again later.'}</p></div>`
            }
        }

        function getLensClass(roleName) {
            if (!roleName) return ''
            if (roleName.includes('Production')) return 'production'
            if (roleName.includes('Labor')) return 'labor'
            if (roleName.includes('Empire')) return 'empire'
            if (roleName.includes('Circulation')) return 'circulation'
            return ''
        }

        init()
    </script>
</body>
</html>
